<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2017-12-24 Sun 21:15 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Intro to DB</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Lei Zhao" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<link type="text/css" href="../styles/syntax-highlight.css" rel="stylesheet"/>
<link type="text/css" href="../styles/layout.css" rel="stylesheet"/>
<script type="text/javascript" src="../src/post.js"></script>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2017 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        displayAlign: "center",
        displayIndent: "0em",

        "HTML-CSS": { scale: 100,
                        linebreaks: { automatic: "false" },
                        webFont: "TeX"
                       },
        SVG: {scale: 100,
              linebreaks: { automatic: "false" },
              font: "TeX"},
        NativeMML: {scale: 100},
        TeX: { equationNumbers: {autoNumber: "AMS"},
               MultLineWidth: "85%",
               TagSide: "right",
               TagIndent: ".8em"
             }
});
</script>
<script type="text/javascript"
        src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_HTML"></script>
</head>
<body>
<div id="content">
<h1 class="title">Intro to DB</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orgfd2f58f">1. <span class="done DONE">DONE</span> SQL mini-course</a>
<ul>
<li><a href="#orgd8f0530">1.1. <span class="done DONE">DONE</span> Lecture videos</a>
<ul>
<li><a href="#org42d5f69">1.1.1. <span class="done DONE">DONE</span> The Join family of Operators</a></li>
<li><a href="#org58bfd7c">1.1.2. <span class="done DONE">DONE</span> Aggregation</a></li>
<li><a href="#org5dd8c9d">1.1.3. <span class="done DONE">DONE</span> NULL values</a></li>
<li><a href="#org64b824c">1.1.4. <span class="done DONE">DONE</span> Data Modification Statements</a></li>
</ul>
</li>
<li><a href="#org0b876f5">1.2. <span class="done DONE">DONE</span> Exercises</a>
<ul>
<li><a href="#org492c735">1.2.1. <span class="done DONE">DONE</span> Movie-Rating Query Core</a></li>
<li><a href="#org0a9bb92">1.2.2. <span class="done DONE">DONE</span> Movie-Rating Query Extras</a></li>
<li><a href="#org9762b6b">1.2.3. <span class="done DONE">DONE</span> Social-Network Query Core</a></li>
<li><a href="#org437dfab">1.2.4. <span class="done DONE">DONE</span> Social-Network Query Extras</a></li>
<li><a href="#orgd046bbe">1.2.5. <span class="done DONE">DONE</span> Movie-Rating Modification</a></li>
<li><a href="#org6753299">1.2.6. <span class="done DONE">DONE</span> Social-Network Modification</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#orgb382ec8">2. <span class="done DONE">DONE</span> XPath and XQuery mini-course</a>
<ul>
<li><a href="#orgcee6e23">2.1. <span class="done DONE">DONE</span> Lecture videos</a>
<ul>
<li><a href="#orga1aef34">2.1.1. <span class="done DONE">DONE</span> XPath Introduction</a></li>
<li><a href="#org2fb9b89">2.1.2. <span class="done DONE">DONE</span> XPath Demo</a></li>
<li><a href="#org0b555f3">2.1.3. <span class="done DONE">DONE</span> XQuery Introduction</a></li>
<li><a href="#org40fe4b7">2.1.4. <span class="done DONE">DONE</span> XQuery Demo</a></li>
</ul>
</li>
<li><a href="#org7516b91">2.2. <span class="done DONE">DONE</span> Exercises</a>
<ul>
<li><a href="#orgf3708e2">2.2.1. <span class="done DONE">DONE</span> Course-Catalog XPath and XQuery Exercises</a></li>
<li><a href="#org97ee342">2.2.2. <span class="done DONE">DONE</span> Course-Catalog XPath and XQuery Exercises Extras</a></li>
<li><a href="#org352102f">2.2.3. <span class="done DONE">DONE</span> World-Countries XPath and XQuery Exercises</a></li>
<li><a href="#org8c8cc24">2.2.4. <span class="done DONE">DONE</span> World-Countries XPath and XQuery Exercises Extras</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org7d42edd">3. <span class="done DONE">DONE</span> XSLT mini-course</a>
<ul>
<li><a href="#orgfe254ab">3.1. <span class="done DONE">DONE</span> Lecture videos</a></li>
<li><a href="#org4cde76c">3.2. <span class="done DONE">DONE</span> Exercises</a>
<ul>
<li><a href="#org25a75fe">3.2.1. <span class="done DONE">DONE</span> Course-Catalog XSLT</a></li>
<li><a href="#org1be131f">3.2.2. <span class="done DONE">DONE</span> Course-Catalog XSLT Extras</a></li>
<li><a href="#org780b9bd">3.2.3. <span class="done DONE">DONE</span> World-Countries XSLT</a></li>
<li><a href="#orgebe2682">3.2.4. <span class="done DONE">DONE</span> World-Countries XSLT Extras</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org622db22">4. <span class="done DONE">DONE</span> Relational Design Theory mini-course</a>
<ul>
<li><a href="#org5d0317d">4.1. <span class="done DONE">DONE</span> Lecture videos</a>
<ul>
<li><a href="#orge6a4fac">4.1.1. <span class="done DONE">DONE</span> Overview</a></li>
<li><a href="#orga2368fd">4.1.2. <span class="done DONE">DONE</span> Functional Dependencies</a></li>
<li><a href="#org06acf8c">4.1.3. <span class="done DONE">DONE</span> Boyce-Codd Normal Form</a></li>
<li><a href="#org4169027">4.1.4. <span class="done DONE">DONE</span> Multivalued Dependencies and 4th Normal Form</a></li>
<li><a href="#org78a54f0">4.1.5. <span class="done DONE">DONE</span> Shortcomings of BCNF/4NF</a></li>
</ul>
</li>
<li><a href="#orga7779c2">4.2. <span class="done DONE">DONE</span> Exercises</a></li>
</ul>
</li>
<li><a href="#orgccfc649">5. <span class="done DONE">DONE</span> Unified Modeling Language mini-course</a>
<ul>
<li><a href="#orge5ff558">5.1. <span class="done DONE">DONE</span> Lecture Videos</a>
<ul>
<li><a href="#orgf45479a">5.1.1. <span class="done DONE">DONE</span> UML Data Modeling</a></li>
<li><a href="#org53b0a5c">5.1.2. <span class="done DONE">DONE</span> UML to Relations</a></li>
</ul>
</li>
<li><a href="#orgc883a97">5.2. <span class="done DONE">DONE</span> Exercises</a></li>
</ul>
</li>
<li><a href="#orga9a75d5">6. <span class="done DONE">DONE</span> Indexes and Transactions mini-course</a>
<ul>
<li><a href="#orgd8737a6">6.1. <span class="done DONE">DONE</span> Lecture Videos</a>
<ul>
<li><a href="#org54d8103">6.1.1. <span class="done DONE">DONE</span> Indexes</a></li>
<li><a href="#orgddc7a7a">6.1.2. <span class="done DONE">DONE</span> Introduction to Transactions</a></li>
<li><a href="#orgc7211a9">6.1.3. <span class="done DONE">DONE</span> Transaction Properties</a></li>
<li><a href="#org3dc65fc">6.1.4. <span class="done DONE">DONE</span> Isolation Levels</a></li>
</ul>
</li>
<li><a href="#orgaeb9f3c">6.2. <span class="done DONE">DONE</span> Exercises</a>
<ul>
<li><a href="#org54081d1">6.2.1. <span class="done DONE">DONE</span> Index Quiz</a></li>
<li><a href="#orgc446251">6.2.2. <span class="done DONE">DONE</span> Transaction Quiz</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#orgcaf5b6f">7. <span class="done DONE">DONE</span> Constraints and Triggers mini-course</a>
<ul>
<li><a href="#org033ce25">7.1. <span class="done DONE">DONE</span> Lecture Videos</a>
<ul>
<li><a href="#org8880985">7.1.1. <span class="done DONE">DONE</span> Motivation and Overview</a></li>
<li><a href="#orgd71a2fb">7.1.2. <span class="done DONE">DONE</span> Constraints of Several Types</a></li>
<li><a href="#orgab1d028">7.1.3. <span class="done DONE">DONE</span> Referential Integrity</a></li>
<li><a href="#org5bdb333">7.1.4. <span class="done DONE">DONE</span> Triggers Introduction</a></li>
<li><a href="#orgabf08b4">7.1.5. <span class="done DONE">DONE</span> Triggers Demo</a></li>
</ul>
</li>
<li><a href="#org6d894d3">7.2. <span class="done DONE">DONE</span> Exercises</a>
<ul>
<li><a href="#orgd8f1633">7.2.1. <span class="done DONE">DONE</span> Constraints and Triggers</a></li>
<li><a href="#org2e0422b">7.2.2. <span class="done DONE">DONE</span> SQL Social-Network Triggers</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<p>
<a href="https://lagunita.stanford.edu/courses/DB/2014/SelfPaced/about">Database</a> on Lagunita<br />
</p>

<div id="outline-container-orgfd2f58f" class="outline-2">
<h2 id="orgfd2f58f"><span class="section-number-2">1</span> <span class="done DONE">DONE</span> <a href="https://lagunita.stanford.edu/courses/DB/SQL/SelfPaced/courseware/ch-sql/">SQL</a> mini-course</h2>
<div class="outline-text-2" id="text-1">
</div>
<div id="outline-container-orgd8f0530" class="outline-3">
<h3 id="orgd8f0530"><span class="section-number-3">1.1</span> <span class="done DONE">DONE</span> Lecture videos</h3>
<div class="outline-text-3" id="text-1-1">
</div>
<div id="outline-container-org42d5f69" class="outline-4">
<h4 id="org42d5f69"><span class="section-number-4">1.1.1</span> <span class="done DONE">DONE</span> The Join family of Operators</h4>
<div class="outline-text-4" id="text-1-1-1">
</div>
</div>
<div id="outline-container-org58bfd7c" class="outline-4">
<h4 id="org58bfd7c"><span class="section-number-4">1.1.2</span> <span class="done DONE">DONE</span> Aggregation</h4>
<div class="outline-text-4" id="text-1-1-2">
<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">select</span> <span class="org-builtin">avg</span>(GPA)
<span class="org-keyword">from</span> Student;

<span class="org-keyword">select</span> <span class="org-builtin">min</span>(GPA)
<span class="org-keyword">from</span> Student, Apply
<span class="org-keyword">where</span> Student.sID = Apply.sID <span class="org-keyword">and</span> major = <span class="org-string">'CS'</span>;

<span class="org-keyword">select</span> <span class="org-builtin">avg</span>(GPA)
<span class="org-keyword">from</span> Student
<span class="org-keyword">where</span> sID <span class="org-keyword">in</span> (<span class="org-keyword">select</span> sID <span class="org-keyword">from</span> Apply <span class="org-keyword">where</span> major = <span class="org-string">'CS'</span>);

<span class="org-keyword">select</span> <span class="org-builtin">count</span>(*)
<span class="org-keyword">from</span> College
<span class="org-keyword">where</span> enrollment &gt; 15000;

<span class="org-keyword">select</span> <span class="org-builtin">count</span>(*)
<span class="org-keyword">from</span> (<span class="org-keyword">select</span> <span class="org-keyword">distinct</span> sID <span class="org-keyword">from</span> Apply <span class="org-keyword">where</span> cName = <span class="org-string">'Cornell'</span>);

<span class="org-keyword">select</span> <span class="org-builtin">count</span>(<span class="org-keyword">distinct</span> sID)
<span class="org-keyword">from</span> Apply
<span class="org-keyword">where</span> cName = <span class="org-string">'Cornell'</span>;

<span class="org-keyword">select</span> (<span class="org-keyword">select</span> <span class="org-builtin">avg</span>(GPA) <span class="org-keyword">from</span> Student
        <span class="org-keyword">where</span> sID <span class="org-keyword">in</span> (<span class="org-keyword">select</span> sID <span class="org-keyword">from</span> Apply <span class="org-keyword">where</span> major = <span class="org-string">'CS'</span>)) -
       (<span class="org-keyword">select</span> <span class="org-builtin">avg</span>(GPA) <span class="org-keyword">from</span> Student
        <span class="org-keyword">where</span> sID <span class="org-keyword">not</span> <span class="org-keyword">in</span> (<span class="org-keyword">select</span> sID <span class="org-keyword">from</span> Apply <span class="org-keyword">where</span> major = <span class="org-string">'CS'</span>));

<span class="org-keyword">select</span> cName, <span class="org-builtin">count</span>(*)
<span class="org-keyword">from</span> Apply
<span class="org-keyword">group</span> <span class="org-keyword">by</span> cName;

<span class="org-keyword">select</span> <span class="org-keyword">state</span>, <span class="org-builtin">sum</span>(enrollment)
<span class="org-keyword">from</span> College
<span class="org-keyword">group</span> <span class="org-keyword">by</span> <span class="org-keyword">state</span>;

<span class="org-keyword">select</span> cName, major, <span class="org-builtin">max</span>(mx - mn)
<span class="org-keyword">from</span> (<span class="org-keyword">select</span> cName, major, <span class="org-builtin">min</span>(GPA) <span class="org-keyword">as</span> mn, <span class="org-builtin">max</span>(GPA) <span class="org-keyword">as</span> mx
      <span class="org-keyword">from</span> Student <span class="org-keyword">join</span> Apply <span class="org-keyword">using</span>(sID)
      <span class="org-keyword">group</span> <span class="org-keyword">by</span> cName, major) <span class="org-keyword">M</span>;

<span class="org-keyword">select</span> sID, sName, <span class="org-builtin">count</span>(<span class="org-keyword">distinct</span> cName)
<span class="org-keyword">from</span> Student <span class="org-keyword">join</span> Apply <span class="org-keyword">using</span>(sID)
<span class="org-keyword">group</span> <span class="org-keyword">by</span> sID;

<span class="org-keyword">select</span> sID, sName, <span class="org-builtin">count</span>(cName)
<span class="org-keyword">from</span> Student <span class="org-keyword">join</span>
     (<span class="org-keyword">select</span> <span class="org-keyword">distinct</span> sID, cName
      <span class="org-keyword">from</span> Apply) <span class="org-keyword">using</span>(sID)
<span class="org-keyword">group</span> <span class="org-keyword">by</span> sID;

<span class="org-keyword">select</span> sID, sName, <span class="org-builtin">count</span>(<span class="org-keyword">distinct</span> cName)
<span class="org-keyword">from</span> Student <span class="org-keyword">left</span> <span class="org-keyword">join</span> Apply <span class="org-keyword">using</span>(sID)
<span class="org-keyword">group</span> <span class="org-keyword">by</span> sID;

<span class="org-keyword">select</span> sID, sName, <span class="org-builtin">count</span>(<span class="org-keyword">distinct</span> cName)
<span class="org-keyword">from</span> Student <span class="org-keyword">join</span> Apply <span class="org-keyword">using</span>(sID)
<span class="org-keyword">group</span> <span class="org-keyword">by</span> sID
<span class="org-keyword">union</span>
<span class="org-keyword">select</span> sID, sName, 0
<span class="org-keyword">from</span> Student
<span class="org-keyword">where</span> sID <span class="org-keyword">not</span> <span class="org-keyword">in</span> (<span class="org-keyword">select</span> sID <span class="org-keyword">from</span> Apply);

<span class="org-keyword">select</span> cName
<span class="org-keyword">from</span> Apply
<span class="org-keyword">group</span> <span class="org-keyword">by</span> cName
<span class="org-keyword">having</span> <span class="org-builtin">count</span>(*) &lt; 5;

<span class="org-keyword">select</span> cName
<span class="org-keyword">from</span> (<span class="org-keyword">select</span> <span class="org-keyword">distinct</span> cName <span class="org-keyword">from</span> Apply) S
<span class="org-keyword">where</span> (<span class="org-keyword">select</span> <span class="org-builtin">count</span>(*) <span class="org-keyword">from</span> Apply <span class="org-keyword">where</span> cName = S.cName) &lt; 5;


<span class="org-keyword">select</span> cName
<span class="org-keyword">from</span> Apply
<span class="org-keyword">group</span> <span class="org-keyword">by</span> cName
<span class="org-keyword">having</span> <span class="org-builtin">count</span>(<span class="org-keyword">distinct</span> sID) &lt; 5;

<span class="org-keyword">select</span> major
<span class="org-keyword">from</span> Student <span class="org-keyword">join</span> Apply <span class="org-keyword">using</span>(sID)
<span class="org-keyword">group</span> <span class="org-keyword">by</span> major
<span class="org-keyword">having</span> <span class="org-builtin">max</span>(GPA) &lt; (<span class="org-keyword">select</span> <span class="org-builtin">avg</span>(GPA) <span class="org-keyword">from</span> Student);
</pre>
</div>
</div>
</div>

<div id="outline-container-org5dd8c9d" class="outline-4">
<h4 id="org5dd8c9d"><span class="section-number-4">1.1.3</span> <span class="done DONE">DONE</span> NULL values</h4>
<div class="outline-text-4" id="text-1-1-3">
<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">select</span> sID, sName, GPA
<span class="org-keyword">from</span> Student
<span class="org-keyword">where</span> GPA &lt;= 3.5 <span class="org-keyword">or</span> GPA &gt; 3.5 <span class="org-keyword">or</span> GPA <span class="org-keyword">is</span> <span class="org-keyword">null</span>;

<span class="org-keyword">select</span> sID, sName, GPA, sizeHS
<span class="org-keyword">from</span> Student
<span class="org-keyword">where</span> GPA &lt;= 3.5 <span class="org-keyword">or</span> sizeHS &lt; 1600 <span class="org-keyword">or</span> sizeHS &gt;= 1600;

<span class="org-keyword">select</span> <span class="org-builtin">count</span>(*)
<span class="org-keyword">from</span> Student
<span class="org-keyword">where</span> GPA <span class="org-keyword">is</span> <span class="org-keyword">not</span> <span class="org-keyword">null</span>;
</pre>
</div>
<p>
SQL uses three-valued logic (<a href="https://en.wikipedia.org/wiki/Three-valued_logic">3VL</a>).<br />
</p>
</div>
</div>

<div id="outline-container-org64b824c" class="outline-4">
<h4 id="org64b824c"><span class="section-number-4">1.1.4</span> <span class="done DONE">DONE</span> Data Modification Statements</h4>
<div class="outline-text-4" id="text-1-1-4">
<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">insert</span> <span class="org-keyword">into</span> College
<span class="org-keyword">values</span> (<span class="org-string">'Carnegie Mellon'</span>, <span class="org-string">'PA'</span>, 11500);

<span class="org-keyword">insert</span> <span class="org-keyword">into</span> Apply
<span class="org-keyword">select</span> sID, <span class="org-string">'Carnegie Mellon'</span>, <span class="org-string">'CS'</span>, <span class="org-keyword">null</span>
<span class="org-keyword">from</span> Student
<span class="org-keyword">where</span> sID <span class="org-keyword">not</span> <span class="org-keyword">in</span> (<span class="org-keyword">select</span> sID <span class="org-keyword">from</span> Apply);

<span class="org-keyword">insert</span> <span class="org-keyword">into</span> Apply
<span class="org-keyword">select</span> <span class="org-keyword">distinct</span> sID, <span class="org-string">'Carnegie Mellon'</span>, <span class="org-string">'EE'</span>, <span class="org-string">'Y'</span>
<span class="org-keyword">from</span> Apply
<span class="org-keyword">where</span> cName &lt;&gt; <span class="org-string">'Carnegie Mellon'</span> <span class="org-keyword">and</span>
      major = <span class="org-string">'EE'</span> <span class="org-keyword">and</span>
      decision = <span class="org-string">'N'</span>;

<span class="org-keyword">delete</span> <span class="org-keyword">from</span> Student
<span class="org-keyword">where</span> sID <span class="org-keyword">in</span> (<span class="org-keyword">select</span> sID
              <span class="org-keyword">from</span> Apply
              <span class="org-keyword">group</span> <span class="org-keyword">by</span> sID
              <span class="org-keyword">having</span> <span class="org-builtin">count</span>(<span class="org-keyword">distinct</span> major) &gt; 2);

<span class="org-keyword">delete</span> <span class="org-keyword">from</span> Apply
<span class="org-keyword">where</span> sID <span class="org-keyword">in</span> (<span class="org-keyword">select</span> sID
              <span class="org-keyword">from</span> Apply
              <span class="org-keyword">group</span> <span class="org-keyword">by</span> sID
              <span class="org-keyword">having</span> <span class="org-builtin">count</span>(<span class="org-keyword">distinct</span> major) &gt; 2);

<span class="org-keyword">delete</span> <span class="org-keyword">from</span> College
<span class="org-keyword">where</span> cName <span class="org-keyword">not</span> <span class="org-keyword">in</span> (<span class="org-keyword">select</span> cName
                    <span class="org-keyword">from</span> Apply
                    <span class="org-keyword">where</span> major = <span class="org-string">'CS'</span>);

<span class="org-keyword">update</span> Apply
<span class="org-keyword">set</span> major = <span class="org-string">'economics'</span>,
    decision = <span class="org-string">'Y'</span>
<span class="org-keyword">where</span> cName = <span class="org-string">'Carnegie Mellon'</span> <span class="org-keyword">and</span>
      sID <span class="org-keyword">in</span> (<span class="org-keyword">select</span> sID <span class="org-keyword">from</span> Student <span class="org-keyword">where</span> GPA &lt; 3.6);

<span class="org-keyword">update</span> Apply
<span class="org-keyword">set</span> major = <span class="org-string">'CSE'</span>
<span class="org-keyword">where</span> major = <span class="org-string">'EE'</span> <span class="org-keyword">and</span>
      sID <span class="org-keyword">in</span> (<span class="org-keyword">select</span> sID
              <span class="org-keyword">from</span> Student
              <span class="org-keyword">where</span> GPA = (<span class="org-keyword">select</span> <span class="org-builtin">max</span>(GPA)
                           <span class="org-keyword">from</span> Apply <span class="org-keyword">join</span> Student <span class="org-keyword">using</span>(sID)
                           <span class="org-keyword">where</span> major = <span class="org-string">'EE'</span>));

<span class="org-keyword">select</span> * <span class="org-keyword">from</span> Apply
<span class="org-keyword">where</span> major = <span class="org-string">'EE'</span> <span class="org-keyword">and</span>
      sID <span class="org-keyword">in</span> (<span class="org-keyword">select</span> sID
              <span class="org-keyword">from</span> Student
              <span class="org-keyword">where</span> GPA &gt;= <span class="org-keyword">all</span> (<span class="org-keyword">select</span> GPA
                                <span class="org-keyword">from</span> Student <span class="org-keyword">join</span> Apply <span class="org-keyword">using</span>(sID)
                                <span class="org-keyword">where</span> major = <span class="org-string">'EE'</span>));

<span class="org-keyword">update</span> Student
<span class="org-keyword">set</span> GPA = (<span class="org-keyword">select</span> <span class="org-builtin">max</span>(GPA) <span class="org-keyword">from</span> Student),
    sizeHS = (<span class="org-keyword">select</span> <span class="org-builtin">min</span>(sizeHS) <span class="org-keyword">from</span> Student);

<span class="org-keyword">update</span> Apply
<span class="org-keyword">set</span> decision = <span class="org-string">'Y'</span>;
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org0b876f5" class="outline-3">
<h3 id="org0b876f5"><span class="section-number-3">1.2</span> <span class="done DONE">DONE</span> Exercises</h3>
<div class="outline-text-3" id="text-1-2">
</div>
<div id="outline-container-org492c735" class="outline-4">
<h4 id="org492c735"><span class="section-number-4">1.2.1</span> <span class="done DONE">DONE</span> Movie-Rating Query <a href="https://lagunita.stanford.edu/courses/DB/SQL/SelfPaced/courseware/ch-sql/seq-exercise-sql_movie_query_core/">Core</a></h4>
<div class="outline-text-4" id="text-1-2-1">
<p>
Find the titles of all movies directed by Steven Spielberg.<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">select</span> title
<span class="org-keyword">from</span> Movie
<span class="org-keyword">where</span> director = <span class="org-string">'Steven Spielberg'</span>;
</pre>
</div>

<p>
Find all years that have a movie that received a rating of 4 or 5, and<br />
sort them in increasing order.<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">select</span> <span class="org-keyword">year</span>
<span class="org-keyword">from</span> Movie
<span class="org-keyword">where</span> mID <span class="org-keyword">in</span> (<span class="org-keyword">select</span> mID
              <span class="org-keyword">from</span> Rating
              <span class="org-keyword">where</span> stars &gt;= 4)
<span class="org-keyword">order</span> <span class="org-keyword">by</span> <span class="org-keyword">year</span>;
</pre>
</div>

<p>
Find the titles of all movies that have no ratings.<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">select</span> title
<span class="org-keyword">from</span> Movie
<span class="org-keyword">where</span> mID <span class="org-keyword">not</span> <span class="org-keyword">in</span> (<span class="org-keyword">select</span> mID <span class="org-keyword">from</span> Rating);
</pre>
</div>

<p>
Some reviewers didn't provide a date with their rating.  Find the<br />
names of all reviewers who have ratings with a NULL value for the<br />
date.<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">select</span> <span class="org-keyword">name</span>
<span class="org-keyword">from</span> Reviewer
<span class="org-keyword">where</span> rID <span class="org-keyword">in</span> (<span class="org-keyword">select</span> rID <span class="org-keyword">from</span> Rating
              <span class="org-keyword">where</span> ratingDate <span class="org-keyword">is</span> <span class="org-keyword">null</span>);
</pre>
</div>

<p>
Write a query to return the ratings data in a more readable format:<br />
reviewer name, movie title, stars, and ratingDate.  Also, sort the<br />
data, first by reviewer name, then by movie title, and lastly by<br />
number of stars.<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">select</span> <span class="org-keyword">name</span>, title, stars, ratingDate
<span class="org-keyword">from</span> Reviewer <span class="org-keyword">join</span> Rating <span class="org-keyword">using</span>(rID) <span class="org-keyword">join</span> Movie <span class="org-keyword">using</span>(mID)
<span class="org-keyword">order</span> <span class="org-keyword">by</span> <span class="org-keyword">name</span>, title, stars;
</pre>
</div>

<p>
For all cases where the same reviewer rated the same movie twice and<br />
gave it a higher rating the second time, return the reviewer's name<br />
and the title of the movie.<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">select</span> <span class="org-keyword">name</span>, title
<span class="org-keyword">from</span> (<span class="org-keyword">select</span> rID, mID
      <span class="org-keyword">from</span> Rating R1 <span class="org-keyword">join</span> Rating R2 <span class="org-keyword">using</span>(rID, mID)
      <span class="org-keyword">where</span> R1.stars &gt; R2.stars <span class="org-keyword">and</span>
            R1.ratingDate &gt; R2.ratingDate <span class="org-keyword">and</span>
            (<span class="org-keyword">select</span> <span class="org-builtin">count</span>(*) <span class="org-keyword">from</span> Rating
             <span class="org-keyword">where</span> rID = R1.rID <span class="org-keyword">and</span> mID = R1.mID) = 2)
      <span class="org-keyword">join</span> Reviewer <span class="org-keyword">using</span>(rID)
      <span class="org-keyword">join</span> Movie <span class="org-keyword">using</span>(mID);
</pre>
</div>

<p>
For each movie that has at least one rating, find the highest number<br />
of stars that movie received.  Return the movie title and number of<br />
stars.  Sort by movie title.<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">select</span> title, <span class="org-builtin">max</span>(stars)
<span class="org-keyword">from</span> Rating <span class="org-keyword">join</span> Movie <span class="org-keyword">using</span>(mID)
<span class="org-keyword">group</span> <span class="org-keyword">by</span> mID
<span class="org-keyword">order</span> <span class="org-keyword">by</span> title;
</pre>
</div>

<p>
For each movie, return the title and the 'rating spread', that is, the<br />
difference between highest and lowest ratings given to that movie.<br />
Sort by rating spread from highest to lowest, then by movie title.<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">select</span> title, spread
<span class="org-keyword">from</span> (<span class="org-keyword">select</span> mID, <span class="org-builtin">max</span>(stars) - <span class="org-builtin">min</span>(stars) <span class="org-keyword">as</span> spread
      <span class="org-keyword">from</span> Rating
      <span class="org-keyword">group</span> <span class="org-keyword">by</span> mID)
      <span class="org-keyword">join</span> Movie <span class="org-keyword">using</span>(mID)
<span class="org-keyword">order</span> <span class="org-keyword">by</span> spread <span class="org-keyword">desc</span>, title;
</pre>
</div>

<p>
Find the difference between the average rating of movies released<br />
before 1980 and the average rating of movies released after 1980.<br />
(Make sure to calculate the average rating for each movie, then the<br />
average of those averages for movies before 1980 and movies after.<br />
Don't just calculate the overall average rating before and after<br />
1980.)<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">select</span>
(<span class="org-keyword">select</span> <span class="org-builtin">avg</span>(avgStars)
 <span class="org-keyword">from</span> (<span class="org-keyword">select</span> mID, <span class="org-builtin">avg</span>(stars) <span class="org-keyword">as</span> avgStars
       <span class="org-keyword">from</span> Rating
       <span class="org-keyword">group</span> <span class="org-keyword">by</span> mID) <span class="org-keyword">join</span> Movie <span class="org-keyword">using</span>(mID)
 <span class="org-keyword">where</span> <span class="org-keyword">year</span> &lt; 1980) -
(<span class="org-keyword">select</span> <span class="org-builtin">avg</span>(avgStars)
 <span class="org-keyword">from</span> (<span class="org-keyword">select</span> mID, <span class="org-builtin">avg</span>(stars) <span class="org-keyword">as</span> avgStars
       <span class="org-keyword">from</span> Rating
       <span class="org-keyword">group</span> <span class="org-keyword">by</span> mID) <span class="org-keyword">join</span> Movie <span class="org-keyword">using</span>(mID)
 <span class="org-keyword">where</span> <span class="org-keyword">year</span> &gt;= 1980);
</pre>
</div>
</div>
</div>
<div id="outline-container-org0a9bb92" class="outline-4">
<h4 id="org0a9bb92"><span class="section-number-4">1.2.2</span> <span class="done DONE">DONE</span> Movie-Rating Query <a href="https://lagunita.stanford.edu/courses/DB/SQL/SelfPaced/courseware/ch-sql/seq-exercise-sql_movie_query_extra/">Extras</a></h4>
<div class="outline-text-4" id="text-1-2-2">
<p>
Find the names of all reviewers who rated Gone with the Wind.<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">select</span> <span class="org-keyword">name</span>
<span class="org-keyword">from</span> Reviewer
<span class="org-keyword">where</span> rID <span class="org-keyword">in</span> (<span class="org-keyword">select</span> rID <span class="org-keyword">from</span> Rating
              <span class="org-keyword">where</span> mID = (<span class="org-keyword">select</span> mID <span class="org-keyword">from</span> Movie
                           <span class="org-keyword">where</span> title = <span class="org-string">'Gone with the Wind'</span>));
</pre>
</div>

<p>
For any rating where the reviewer is the same as the director of the<br />
movie, return the reviewer name, movie title, and number of stars.<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">select</span> <span class="org-keyword">distinct</span> <span class="org-keyword">name</span>, title, stars
<span class="org-keyword">from</span> Rating <span class="org-keyword">join</span> Reviewer <span class="org-keyword">using</span>(rID) <span class="org-keyword">join</span> Movie <span class="org-keyword">using</span>(mID)
<span class="org-keyword">where</span> director = <span class="org-keyword">name</span>;
</pre>
</div>

<p>
Return all reviewer names and movie names together in a single list,<br />
alphabetized.  (Sorting by the first name of the reviewer and first<br />
word in the title is fine; no need for special processing on last<br />
names or removing "The".)<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">select</span> <span class="org-keyword">name</span>
<span class="org-keyword">from</span> (<span class="org-keyword">select</span> <span class="org-keyword">name</span>
      <span class="org-keyword">from</span> Reviewer
      <span class="org-keyword">union</span>
      <span class="org-keyword">select</span> title <span class="org-keyword">as</span> <span class="org-keyword">name</span>
      <span class="org-keyword">from</span> Movie)
<span class="org-keyword">order</span> <span class="org-keyword">by</span> <span class="org-keyword">name</span>;
</pre>
</div>

<p>
Find the titles of all movies not reviewed by Chris Jackson.<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">select</span> title
<span class="org-keyword">from</span> Movie
<span class="org-keyword">where</span> mID <span class="org-keyword">not</span> <span class="org-keyword">in</span> (<span class="org-keyword">select</span> mID <span class="org-keyword">from</span> Rating
                  <span class="org-keyword">where</span> rID <span class="org-keyword">in</span> (<span class="org-keyword">select</span> rID <span class="org-keyword">from</span> Reviewer
                                <span class="org-keyword">where</span> <span class="org-keyword">name</span> = <span class="org-string">'Chris Jackson'</span>));
</pre>
</div>

<p>
For all pairs of reviewers such that both reviewers gave a rating to<br />
the same movie, return the names of both reviewers.  Eliminate<br />
duplicates, don't pair reviewers with themselves, and include each<br />
pair only once.  For each pair, return the names in the pair in<br />
alphabetical order.<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">select</span> <span class="org-keyword">distinct</span> R1.<span class="org-keyword">name</span>, R2.<span class="org-keyword">name</span>
<span class="org-keyword">from</span> (Rating <span class="org-keyword">join</span> Reviewer <span class="org-keyword">using</span>(rID)) R1 <span class="org-keyword">join</span>
     (Rating <span class="org-keyword">join</span> Reviewer <span class="org-keyword">using</span>(rID)) R2
<span class="org-keyword">on</span> R1.mID = R2.mID <span class="org-keyword">and</span>
   R1.rID &lt;&gt; R2.rID <span class="org-keyword">and</span>
   R1.<span class="org-keyword">name</span> &lt;= R2.<span class="org-keyword">name</span>;
</pre>
</div>

<p>
For each rating that is the lowest (fewest stars) currently in the<br />
database, return the reviewer name, movie title, and number of stars.<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">select</span> <span class="org-keyword">name</span>, title, stars
<span class="org-keyword">from</span> Rating R1 <span class="org-keyword">join</span> Reviewer R2 <span class="org-keyword">join</span> Movie <span class="org-keyword">M</span>
<span class="org-keyword">on</span> R1.rID = R2.rID <span class="org-keyword">and</span>
   R1.mID = <span class="org-keyword">m</span>.mID <span class="org-keyword">and</span>
   stars = (<span class="org-keyword">select</span> <span class="org-builtin">min</span>(stars) <span class="org-keyword">from</span> Rating);
</pre>
</div>

<p>
List movie titles and average ratings, from highest-rated to<br />
lowest-rated.  If two or more movies have the same average rating,<br />
list them in alphabetical order.<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">select</span> title, avgStars
<span class="org-keyword">from</span> (<span class="org-keyword">select</span> mID, <span class="org-builtin">avg</span>(stars) <span class="org-keyword">as</span> avgStars
      <span class="org-keyword">from</span> Rating
      <span class="org-keyword">group</span> <span class="org-keyword">by</span> mID) <span class="org-keyword">join</span> Movie <span class="org-keyword">using</span>(mID)
<span class="org-keyword">order</span> <span class="org-keyword">by</span> avgStars <span class="org-keyword">desc</span>, title;
</pre>
</div>

<p>
Find the names of all reviewers who have contributed three or more<br />
ratings.  (As an extra challenge, try writing the query without HAVING<br />
or without COUNT.)<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">select</span> <span class="org-keyword">name</span>
<span class="org-keyword">from</span> Reviewer
<span class="org-keyword">where</span> rID <span class="org-keyword">in</span> (<span class="org-keyword">select</span> rID
              <span class="org-keyword">from</span> Rating
              <span class="org-keyword">group</span> <span class="org-keyword">by</span> rID
              <span class="org-keyword">having</span> <span class="org-builtin">count</span>(*) &gt;= 3);

<span class="org-keyword">select</span> <span class="org-keyword">name</span>
<span class="org-keyword">from</span> (<span class="org-keyword">select</span> rID
      <span class="org-keyword">from</span> Rating
      <span class="org-keyword">group</span> <span class="org-keyword">by</span> rID
      <span class="org-keyword">having</span> <span class="org-builtin">count</span>(*) &gt;= 3)
     <span class="org-keyword">join</span> Reviewer <span class="org-keyword">using</span>(rID);

<span class="org-keyword">select</span> <span class="org-keyword">name</span>
<span class="org-keyword">from</span> Rating <span class="org-keyword">join</span> Reviewer <span class="org-keyword">using</span>(rID)
<span class="org-keyword">group</span> <span class="org-keyword">by</span> rID
<span class="org-keyword">having</span> <span class="org-builtin">count</span>(*) &gt;= 3;

<span class="org-keyword">select</span> <span class="org-keyword">name</span>
<span class="org-keyword">from</span> Reviewer
<span class="org-keyword">where</span> rID <span class="org-keyword">in</span> (<span class="org-keyword">select</span> rID
              <span class="org-keyword">from</span> Rating R
              <span class="org-keyword">where</span> rID <span class="org-keyword">in</span> (<span class="org-keyword">select</span> rID
                            <span class="org-keyword">from</span> Rating S
                            <span class="org-keyword">where</span> rID = R.rID <span class="org-keyword">and</span>
                                  (mID &lt;&gt; R.mID <span class="org-keyword">or</span>
                                   stars &lt;&gt; R.stars) <span class="org-keyword">and</span>
                                  rID <span class="org-keyword">in</span> (<span class="org-keyword">select</span> rID
                                          <span class="org-keyword">from</span> Rating
                                          <span class="org-keyword">where</span> rID = R.rID <span class="org-keyword">and</span>
                                                (mID &lt;&gt; R.mID <span class="org-keyword">or</span>
                                                 stars &lt;&gt; R.stars) <span class="org-keyword">and</span>
                                                (mID &lt;&gt; S.mID <span class="org-keyword">or</span>
                                                 stars &lt;&gt; S.stars))));
</pre>
</div>

<p>
Some directors directed more than one movie.  For all such directors,<br />
return the titles of all movies directed by them, along with the<br />
director name.  Sort by director name, then movie title.  (As an extra<br />
challenge, try writing the query both with and without COUNT.)<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">select</span> title, director
<span class="org-keyword">from</span> Movie
<span class="org-keyword">where</span> director <span class="org-keyword">in</span> (<span class="org-keyword">select</span> director
                   <span class="org-keyword">from</span> Movie
                   <span class="org-keyword">group</span> <span class="org-keyword">by</span> director
                   <span class="org-keyword">having</span> <span class="org-builtin">count</span>(*) &gt; 1)
<span class="org-keyword">order</span> <span class="org-keyword">by</span> director, title;

<span class="org-keyword">select</span> title, director
<span class="org-keyword">from</span> Movie R
<span class="org-keyword">where</span> director <span class="org-keyword">in</span> (<span class="org-keyword">select</span> director
                   <span class="org-keyword">from</span> Movie
                   <span class="org-keyword">where</span> director = R.director <span class="org-keyword">and</span>
                         mID &lt;&gt; R.mID)
<span class="org-keyword">order</span> <span class="org-keyword">by</span> director, title;
</pre>
</div>

<p>
Find the movie(s) with the highest average rating. Return the movie<br />
title(s) and average rating.  (Hint: This query is more difficult to<br />
write in SQLite than other systems; you might think of it as finding<br />
the highest average rating and then choosing the movie(s) with that<br />
average rating.)<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">select</span> title, (<span class="org-keyword">select</span> <span class="org-builtin">avg</span>(stars) <span class="org-keyword">from</span> Rating <span class="org-keyword">where</span> mID = R.mID) <span class="org-keyword">as</span> avgStars
<span class="org-keyword">from</span> Movie R
<span class="org-keyword">where</span> avgStars = (<span class="org-keyword">select</span> <span class="org-builtin">max</span>((<span class="org-keyword">select</span> <span class="org-builtin">avg</span>(stars) <span class="org-keyword">from</span> Rating <span class="org-keyword">where</span> mID = S.mID))
                  <span class="org-keyword">from</span> Movie S);
</pre>
</div>

<p>
Find the movie(s) with the lowest average rating.  Return the movie<br />
title(s) and average rating.  (Hint: This query may be more difficult<br />
to write in SQLite than other systems; you might think of it as<br />
finding the lowest average rating and then choosing the movie(s) with<br />
that average rating.)<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">select</span> title, (<span class="org-keyword">select</span> <span class="org-builtin">avg</span>(stars) <span class="org-keyword">from</span> Rating <span class="org-keyword">where</span> mID = R.mID) <span class="org-keyword">as</span> avgStars
<span class="org-keyword">from</span> Movie R
<span class="org-keyword">where</span> avgStars = (<span class="org-keyword">select</span> <span class="org-builtin">min</span>((<span class="org-keyword">select</span> <span class="org-builtin">avg</span>(stars) <span class="org-keyword">from</span> Rating <span class="org-keyword">where</span> mID = S.mID))
                  <span class="org-keyword">from</span> Movie S);
</pre>
</div>

<p>
For each director, return the director's name together with the<br />
title(s) of the movie(s) they directed that received the highest<br />
rating among all of their movies, and the value of that rating.<br />
Ignore movies whose director is NULL.<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">select</span> <span class="org-keyword">distinct</span> director, title, maxStars
<span class="org-keyword">from</span> (<span class="org-keyword">select</span> director,
             (<span class="org-keyword">select</span> <span class="org-builtin">max</span>(stars)
              <span class="org-keyword">from</span> Rating <span class="org-keyword">join</span> Movie <span class="org-keyword">using</span>(mID)
              <span class="org-keyword">where</span> director = D.director) <span class="org-keyword">as</span> maxStars
      <span class="org-keyword">from</span> (<span class="org-keyword">select</span> <span class="org-keyword">distinct</span> director <span class="org-keyword">from</span> Movie
            <span class="org-keyword">where</span> director <span class="org-keyword">is</span> <span class="org-keyword">not</span> <span class="org-keyword">null</span>) D)
      <span class="org-keyword">join</span> Movie <span class="org-keyword">using</span>(director) <span class="org-keyword">join</span> Rating <span class="org-keyword">using</span>(mID)
<span class="org-keyword">where</span> stars = maxStars;
</pre>
</div>
</div>
</div>

<div id="outline-container-org9762b6b" class="outline-4">
<h4 id="org9762b6b"><span class="section-number-4">1.2.3</span> <span class="done DONE">DONE</span> Social-Network Query <a href="https://lagunita.stanford.edu/courses/DB/SQL/SelfPaced/courseware/ch-sql/seq-exercise-sql_social_query_core/">Core</a></h4>
<div class="outline-text-4" id="text-1-2-3">
<p>
Find the names of all students who are friends with someone named<br />
Gabriel.<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">select</span> <span class="org-keyword">name</span>
<span class="org-keyword">from</span> Highschooler
<span class="org-keyword">where</span> ID <span class="org-keyword">in</span> (<span class="org-keyword">select</span> ID1
             <span class="org-keyword">from</span> Friend
             <span class="org-keyword">where</span> ID1 = ID <span class="org-keyword">and</span>
                   ID2 <span class="org-keyword">in</span> (<span class="org-keyword">select</span> ID
                           <span class="org-keyword">from</span> Highschooler
                           <span class="org-keyword">where</span> <span class="org-keyword">name</span> = <span class="org-string">'Gabriel'</span>));
</pre>
</div>

<p>
For every student who likes someone 2 or more grades younger than<br />
themselves, return that student's name and grade, and the name and<br />
grade of the student they like.<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">select</span> (<span class="org-keyword">select</span> <span class="org-keyword">name</span> <span class="org-keyword">from</span> Highschooler <span class="org-keyword">where</span> ID = ID1),
       (<span class="org-keyword">select</span> grade <span class="org-keyword">from</span> Highschooler <span class="org-keyword">where</span> ID = ID1),
       (<span class="org-keyword">select</span> <span class="org-keyword">name</span> <span class="org-keyword">from</span> Highschooler <span class="org-keyword">where</span> ID = ID2),
       (<span class="org-keyword">select</span> grade <span class="org-keyword">from</span> Highschooler <span class="org-keyword">where</span> ID = ID2)
<span class="org-keyword">from</span> Likes
<span class="org-keyword">where</span> (<span class="org-keyword">select</span> grade <span class="org-keyword">from</span> Highschooler <span class="org-keyword">where</span> ID = ID1) -
      (<span class="org-keyword">select</span> grade <span class="org-keyword">from</span> Highschooler <span class="org-keyword">where</span> ID = ID2) &gt;= 2;
</pre>
</div>

<p>
For every pair of students who both like each other, return the name<br />
and grade of both students.  Include each pair only once, with the two<br />
names in alphabetical order.<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">select</span> *
<span class="org-keyword">from</span> Likes
<span class="org-keyword">where</span> ID1 &lt; ID2
<span class="org-keyword">intersect</span>
<span class="org-keyword">select</span> ID2, ID1
<span class="org-keyword">from</span> Likes;

<span class="org-keyword">select</span> (<span class="org-keyword">select</span> <span class="org-keyword">name</span> <span class="org-keyword">from</span> Highschooler <span class="org-keyword">where</span> ID = R.ID1),
       (<span class="org-keyword">select</span> grade <span class="org-keyword">from</span> Highschooler <span class="org-keyword">where</span> ID = R.ID1),
       (<span class="org-keyword">select</span> <span class="org-keyword">name</span> <span class="org-keyword">from</span> Highschooler <span class="org-keyword">where</span> ID = R.ID2),
       (<span class="org-keyword">select</span> grade <span class="org-keyword">from</span> Highschooler <span class="org-keyword">where</span> ID = R.ID2)
<span class="org-keyword">from</span> Likes R
<span class="org-keyword">where</span> (<span class="org-keyword">select</span> <span class="org-keyword">name</span> <span class="org-keyword">from</span> Highschooler <span class="org-keyword">where</span> ID = R.ID1) &lt;
      (<span class="org-keyword">select</span> <span class="org-keyword">name</span> <span class="org-keyword">from</span> Highschooler <span class="org-keyword">where</span> ID = R.ID2) <span class="org-keyword">and</span>
      ID2 <span class="org-keyword">in</span> (<span class="org-keyword">select</span> ID1 <span class="org-keyword">from</span> Likes
              <span class="org-keyword">where</span> ID1 = R.ID2 <span class="org-keyword">and</span> ID2 = R.ID1);
</pre>
</div>

<p>
Find all students who do not appear in the Likes table (as a student<br />
who likes or is liked) and return their names and grades.  Sort by<br />
grade, then by name within each grade.<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">select</span> <span class="org-keyword">name</span>, grade
<span class="org-keyword">from</span> Highschooler
<span class="org-keyword">where</span> ID <span class="org-keyword">not</span> <span class="org-keyword">in</span> (<span class="org-keyword">select</span> ID1 <span class="org-keyword">from</span> Likes) <span class="org-keyword">and</span>
      ID <span class="org-keyword">not</span> <span class="org-keyword">in</span> (<span class="org-keyword">select</span> ID2 <span class="org-keyword">from</span> Likes)
<span class="org-keyword">order</span> <span class="org-keyword">by</span> grade, <span class="org-keyword">name</span>;
</pre>
</div>

<p>
For every situation where student A likes student B, but we have no<br />
information about whom B likes (that is, B does not appear as an ID1<br />
in the Likes table), return A and B's names and grades.<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">select</span> (<span class="org-keyword">select</span> <span class="org-keyword">name</span> <span class="org-keyword">from</span> Highschooler <span class="org-keyword">where</span> ID = ID1),
       (<span class="org-keyword">select</span> grade <span class="org-keyword">from</span> Highschooler <span class="org-keyword">where</span> ID = ID1),
       (<span class="org-keyword">select</span> <span class="org-keyword">name</span> <span class="org-keyword">from</span> Highschooler <span class="org-keyword">where</span> ID = ID2),
       (<span class="org-keyword">select</span> grade <span class="org-keyword">from</span> Highschooler <span class="org-keyword">where</span> ID = ID2)
<span class="org-keyword">from</span> Likes
<span class="org-keyword">where</span> ID2 <span class="org-keyword">not</span> <span class="org-keyword">in</span> (<span class="org-keyword">select</span> ID1 <span class="org-keyword">from</span> Likes);
</pre>
</div>

<p>
Find names and grades of students who only have friends in the same<br />
grade. Return the result sorted by grade, then by name within each<br />
grade.<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">select</span> <span class="org-keyword">name</span>, grade
<span class="org-keyword">from</span> Highschooler
<span class="org-keyword">where</span> ID <span class="org-keyword">not</span> <span class="org-keyword">in</span> (<span class="org-keyword">select</span> ID1
                 <span class="org-keyword">from</span> Friend
                 <span class="org-keyword">where</span> (<span class="org-keyword">select</span> grade <span class="org-keyword">from</span> Highschooler <span class="org-keyword">where</span> ID = ID1) &lt;&gt;
                       (<span class="org-keyword">select</span> grade <span class="org-keyword">from</span> Highschooler <span class="org-keyword">where</span> ID = ID2))
<span class="org-keyword">order</span> <span class="org-keyword">by</span> grade, <span class="org-keyword">name</span>;
</pre>
</div>

<p>
For each student A who likes a student B where the two are not<br />
friends, find if they have a friend C in common (who can introduce<br />
them!).  For all such trios, return the name and grade of A, B, and C.<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">select</span> (<span class="org-keyword">select</span> <span class="org-keyword">name</span> <span class="org-keyword">from</span> Highschooler <span class="org-keyword">where</span> ID = T.ID1),
       (<span class="org-keyword">select</span> grade <span class="org-keyword">from</span> Highschooler <span class="org-keyword">where</span> ID = T.ID1),
       (<span class="org-keyword">select</span> <span class="org-keyword">name</span> <span class="org-keyword">from</span> Highschooler <span class="org-keyword">where</span> ID = T.ID2),
       (<span class="org-keyword">select</span> grade <span class="org-keyword">from</span> Highschooler <span class="org-keyword">where</span> ID = T.ID2),
       <span class="org-keyword">name</span>, grade
<span class="org-keyword">from</span> (<span class="org-keyword">select</span> * <span class="org-keyword">from</span> Likes
      <span class="org-keyword">except</span>
      <span class="org-keyword">select</span> * <span class="org-keyword">from</span> Friend) T
     <span class="org-keyword">join</span> Highschooler
<span class="org-keyword">on</span> ID <span class="org-keyword">in</span> (<span class="org-keyword">select</span> ID2 <span class="org-keyword">from</span> Friend <span class="org-keyword">where</span> ID1 = T.ID1) <span class="org-keyword">and</span>
   ID <span class="org-keyword">in</span> (<span class="org-keyword">select</span> ID2 <span class="org-keyword">from</span> Friend <span class="org-keyword">where</span> ID1 = T.ID2);
</pre>
</div>

<p>
Find the difference between the number of students in the school and<br />
the number of different first names.<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">select</span> <span class="org-builtin">count</span>(ID) - <span class="org-builtin">count</span>(<span class="org-keyword">distinct</span> <span class="org-keyword">name</span>)
<span class="org-keyword">from</span> Highschooler;
</pre>
</div>

<p>
Find the name and grade of all students who are liked by more than one<br />
other student.<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">select</span> name2, grade2
<span class="org-keyword">from</span> (<span class="org-keyword">select</span> ID1, name1, grade1, ID2, <span class="org-keyword">name</span> <span class="org-keyword">as</span> name2, grade <span class="org-keyword">as</span> grade2
      <span class="org-keyword">from</span> (<span class="org-keyword">select</span> ID1, <span class="org-keyword">name</span> <span class="org-keyword">as</span> name1, grade <span class="org-keyword">as</span> grade1, ID2
            <span class="org-keyword">from</span> Likes <span class="org-keyword">join</span> Highschooler H <span class="org-keyword">on</span> ID1 = H.ID)
                 <span class="org-keyword">join</span> Highschooler H <span class="org-keyword">on</span> ID2 = H.ID)
<span class="org-keyword">group</span> <span class="org-keyword">by</span> ID2
<span class="org-keyword">having</span> <span class="org-builtin">count</span>(*) &gt; 1;
</pre>
</div>
</div>
</div>

<div id="outline-container-org437dfab" class="outline-4">
<h4 id="org437dfab"><span class="section-number-4">1.2.4</span> <span class="done DONE">DONE</span> Social-Network Query <a href="https://lagunita.stanford.edu/courses/DB/SQL/SelfPaced/courseware/ch-sql/seq-exercise-sql_social_query_extra/">Extras</a></h4>
<div class="outline-text-4" id="text-1-2-4">
<p>
For every situation where student A likes student B, but student B<br />
likes a different student C, return the names and grades of A, B, and<br />
C.<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">select</span> H1.<span class="org-keyword">name</span>, H1.grade,
       H2.<span class="org-keyword">name</span>, H2.grade,
       H3.<span class="org-keyword">name</span>, H3.grade
<span class="org-keyword">from</span> Likes R <span class="org-keyword">join</span> Likes S
     <span class="org-keyword">on</span> R.ID2 = S.ID1 <span class="org-keyword">and</span>
        S.ID2 &lt;&gt; R.ID1
     <span class="org-keyword">join</span> Highschooler H1
     <span class="org-keyword">on</span> R.ID1 = H1.ID
     <span class="org-keyword">join</span> Highschooler H2
     <span class="org-keyword">on</span> R.ID2 = H2.ID
     <span class="org-keyword">join</span> Highschooler H3
     <span class="org-keyword">on</span> S.ID2 = H3.ID;
</pre>
</div>

<p>
Find those students for whom all of their friends are in different<br />
grades from themselves.  Return the students' names and grades.<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">select</span> <span class="org-keyword">name</span>, grade
<span class="org-keyword">from</span> Highschooler R
<span class="org-keyword">where</span> <span class="org-keyword">not</span> <span class="org-keyword">exists</span>
      (<span class="org-keyword">select</span> * <span class="org-keyword">from</span> Friend
       <span class="org-keyword">where</span> ID1 = R.ID <span class="org-keyword">and</span>
       (<span class="org-keyword">select</span> grade <span class="org-keyword">from</span> Highschooler
        <span class="org-keyword">where</span> ID = ID2 <span class="org-keyword">and</span>
              grade = R.grade));
</pre>
</div>

<p>
What is the average number of friends per student? (Your result should<br />
be just one number.)<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">select</span> <span class="org-builtin">avg</span>(num)
<span class="org-keyword">from</span> (<span class="org-keyword">select</span> <span class="org-builtin">count</span>(*) <span class="org-keyword">as</span> num
      <span class="org-keyword">from</span> Friend
      <span class="org-keyword">group</span> <span class="org-keyword">by</span> ID1);
</pre>
</div>

<p>
The above code doesn't consider the situation where there exists a<br />
student who has no friend.  The following code handle that situation<br />
correctly.<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">select</span> <span class="org-builtin">avg</span>(num)
<span class="org-keyword">from</span> (<span class="org-keyword">select</span> (<span class="org-keyword">select</span> <span class="org-builtin">count</span>(*) <span class="org-keyword">from</span> Friend
              <span class="org-keyword">where</span> ID1 = ID) <span class="org-keyword">as</span> num
      <span class="org-keyword">from</span> Highschooler);
</pre>
</div>

<p>
Find the number of students who are either friends with Cassandra or<br />
are friends of friends of Cassandra.  Do not count Cassandra, even<br />
though technically she is a friend of a friend.<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">select</span> <span class="org-builtin">count</span>(*)
<span class="org-keyword">from</span> Highschooler
<span class="org-keyword">where</span> <span class="org-keyword">name</span> &lt;&gt; <span class="org-string">'Cassandra'</span> <span class="org-keyword">and</span>
      <span class="org-keyword">exists</span> (<span class="org-keyword">select</span> * <span class="org-keyword">from</span> Friend R
              <span class="org-keyword">where</span> R.ID1 = ID <span class="org-keyword">and</span>
                    (R.ID2 <span class="org-keyword">in</span> (<span class="org-keyword">select</span> ID <span class="org-keyword">from</span> Highschooler
                               <span class="org-keyword">where</span> <span class="org-keyword">name</span> = <span class="org-string">'Cassandra'</span>) <span class="org-keyword">or</span>
                     R.ID2 <span class="org-keyword">in</span> (<span class="org-keyword">select</span> ID1 <span class="org-keyword">from</span> Friend
                               <span class="org-keyword">where</span> ID1 = R.ID2 <span class="org-keyword">and</span>
                                     ID2 <span class="org-keyword">in</span> (<span class="org-keyword">select</span> ID <span class="org-keyword">from</span> Highschooler
                                             <span class="org-keyword">where</span> <span class="org-keyword">name</span> = <span class="org-string">'Cassandra'</span>))));

<span class="org-keyword">select</span> <span class="org-builtin">count</span>(*)
<span class="org-keyword">from</span> (<span class="org-keyword">select</span> ID1, ID2, ID3
      <span class="org-keyword">from</span> (<span class="org-keyword">select</span> L1.ID1, L1.ID2, L2.ID2 <span class="org-keyword">as</span> ID3
            <span class="org-keyword">from</span> Friend L1 <span class="org-keyword">join</span> Friend L2
            <span class="org-keyword">on</span> L1.ID2 = L2.ID1 <span class="org-keyword">and</span>
               L2.ID2 &lt;&gt; L1.ID1))
     <span class="org-keyword">join</span> Highschooler R <span class="org-keyword">on</span> ID1 = R.ID
     <span class="org-keyword">join</span> Highschooler S <span class="org-keyword">on</span> ID2 = S.ID
     <span class="org-keyword">join</span> Highschooler T <span class="org-keyword">on</span> ID3 = T.ID
<span class="org-keyword">where</span> S.<span class="org-keyword">name</span> = <span class="org-string">'Cassandra'</span> <span class="org-keyword">or</span> T.<span class="org-keyword">name</span> = <span class="org-string">'Cassandra'</span>;
</pre>
</div>

<p>
Find the name and grade of the student(s) with the greatest number of<br />
friends.<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">select</span> (<span class="org-keyword">select</span> <span class="org-keyword">name</span> <span class="org-keyword">from</span> Highschooler <span class="org-keyword">where</span> ID = ID1),
       (<span class="org-keyword">select</span> grade <span class="org-keyword">from</span> Highschooler <span class="org-keyword">where</span> ID = ID1)
<span class="org-keyword">from</span> Friend
<span class="org-keyword">group</span> <span class="org-keyword">by</span> ID1
<span class="org-keyword">having</span> <span class="org-builtin">count</span>(*) = (<span class="org-keyword">select</span> <span class="org-builtin">max</span>(num)
                   <span class="org-keyword">from</span> (<span class="org-keyword">select</span> <span class="org-builtin">count</span>(*) <span class="org-keyword">as</span> num
                         <span class="org-keyword">from</span> Friend
                         <span class="org-keyword">group</span> <span class="org-keyword">by</span> ID1));
</pre>
</div>
</div>
</div>

<div id="outline-container-orgd046bbe" class="outline-4">
<h4 id="orgd046bbe"><span class="section-number-4">1.2.5</span> <span class="done DONE">DONE</span> Movie-Rating <a href="https://lagunita.stanford.edu/courses/DB/SQL/SelfPaced/courseware/ch-sql/seq-exercise-sql_movie_mod/">Modification</a></h4>
<div class="outline-text-4" id="text-1-2-5">
<p>
Add the reviewer Roger Ebert to your database, with an rID of 209.<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">insert</span> <span class="org-keyword">into</span> Reviewer <span class="org-keyword">values</span> (209, <span class="org-string">'Roger Ebert'</span>);
</pre>
</div>

<p>
Insert 5-star ratings by James Cameron for all movies in the database.<br />
Leave the review date as NULL.<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">insert</span> <span class="org-keyword">into</span> Rating
<span class="org-keyword">select</span> (<span class="org-keyword">select</span> rID <span class="org-keyword">from</span> Reviewer <span class="org-keyword">where</span> <span class="org-keyword">name</span> = <span class="org-string">'James Cameron'</span>),
       mID, 5, <span class="org-keyword">null</span>
<span class="org-keyword">from</span> Movie;
</pre>
</div>

<p>
For all movies that have an average rating of 4 stars or higher, add<br />
25 to the release year.  (Update the existing tuples; don't insert new<br />
tuples.)<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">update</span> Movie
<span class="org-keyword">set</span> <span class="org-keyword">year</span> = <span class="org-keyword">year</span> + 25
<span class="org-keyword">where</span> (<span class="org-keyword">select</span> <span class="org-builtin">avg</span>(stars) <span class="org-keyword">from</span> Rating <span class="org-keyword">where</span> mID = Movie.mID) &gt;= 4;
</pre>
</div>

<p>
Remove all ratings where the movie's year is before 1970 or after<br />
2000, and the rating is fewer than 4 stars.<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">delete</span> <span class="org-keyword">from</span> Rating
<span class="org-keyword">where</span> stars &lt; 4 <span class="org-keyword">and</span>
      ((<span class="org-keyword">select</span> <span class="org-keyword">year</span> <span class="org-keyword">from</span> Movie <span class="org-keyword">where</span> mID = Rating.mID) &lt; 1970 <span class="org-keyword">or</span>
       (<span class="org-keyword">select</span> <span class="org-keyword">year</span> <span class="org-keyword">from</span> Movie <span class="org-keyword">where</span> mID = Rating.mID) &gt; 2000)
</pre>
</div>
</div>
</div>

<div id="outline-container-org6753299" class="outline-4">
<h4 id="org6753299"><span class="section-number-4">1.2.6</span> <span class="done DONE">DONE</span> Social-Network <a href="https://lagunita.stanford.edu/courses/DB/SQL/SelfPaced/courseware/ch-sql/seq-exercise-sql_social_mod/">Modification</a></h4>
<div class="outline-text-4" id="text-1-2-6">
<p>
It's time for the seniors to graduate.  Remove all 12th graders from<br />
Highschooler.<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">delete</span> <span class="org-keyword">from</span> Highschooler
<span class="org-keyword">where</span> grade = 12;
</pre>
</div>

<p>
If two students A and B are friends, and A likes B but not vice-versa,<br />
remove the Likes tuple.<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">delete</span> <span class="org-keyword">from</span> Likes
<span class="org-keyword">where</span> <span class="org-keyword">exists</span> (<span class="org-keyword">select</span> *
              <span class="org-keyword">from</span> (<span class="org-keyword">select</span> * <span class="org-keyword">from</span> Friend
                    <span class="org-keyword">except</span>
                    <span class="org-keyword">select</span> ID2, ID1 <span class="org-keyword">from</span> Likes
                    <span class="org-keyword">intersect</span>
                    <span class="org-keyword">select</span> * <span class="org-keyword">from</span> Likes)
              <span class="org-keyword">where</span> ID1 = Likes.ID1 <span class="org-keyword">and</span> ID2 = Likes.ID2);
</pre>
</div>

<p>
For all cases where A is friends with B, and B is friends with C, add<br />
a new friendship for the pair A and C.  Do not add duplicate<br />
friendships, friendships that already exist, or friendships with<br />
oneself.  (This one is a bit challenging; congratulations if you get<br />
it right.)<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">insert</span> <span class="org-keyword">into</span> Friend
<span class="org-keyword">select</span> <span class="org-keyword">distinct</span> R.ID1, S.ID2
<span class="org-keyword">from</span> Friend R <span class="org-keyword">join</span> Friend S
<span class="org-keyword">on</span> R.ID2 = S.ID1 <span class="org-keyword">and</span> S.ID2 &lt;&gt; R.ID1 <span class="org-keyword">and</span>
   <span class="org-keyword">not</span> <span class="org-keyword">exists</span> (<span class="org-keyword">select</span> * <span class="org-keyword">from</span> Friend
             <span class="org-keyword">where</span> ID1 = R.ID1 <span class="org-keyword">and</span>
                   ID2 = S.ID2);
</pre>
</div>
</div>
</div>
</div>
</div>


<div id="outline-container-orgb382ec8" class="outline-2">
<h2 id="orgb382ec8"><span class="section-number-2">2</span> <span class="done DONE">DONE</span> <a href="https://lagunita.stanford.edu/courses/DB/XPath/SelfPaced/courseware/ch-querying_xml/">XPath and XQuery</a> mini-course</h2>
<div class="outline-text-2" id="text-2">
</div>
<div id="outline-container-orgcee6e23" class="outline-3">
<h3 id="orgcee6e23"><span class="section-number-3">2.1</span> <span class="done DONE">DONE</span> Lecture videos</h3>
<div class="outline-text-3" id="text-2-1">
</div>
<div id="outline-container-orga1aef34" class="outline-4">
<h4 id="orga1aef34"><span class="section-number-4">2.1.1</span> <span class="done DONE">DONE</span> XPath Introduction</h4>
<div class="outline-text-4" id="text-2-1-1">
<p>
Not nearly as mature as Querying Relational<br />
XPath - path expressions + conditions<br />
XSLT - XPath + transformations, output<br />
XQuery - XPath + full-featured Q.L.<br />
</p>

<p>
Think of XML as a tree<br />
</p>

<p>
Basic Constructs<br />
/ root element and separator<br />
{element name} or *<br />
@{attribute name}<br />
// any descendants including self<br />
[condition] e.g. [@price &lt; 50]<br />
[number] nth sub-element<br />
</p>

<p>
Built-in functions (lots of them)<br />
contains(s1, s2)<br />
name()<br />
</p>

<p>
Navigation "axes" (13 of them)<br />
parent::<br />
following-sibling::<br />
descendants:: (does not match self, cf. //)<br />
self::<br />
</p>

<p>
XPath queries operate on and return <i>sequence</i> of elements<br />
Sometimes result can be expressed as XML, but not always<br />
</p>
</div>
</div>

<div id="outline-container-org2fb9b89" class="outline-4">
<h4 id="org2fb9b89"><span class="section-number-4">2.1.2</span> <span class="done DONE">DONE</span> XPath Demo</h4>
<div class="outline-text-4" id="text-2-1-2">
<p>
Get the titles of books in the bookstore where the price is lower<br />
than 90 and Jeffrey Widom is an author.<br />
</p>

<div class="org-src-container">
<pre class="src src-xpath">doc("BookstoreQ.xml")/Bookstore/Book[@Price &lt; 90 and
        Authors/Author[Last_name = "Widom" and
        First_Name="Jeffrey"]]/Title
</pre>
</div>

<p>
Get the titles of books where "Ullman" is an author and "Widom" is not<br />
an author.  <b>The below code doesn't work since there is no way using<br />
XPath language alone to achieve the query.</b><br />
</p>

<div class="org-src-container">
<pre class="src src-xpath">doc("BookstoreQ.xml")/Bookstore/Book[
        Authors/Author/Last_Name = "Ullman" and
        Authors/Author/Last_Name != "Widom"]/Title
</pre>
</div>

<p>
Get all magazines where there's a book with the same title.  (An<br />
example of <i>self-join</i> in XPath)<br />
</p>

<div class="org-src-container">
<pre class="src src-xpath">doc("BookstoreQ.xml")//Magazine[
        Title = doc("BookstoreQ.xml")//Book/Title]
</pre>
</div>

<p>
The equal sign in the above code is implicitly existentially<br />
quantified.  There is a lot of implicit existential quantification in<br />
XPath and XQuery.<br />
</p>

<p>
All Elements whose parent is not "Bookstore" or "Book".<br />
</p>

<div class="org-src-container">
<pre class="src src-xpath">doc("BookstoreQ.xml")/Bookstore//*[
        name(parent::*) != "Bookstore"
        and name(parent::*) != "Book"]
</pre>
</div>

<p>
The above code use the navigation access <code>parent::</code>.<br />
</p>

<p>
All books and magazines with non-unique titles.<br />
</p>

<div class="org-src-container">
<pre class="src src-xpath">doc("BookstoreQ.xml")/Bookstore/(Book|Magazine)[
        Title = following-sibling::*/Title
        or Title = preceding-sibling::*/Title]
</pre>
</div>

<p>
Books where every author's first name includes "J".  This query will<br />
need universal quantification.<br />
</p>

<div class="org-src-container">
<pre class="src src-xpath">doc("BookstoreQ.xml")//Book[
        count(Authors/Author[contains(First_Name, "J")]) =
        count(Authors/Author/First_Name)]
</pre>
</div>

<p>
The built-in function <code>count</code> is used to simulate universal<br />
quantification.  This technique can solve previously undoable query.<br />
</p>

<p>
Titles of books where "Ullman" is an author and "Widom" is not<br />
an author.<br />
</p>

<div class="org-src-container">
<pre class="src src-xpath">doc("BookstoreQ.xml")/Bookstore/Book[
        Authors/Author/Last_Name = "Ullman"
        and count(Authors/Author[Last_Name = "Widom"]) = 0]/Title
</pre>
</div>
</div>
</div>

<div id="outline-container-org0b555f3" class="outline-4">
<h4 id="org0b555f3"><span class="section-number-4">2.1.3</span> <span class="done DONE">DONE</span> XQuery Introduction</h4>
<div class="outline-text-4" id="text-2-1-3">
<ol class="org-ol">
<li>XQuery is a expression language (compositional)<br /></li>
<li>Each expression operates on and returns sequence of elements<br /></li>
<li>XPath is one type of expression<br /></li>
</ol>

<p>
XQuery: FLWOR expression<br />
</p>

<div class="org-src-container">
<pre class="src src-xquery">For $var in expr
Let $var := expr
Where condition
Order By expr
Return expr
</pre>
</div>

<p>
Mixing queries and XMl<br />
</p>

<div class="org-src-container">
<pre class="src src-xquery">&lt;Result&gt; { ...query goes here... } &lt;/Result&gt;
</pre>
</div>
</div>
</div>

<div id="outline-container-org40fe4b7" class="outline-4">
<h4 id="org40fe4b7"><span class="section-number-4">2.1.4</span> <span class="done DONE">DONE</span> XQuery Demo</h4>
<div class="outline-text-4" id="text-2-1-4">
<div class="org-src-container">
<pre class="src src-xquery">for $b in doc("BookstoreQ.xml")/Bookstore/Book
where $b/@Price &lt; 90
  and $b/Authors/Author/Last_Name = "Ullman"
return $b/Title
</pre>
</div>

<div class="org-src-container">
<pre class="src src-xquery">for $b in doc("BookstoreQ.xml")/Bookstore/Book
where some $fn in $b/Authors/Author/First_Name
        satisfies contains($b/Title, $fn)
return &lt;Book&gt;
         { $b/Title }
         { $b/Authors/Author/First_Name }
       &lt;/Book&gt;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-xquery">for $b in doc("BookstoreQ.xml")/Bookstore/Book
where some $fn in $b/Authors/Author/First_Name
        satisfies contains($b/Title, $fn)
return &lt;Book&gt;
         { $b/Title }
         { for $fn in $b/Authors/Authors/Author/First_Name
           where contains($b/Title, $fn) return $fn }
       &lt;/Book&gt;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-xquery">&lt;Average&gt;
  { let $plist := doc("BookstoreQ.xml")/Bookstore/Book/@Price
    return avg($plist) }
&lt;/Average&gt;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-xquery">let $a := avg(doc("BookstoreQ.xml")/Bookstore/Book/@Price)
for $b in doc("BookstoreQ.xml")/Bookstore/Book
where $b/@Price &lt; $a
return &lt;Book&gt;
          { $b/Title }
          &lt;Price&gt; { $b/data(@Price) } &lt;/Price&gt;
       &lt;/Book&gt;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-xquery">for $b in doc("BookstoreQ.xml")/Bookstore/Book
order by xs:int($b/@Price)
return &lt;Book&gt;
          { $b/Title }
          &lt;Price&gt; { $b/data(@Price) } &lt;/Price&gt;
       &lt;/Book&gt;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-xquery">for $n in distinct-values(doc("BookstoreQ.xml")//Last_Name)
return &lt;Last_Name&gt; { $n } &lt;/Last_Name&gt;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-xquery">for $b in doc("BookstoreQ.xml")/Bookstore/Book
where every $fn in $b/Authors/Author/First_Name
        satisfies contains($fn, "J")
return $b
</pre>
</div>

<div class="org-src-container">
<pre class="src src-xquery">for $b1 in doc("BookstoreQ.xml")/Bookstore/Book
for $b2 in doc("BookstoreQ.xml")/Bookstore/Book
where $b1/Authors/Author/Last_Name = $b2/Authors/Author/Last_Name
      and $b1/Title &lt; $b2/Title
return
    &lt;BookPair&gt;
        &lt;Title1&gt; { data($b1/Title) } &lt;/Title1&gt;
        &lt;Title2&gt; { data($b2/Title) } &lt;/Title2&gt;
    &lt;/BookPair&gt;
</pre>
</div>

<p>
Again, implicitly existential quantification.<br />
</p>

<div class="org-src-container">
<pre class="src src-xquery">&lt;InvertedBookstore&gt;
    { for $ln in distinct-values(doc("BookstoreQ.xml")//Author/Last_Name)
      for $fn in distinct-values(doc("BookstoreQ.xml")//Author[
                                      Last_name=$ln]/First_Name)
      return
          &lt;Author&gt;
              &lt;First_Name&gt; { $fn } &lt;/First_name&gt;
              &lt;Last_Name { $ln } &lt;/Last_Name&gt;
              { for $b in doc("BookstoreQ.xml")/Bookstore/Book[
                               Authors/Atuhor/Last_Name=$ln]
                return &lt;Book&gt;
                          { $b/@ISBN } { $b/@Price } { $/@Edition }
                          { $b/Title } { $b/Remark }
                       &lt;/Book&gt;
          &lt;/Author&gt; }
&lt;/InvertedBookstore&gt;
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org7516b91" class="outline-3">
<h3 id="org7516b91"><span class="section-number-3">2.2</span> <span class="done DONE">DONE</span> Exercises</h3>
<div class="outline-text-3" id="text-2-2">
</div>
<div id="outline-container-orgf3708e2" class="outline-4">
<h4 id="orgf3708e2"><span class="section-number-4">2.2.1</span> <span class="done DONE">DONE</span> Course-Catalog XPath and XQuery Exercises</h4>
<div class="outline-text-4" id="text-2-2-1">
<p>
Return all Title elements (of both departments and courses).<br />
</p>

<div class="org-src-container">
<pre class="src src-xquery">doc("courses.xml")//Title
</pre>
</div>

<p>
Return last names of all department chairs.<br />
</p>

<div class="org-src-container">
<pre class="src src-xquery">doc("courses.xml")//Department/Chair//Last_Name
</pre>
</div>

<p>
Return titles of courses with enrollment greater than 500.<br />
</p>

<div class="org-src-container">
<pre class="src src-xquery">doc("courses.xml")//Course[@Enrollment &gt; 500]/Title
</pre>
</div>

<p>
Return titles of departments that have some course that takes "CS106B"<br />
as a prerequisite.<br />
</p>

<div class="org-src-container">
<pre class="src src-xquery">doc("courses.xml")//Department[Course/Prerequisites[Prereq = "CS106B"]]/Title
</pre>
</div>

<p>
Return last names of all professors or lecturers who use a middle<br />
initial.  Don't worry about eliminating duplicates.<br />
</p>

<div class="org-src-container">
<pre class="src src-xquery">doc("courses.xml")//(Lecturer|Professor)[Middle_Initial]/Last_Name
</pre>
</div>

<p>
Return the count of courses that have a cross-listed course (i.e.,<br />
that have "Cross-listed" in their description).<br />
</p>

<div class="org-src-container">
<pre class="src src-xquery">count(doc("courses.xml")//Course[contains(Description, "Cross-listed")])
</pre>
</div>

<p>
Return the average enrollment of all courses in the CS department.<br />
</p>

<div class="org-src-container">
<pre class="src src-xquery">avg(doc("courses.xml")//Department[@Code="CS"]/Course/@Enrollment)
</pre>
</div>

<p>
Return last names of instructors teaching at least one course that has<br />
"system" in its description and enrollment greater than 100.<br />
</p>

<div class="org-src-container">
<pre class="src src-xquery">doc("courses.xml")//Course[@Enrollment &gt; 100 and contains(Description, "system")]/Instructors//Last_Name
</pre>
</div>

<p>
Return the title of the course with the largest enrollment.<br />
</p>

<div class="org-src-container">
<pre class="src src-xquery">for $c in doc("courses.xml")//Course
where every $e in doc("courses.xml")//Course/@Enrollment
        satisfies xs:int($e) &lt;= xs:int($c/@Enrollment)
return $c/Title
</pre>
</div>

<p>
Only one of the function call <code>xs:int</code> shown above is necessary since<br />
the other operand will go through type promotion.<br />
</p>
</div>
</div>

<div id="outline-container-org97ee342" class="outline-4">
<h4 id="org97ee342"><span class="section-number-4">2.2.2</span> <span class="done DONE">DONE</span> Course-Catalog XPath and XQuery Exercises Extras</h4>
<div class="outline-text-4" id="text-2-2-2">
<p>
Return the course number of the course that is cross-listed as "LING180".<br />
</p>

<div class="org-src-container">
<pre class="src src-xquery">data(doc("courses.xml")//Course[contains(Description, "Cross-listed as LING180")]/@Number)
</pre>
</div>

<p>
Return course numbers of courses that have the same title as some<br />
other course.  (Hint: You might want to use the "preceding" and<br />
"following" navigation axes for this query, which were not covered in<br />
the video or our demo script; they match any preceding or following<br />
node, not just siblings.)<br />
</p>

<div class="org-src-container">
<pre class="src src-xquery">for $c1 in doc("courses.xml")//Course
where some $c2 in doc("courses.xml")//Course
      satisfies $c1 != $c2
                and $c1/Title = $c2/Title
return data($c1/@Number)
</pre>
</div>

<p>
Return course numbers of courses taught by an instructor with first<br />
name "Daphne" or "Julie".<br />
</p>

<div class="org-src-container">
<pre class="src src-xquery">data(doc("courses.xml")//Course[Instructors//First_Name = ("Daphne", "Julie")]/@Number)
</pre>
</div>

<p>
Return the number (count) of courses that have no lecturers as<br />
instructors.<br />
</p>

<div class="org-src-container">
<pre class="src src-xquery">count(doc("courses.xml")//Course[not(Instructors[Lecturer])])
</pre>
</div>

<p>
Return titles of courses taught by the chair of a department.  For<br />
this question, you may assume that all professors have distinct last<br />
names.<br />
</p>

<div class="org-src-container">
<pre class="src src-xquery">doc("courses.xml")//Course[
    Instructors/Professor/Last_Name =
        doc("courses.xml")//Department/Chair/Professor/Last_Name
]/Title
</pre>
</div>

<div class="org-src-container">
<pre class="src src-xquery">for $c in doc("courses.xml")//Course
where $c/Instructors/(Professor|Lecturer)/Last_Name
          = doc("courses.xml")//Department/Chair/(Professor|Lecturer)/Last_Name
return $c/Title
</pre>
</div>

<div class="org-src-container">
<pre class="src src-xquery">for $c in doc("courses.xml")//Course
where some $t1 in $c/Instructors/(Professor|Lecturer)
      satisfies some $t2 in
                doc("courses.xml")//Department/Chair/(Professor|Lecturer)
                satisfies deep-equal($t1/*, $t2/*)
return $c/Title
</pre>
</div>

<p>
Return titles of courses that have both a lecturer and a professor as<br />
instructors.  Return each title only once.<br />
</p>

<div class="org-src-container">
<pre class="src src-xquery">doc("courses.xml")//Course[Instructors/Lecturer and Instructors/Professor]/Title
</pre>
</div>

<p>
Return titles of courses taught by a professor with the last name "Ng"<br />
but not by a professor with the last name "Thrun".<br />
</p>

<div class="org-src-container">
<pre class="src src-xquery">for $c in doc("courses.xml")//Course[Instructors/Professor/Last_Name = "Ng"]
where every $ln in $c/Instructors/Professor/Last_Name
      satisfies $ln != "Thrun"
return $c/Title
</pre>
</div>

<div class="org-src-container">
<pre class="src src-xquery">doc("courses.xml")//Course[Instructors[
        Professor/Last_Name = "Ng" and
        count(Professor[Last_Name = "Thrun"]) = 0]]/Title
</pre>
</div>

<p>
Return course numbers of courses that have a course taught by Eric<br />
Roberts as a prerequisite.<br />
</p>

<div class="org-src-container">
<pre class="src src-xquery">for $c in doc("courses.xml")//Course
where some $p in $c/Prerequisites/Prereq
      satisfies $p = data(
          doc("courses.xml")//Course[
              Instructors/(Professor|Lecturer)[
                  First_Name = "Eric" and
                  Last_Name = "Roberts"]]/@Number)
return data($c/@Number)
</pre>
</div>

<p>
Create a summary of CS classes: List all CS department courses in<br />
order of enrollment.  For each course include only its Enrollment (as<br />
an attribute) and its Title (as a subelement).<br />
</p>

<div class="org-src-container">
<pre class="src src-xquery">&lt;Summary&gt;
    { for $c in doc("courses.xml")//Department[@Code="CS"]/Course
      order by xs:int($c/@Enrollment)
      return &lt;Course&gt;
                 { $c/@Enrollment }
                 { $c/Title }
             &lt;/Course&gt; }
&lt;/Summary&gt;
</pre>
</div>

<p>
Return a "Professors" element that contains as subelements a listing<br />
of all professors in all departments, sorted by last name with each<br />
professor appearing once.  The "Professor" subelements should have the<br />
same structure as in the original data.  For this question, you may<br />
assume that all professors have distinct last names.  Watch out &#x2013; the<br />
presence/absence of middle initials may require some special handling.<br />
(This problem is quite challenging; congratulations if you get it<br />
right.)<br />
</p>

<div class="org-src-container">
<pre class="src src-xquery">&lt;Professors&gt;
    { for $ln in distinct-values(doc("courses.xml")//Professor/Last_Name)
      order by $ln
      return (doc("courses.xml")//Professor[Last_Name=$ln])[1] }
&lt;/Professors&gt;
</pre>
</div>

<p>
Expanding on the previous question, create an inverted course listing:<br />
Return an "Inverted_Course_Catalog" element that contains as<br />
subelements professors together with the courses they teach, sorted by<br />
last name.  You may still assume that all professors have distinct last<br />
names.  The "Professor" subelements should have the same structure as<br />
in the original data, with an additional single "Courses" subelement<br />
under Professor, containing a further "Course" subelement for each<br />
course number taught by that professor.  Professors who do not teach<br />
any courses should have no Courses subelement at all.  (This problem is<br />
very challenging; extra congratulations if you get it right.)<br />
</p>

<div class="org-src-container">
<pre class="src src-xquery">&lt;Inverted_Course_Catalog&gt;
    { for $ln in distinct-values(doc("courses.xml")//Professor/Last_Name)
      let $prof := (doc("courses.xml")//Professor[Last_Name=$ln])[1]
      order by $ln
      return &lt;Professor&gt;
                 { $prof/First_Name } { $prof/Middle_Initial }
                 { $prof/Last_Name }
                 { let $cs :=
                       &lt;Courses&gt;
                           { for $c in doc("courses.xml")//Course[
                                 Instructors/Professor/Last_Name = $ln]
                             return &lt;Course&gt;
                                        { data($c/@Number) }
                                    &lt;/Course&gt; }
                       &lt;/Courses&gt;
                   return $cs[Course] }
             &lt;/Professor&gt;}
&lt;/Inverted_Course_Catalog&gt;
</pre>
</div>
</div>
</div>

<div id="outline-container-org352102f" class="outline-4">
<h4 id="org352102f"><span class="section-number-4">2.2.3</span> <span class="done DONE">DONE</span> World-Countries XPath and XQuery Exercises</h4>
<div class="outline-text-4" id="text-2-2-3">
<p>
Return the area of Mongolia.<br />
</p>

<div class="org-src-container">
<pre class="src src-xquery">data(doc("countries.xml")//country[@name="Mongolia"]/@area)
</pre>
</div>

<p>
Return the names of all cities that have the same name as the country<br />
in which they are located.<br />
</p>

<div class="org-src-container">
<pre class="src src-xquery">for $c in doc("countries.xml")//country[@name = city/name]
return $c/city[name = $c/@name]/name
</pre>
</div>

<div class="org-src-container">
<pre class="src src-xquery">for $c in doc("countries.xml")//country[@name = city/name]
return &lt;name&gt; { data($c/@name) } &lt;/name&gt;
</pre>
</div>

<p>
Return the average population of Russian-speaking countries.<br />
</p>

<div class="org-src-container">
<pre class="src src-xquery">avg(data(doc("countries.xml")//country[language = "Russian"]/@population))
</pre>
</div>

<p>
Return the names of all countries that have at least three cities with<br />
population greater than 3 million.<br />
</p>

<div class="org-src-container">
<pre class="src src-xquery">data(doc("countries.xml")//country[count(city[xs:int(population) &gt; 3000000]) &gt;= 3]/@name)
</pre>
</div>

<p>
The function call <code>xs:int</code> in the above code is actually unnecessary<br />
since type promotion would occur due to right-hand operand.<br />
</p>

<p>
Create a list of French-speaking and German-speaking countries.  The<br />
result should take the form:<br />
</p>

<div class="org-src-container">
<pre class="src src-xml"><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">result</span><span class="org-nxml-tag-delimiter">&gt;</span>
  <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">French</span><span class="org-nxml-tag-delimiter">&gt;</span>
    <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">country</span><span class="org-nxml-tag-delimiter">&gt;</span><span class="org-nxml-text">country-name</span><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">country</span><span class="org-nxml-tag-delimiter">&gt;</span>
    <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">country</span><span class="org-nxml-tag-delimiter">&gt;</span><span class="org-nxml-text">country-name</span><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">country</span><span class="org-nxml-tag-delimiter">&gt;</span>
<span class="org-nxml-text">    ...</span>
<span class="org-nxml-text">  </span><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">French</span><span class="org-nxml-tag-delimiter">&gt;</span>
  <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">German</span><span class="org-nxml-tag-delimiter">&gt;</span>
    <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">country</span><span class="org-nxml-tag-delimiter">&gt;</span><span class="org-nxml-text">country-name</span><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">country</span><span class="org-nxml-tag-delimiter">&gt;</span>
    <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">country</span><span class="org-nxml-tag-delimiter">&gt;</span><span class="org-nxml-text">country-name</span><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">country</span><span class="org-nxml-tag-delimiter">&gt;</span>
<span class="org-nxml-text">    ...</span>
<span class="org-nxml-text">  </span><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">German</span><span class="org-nxml-tag-delimiter">&gt;</span>
<span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">result</span><span class="org-nxml-tag-delimiter">&gt;</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-xquery">&lt;result&gt;
  &lt;French&gt;
    { for $cn in data(doc("countries.xml")//country[language = "French"]/@name)
      return &lt;country&gt; { $cn } &lt;/country&gt; }
  &lt;/French&gt;
  &lt;German&gt;
    { for $cn in data(doc("countries.xml")//country[language = "German"]/@name)
      return &lt;country&gt; { $cn } &lt;/country&gt; }
  &lt;/German&gt;
&lt;/result&gt;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-xquery">&lt;result&gt;
  { let $langs := ("French", "German")
    for $lang in $langs
    return element {$lang}
    { for $cn in data(doc("countries.xml")//country[language=$lang]/@name)
          return &lt;country&gt; { $cn } &lt;/country&gt; } }
&lt;/result&gt;
</pre>
</div>

<p>
Return the countries with the highest and lowest population densities.<br />
Note that because the "/" operator has its own meaning in XPath and<br />
XQuery, the division operator is infix "div".  To compute population<br />
density use "(@population div @area)".  You can assume density values<br />
are unique.  The result should take the form:<br />
</p>

<div class="org-src-container">
<pre class="src src-xml"><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">result</span><span class="org-nxml-tag-delimiter">&gt;</span>
  <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">highest</span> <span class="org-nxml-attribute-local-name">density</span>=<span class="org-nxml-attribute-value-delimiter">"</span><span class="org-nxml-attribute-value">value</span><span class="org-nxml-attribute-value-delimiter">"</span><span class="org-nxml-tag-delimiter">&gt;</span><span class="org-nxml-text">country-name</span><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">highest</span><span class="org-nxml-tag-delimiter">&gt;</span>
  <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">lowest</span> <span class="org-nxml-attribute-local-name">density</span>=<span class="org-nxml-attribute-value-delimiter">"</span><span class="org-nxml-attribute-value">value</span><span class="org-nxml-attribute-value-delimiter">"</span><span class="org-nxml-tag-delimiter">&gt;</span><span class="org-nxml-text">country-name</span><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">lowest</span><span class="org-nxml-tag-delimiter">&gt;</span>
<span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">result</span><span class="org-nxml-tag-delimiter">&gt;</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-xquery">&lt;result&gt;
  { for $c1 in doc("countries.xml")//country
    let $density := $c1/@population div $c1/@area
    where every $c2 in doc("countries.xml")//country
          satisfies $density &gt;= $c2/@population div $c2/@area
    return &lt;highest density="{$density}"&gt; { data($c1/@name) } &lt;/highest&gt; }
  { for $c1 in doc("countries.xml")//country
    let $density := $c1/@population div $c1/@area
    where every $c2 in doc("countries.xml")//country
          satisfies $density &lt;= $c2/@population div $c2/@area
    return &lt;lowest density="{$density}"&gt; { data($c1/@name) } &lt;/lowest&gt; }
&lt;/result&gt;
</pre>
</div>
</div>
</div>

<div id="outline-container-org8c8cc24" class="outline-4">
<h4 id="org8c8cc24"><span class="section-number-4">2.2.4</span> <span class="done DONE">DONE</span> World-Countries XPath and XQuery Exercises Extras</h4>
<div class="outline-text-4" id="text-2-2-4">
<p>
Return the names of all countries with population greater than 100<br />
million.<br />
</p>

<div class="org-src-container">
<pre class="src src-xquery">data(doc("countries.xml")//country[@population &gt; 100000000]/@name)
</pre>
</div>

<p>
Return the names of all countries where over 50% of the population<br />
speaks German.  (Hint: Depending on your solution, you may want to use<br />
".", which refers to the "current element" within an XPath<br />
expression.)<br />
</p>

<div class="org-src-container">
<pre class="src src-xquery">data(doc("countries.xml")//country[language[@percentage &gt; 50.0] = "German"]/@name)
</pre>
</div>

<p>
Return the names of all countries where a city in that country<br />
contains more than one-third of the country's population.<br />
</p>

<div class="org-src-container">
<pre class="src src-xquery">for $c in doc("countries.xml")//country
where some $cp in $c/city/population
      satisfies $cp div $c/@population &gt; 1 div 3
return data($c/@name)
</pre>
</div>

<p>
Return the population density of Qatar.  Note: Since the "/" operator<br />
has its own meaning in XPath and XQuery, the division operator is<br />
"div".  To compute population density use "(@population div @area)".<br />
</p>

<div class="org-src-container">
<pre class="src src-xquery">let $c := doc("countries.xml")//country[@name="Qatar"]
return $c/@population div $c/@area
</pre>
</div>

<p>
Return the names of all countries whose population is less than one<br />
thousandth that of some city (in any country).<br />
</p>

<div class="org-src-container">
<pre class="src src-xquery">let $countries := doc("countries.xml")//country
for $c in $countries
where some $city in $countries/city
      satisfies $city/population * 0.001 &gt; $c/@population
return data($c/@name)
</pre>
</div>

<p>
Return all city names that appear more than once, i.e., there is more<br />
than one city with that name in the data.  Return only one instance of<br />
each such city name.  (Hint: You might want to use the "preceding"<br />
and/or "following" navigation axes for this query, which were not<br />
covered in the video or our demo script; they match any preceding or<br />
following node, not just siblings.)<br />
</p>

<div class="org-src-container">
<pre class="src src-xquery">let $cities := doc("countries.xml")//city
for $city in distinct-values($cities/name)
where count($cities[name = $city]) &gt; 1
return &lt;name&gt;{$city}&lt;/name&gt;
</pre>
</div>

<p>
Return the names of all countries containing a city such that some<br />
other country has a city of the same name.  (Hint: You might want to<br />
use the "preceding" and/or "following" navigation axes for this query,<br />
which were not covered in the video or our demo script; they match any<br />
preceding or following node, not just siblings.)<br />
</p>

<div class="org-src-container">
<pre class="src src-xquery">let $countries := doc("countries.xml")//country
for $c in $countries
where some $c2 in $countries
      satisfies not($c2 is $c)
                and $c/city/name = $c2/city/name
return data($c/@name)
</pre>
</div>

<p>
Return the names of all countries whose name textually contains a<br />
language spoken in that country.  For instance, Uzbek is spoken in<br />
Uzbekistan, so return Uzbekistan.  (Hint: You may want to use ".",<br />
which refers to the "current element" within an XPath expression.)<br />
</p>

<div class="org-src-container">
<pre class="src src-xquery">for $c in doc("countries.xml")//country
where some $lang in $c/language
      satisfies contains($c/@name, $lang)
return data($c/@name)
</pre>
</div>

<p>
Return the names of all countries in which people speak a language<br />
whose name textually contains the name of the country.  For instance,<br />
Japanese is spoken in Japan, so return Japan.  (Hint: You may want to<br />
use ".", which refers to the "current element" within an XPath<br />
expression.)<br />
</p>

<div class="org-src-container">
<pre class="src src-xquery">data(doc("countries.xml")//country[language[contains(., ../@name)]]/@name)
</pre>
</div>

<p>
Return all languages spoken in a country whose name textually contains<br />
the language name.  For instance, German is spoken in Germany, so<br />
return German.  (Hint: Depending on your solution, may want to use<br />
data(.), which returns the text value of the "current element" within<br />
an XPath expression.)<br />
</p>

<div class="org-src-container">
<pre class="src src-xquery">data(doc("countries.xml")//country/language[contains(../@name, .)])
</pre>
</div>

<p>
Return all languages whose name textually contains the name of a<br />
country in which the language is spoken.  For instance, Icelandic is<br />
spoken in Iceland, so return Icelandic.  (Hint: Depending on your<br />
solution, may want to use data(.), which returns the text value of the<br />
"current element" within an XPath expression.)<br />
</p>

<div class="org-src-container">
<pre class="src src-xquery">data(doc("countries.xml")//country/language[contains(., ../@name)])
</pre>
</div>

<p>
Return the number of countries where Russian is spoken.<br />
</p>

<div class="org-src-container">
<pre class="src src-xquery">count(doc("countries.xml")//country[language = "Russian"])
</pre>
</div>

<p>
Return the names of all countries for which the data does not include<br />
any languages or cities, but the country has more than 10 million<br />
people.<br />
</p>

<div class="org-src-container">
<pre class="src src-xquery">data(doc("countries.xml")//country[not(language or city) and @population &gt; 10000000]/@name)
</pre>
</div>

<p>
Return the name of the country with the highest population.  (Hint: You<br />
may need to explicitly cast population numbers as integers with<br />
xs:int() to get the correct answer.)<br />
</p>

<div class="org-src-container">
<pre class="src src-xquery">data(doc("countries.xml")//country[
    @population = max(doc("countries.xml")//country/@population)
]/@name)
#+END_SRC)

Return the name of the country that has the city with the highest
population.  (Hint: You may need to explicitly cast population numbers
as integers with xs:int() to get the correct answer.)

#+BEGIN_SRC xquery
data(doc("countries.xml")//country[
    city/population = max(doc("countries.xml")//city/population)
]/@name)
</pre>
</div>

<p>
Return the average number of languages spoken in countries where<br />
Russian is spoken.<br />
</p>

<div class="org-src-container">
<pre class="src src-xquery">avg(for $c in doc("countries.xml")//country[language = "Russian"]
return count($c/language))
</pre>
</div>

<p>
Return all country-language pairs where the language is spoken in the<br />
country and the name of the country textually contains the language<br />
name.  Return each pair as a country element with language attribute,<br />
e.g.,<br />
</p>

<div class="org-src-container">
<pre class="src src-xml"><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">country</span> <span class="org-nxml-attribute-local-name">language</span>=<span class="org-nxml-attribute-value-delimiter">"</span><span class="org-nxml-attribute-value">French</span><span class="org-nxml-attribute-value-delimiter">"</span><span class="org-nxml-tag-delimiter">&gt;</span><span class="org-nxml-text">French Guiana</span><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">country</span><span class="org-nxml-tag-delimiter">&gt;</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-xquery">for $c in doc("countries.xml")//country
for $lang in $c/language
where contains($c/@name, $lang)
return &lt;country language="{$lang}"&gt; { data($c/@name) } &lt;/country&gt;
</pre>
</div>

<p>
Return all countries that have at least one city with population<br />
greater than 7 million.  For each one, return the country name along<br />
with the cities greater than 7 million, in the format:<br />
</p>

<div class="org-src-container">
<pre class="src src-xml"><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">country</span> <span class="org-nxml-attribute-local-name">name</span>=<span class="org-nxml-attribute-value-delimiter">"</span><span class="org-nxml-attribute-value">country-name</span><span class="org-nxml-attribute-value-delimiter">"</span><span class="org-nxml-tag-delimiter">&gt;</span>
  <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">big</span><span class="org-nxml-tag-delimiter">&gt;</span><span class="org-nxml-text">city-name</span><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">big</span><span class="org-nxml-tag-delimiter">&gt;</span>
  <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">big</span><span class="org-nxml-tag-delimiter">&gt;</span><span class="org-nxml-text">city-name</span><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">big</span><span class="org-nxml-tag-delimiter">&gt;</span>
<span class="org-nxml-text">  ...</span>
<span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">country</span><span class="org-nxml-tag-delimiter">&gt;</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-xquery">for $country in doc("countries.xml")//country
let $c := &lt;country&gt;
              { $country/@name }
              { for $city in $country/city
                where $city/population &gt; 7000000
                return &lt;big&gt;{data($city/name)}&lt;/big&gt; }
          &lt;/country&gt;
return $c[big]
</pre>
</div>

<p>
Return all countries where at least one language is listed, but the<br />
total percentage for all listed languages is less than 90%.  Return the<br />
country element with its name attribute and its language subelements,<br />
but no other attributes or subelements.<br />
</p>

<div class="org-src-container">
<pre class="src src-xquery">for $country in doc("countries.xml")//country[language]
where sum($country/language/@percentage) &lt; 90
return &lt;country&gt;
           { $country/@name }
           { $country/language }
       &lt;/country&gt;
</pre>
</div>

<p>
Return all countries where at least one language is listed, and every<br />
listed language is spoken by less than 20% of the population.  Return<br />
the country element with its name attribute and its language<br />
subelements, but no other attributes or subelements.<br />
</p>

<div class="org-src-container">
<pre class="src src-xquery">for $country in doc("countries.xml")//country[language]
where every $lang in $country/language
      satisfies $lang/@percentage &lt; 20
return &lt;country&gt;
           { $country/@name }
           { $country/language }
       &lt;/country&gt;
</pre>
</div>

<p>
Find all situations where one country's most popular language is<br />
another country's least popular, and both countries list more than one<br />
language.  (Hint: You may need to explicitly cast percentages as<br />
floating-point numbers with xs:float() to get the correct answer.)<br />
Return the name of the language and the two countries, each in the<br />
format:<br />
</p>

<div class="org-src-container">
<pre class="src src-xml"><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">LangPair</span> <span class="org-nxml-attribute-local-name">language</span>=<span class="org-nxml-attribute-value-delimiter">"</span><span class="org-nxml-attribute-value">lang-name</span><span class="org-nxml-attribute-value-delimiter">"</span><span class="org-nxml-tag-delimiter">&gt;</span>
  <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">MostPopular</span><span class="org-nxml-tag-delimiter">&gt;</span><span class="org-nxml-text">country-name</span><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">MostPopular</span><span class="org-nxml-tag-delimiter">&gt;</span>
  <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">LeastPopular</span><span class="org-nxml-tag-delimiter">&gt;</span><span class="org-nxml-text">country-name</span><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">LeastPopular</span><span class="org-nxml-tag-delimiter">&gt;</span>
<span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">LangPair</span><span class="org-nxml-tag-delimiter">&gt;</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-xquery">let $countries := doc("countries.xml")//country[count(language) &gt; 1]
for $c in $countries
for $lang in $c/language
where every $lang2 in $c/language
      satisfies xs:float($lang/@percentage) &gt;= $lang2/@percentage
return (&lt;LangPair language="{$lang}"&gt;
            &lt;MostPopular&gt;{data($c/@name)}&lt;/MostPopular&gt;
            { for $c2 in $countries[language = $lang]
              let $lang3 := $c2/language[. = $lang]
              where every $lang2 in $c2/language
                    satisfies xs:float($lang3/@percentage) &lt;= $lang2/@percentage
              return &lt;LeastPopular&gt; {data($c2/@name)}&lt;/LeastPopular&gt; }
        &lt;/LangPair&gt;)[LeastPopular]
</pre>
</div>

<div class="org-src-container">
<pre class="src src-xquery">let $countries :=
    for $c in doc("countries.xml")//country[count(language) &gt; 1]
    let $most_lang :=
        for $lang in $c/language
        where every $lang2 in $c/language
              satisfies xs:float($lang/@percentage) &gt;= $lang2/@percentage
        return &lt;MostPopular&gt;{data($lang)}&lt;/MostPopular&gt;
    let $least_lang :=
        for $lang in $c/language
        where every $lang2 in $c/language
              satisfies xs:float($lang/@percentage) &lt;= $lang2/@percentage
        return &lt;LeastPopular&gt;{data($lang)}&lt;/LeastPopular&gt;
    return &lt;country&gt;
               {$c/@name}
               {$most_lang}
               {$least_lang}
           &lt;/country&gt;
for $c1 in $countries
for $c2 in $countries
where $c1/MostPopular = $c2/LeastPopular
return &lt;LangPair language="{$c1/MostPopular}"&gt;
           &lt;MostPopular&gt;{data($c1/@name)}&lt;/MostPopular&gt;
           &lt;LeastPopular&gt;{data($c2/@name)}&lt;/LeastPopular&gt;
       &lt;/LangPair&gt;
</pre>
</div>

<p>
For each language spoken in one or more countries, create a "language"<br />
element with a "name" attribute and one "country" subelement for each<br />
country in which the language is spoken.  The "country" subelements<br />
should have two attributes: the country "name", and "speakers"<br />
containing the number of speakers of that language (based on language<br />
percentage and the country's population).  Order the result by<br />
language name, and enclose the entire list in a single "languages"<br />
element.  For example, your result might look like:<br />
</p>

<div class="org-src-container">
<pre class="src src-xml"><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">languages</span><span class="org-nxml-tag-delimiter">&gt;</span>
<span class="org-nxml-text">  ...</span>
<span class="org-nxml-text">  </span><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">language</span> <span class="org-nxml-attribute-local-name">name</span>=<span class="org-nxml-attribute-value-delimiter">"</span><span class="org-nxml-attribute-value">Arabic</span><span class="org-nxml-attribute-value-delimiter">"</span><span class="org-nxml-tag-delimiter">&gt;</span>
    <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">country</span> <span class="org-nxml-attribute-local-name">name</span>=<span class="org-nxml-attribute-value-delimiter">"</span><span class="org-nxml-attribute-value">Iran</span><span class="org-nxml-attribute-value-delimiter">"</span> <span class="org-nxml-attribute-local-name">speakers</span>=<span class="org-nxml-attribute-value-delimiter">"</span><span class="org-nxml-attribute-value">660942</span><span class="org-nxml-attribute-value-delimiter">"</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-tag-delimiter">&gt;</span>
    <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">country</span> <span class="org-nxml-attribute-local-name">name</span>=<span class="org-nxml-attribute-value-delimiter">"</span><span class="org-nxml-attribute-value">Saudi Arabia</span><span class="org-nxml-attribute-value-delimiter">"</span> <span class="org-nxml-attribute-local-name">speakers</span>=<span class="org-nxml-attribute-value-delimiter">"</span><span class="org-nxml-attribute-value">19409058</span><span class="org-nxml-attribute-value-delimiter">"</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-tag-delimiter">&gt;</span>
    <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">country</span> <span class="org-nxml-attribute-local-name">name</span>=<span class="org-nxml-attribute-value-delimiter">"</span><span class="org-nxml-attribute-value">Yemen</span><span class="org-nxml-attribute-value-delimiter">"</span> <span class="org-nxml-attribute-local-name">speakers</span>=<span class="org-nxml-attribute-value-delimiter">"</span><span class="org-nxml-attribute-value">13483178</span><span class="org-nxml-attribute-value-delimiter">"</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-tag-delimiter">&gt;</span>
  <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">language</span><span class="org-nxml-tag-delimiter">&gt;</span>
<span class="org-nxml-text">  ...</span>
<span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">languages</span><span class="org-nxml-tag-delimiter">&gt;</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-xquery">&lt;languages&gt;
    { for $lang in distinct-values(doc("countries.xml")//language)
      order by $lang
      return &lt;language name="{$lang}"&gt;
                 { for $c in doc("countries.xml")//country[language = $lang]
                   return &lt;country name="{$c/@name}"
                                   speakers="{xs:int(
                                       $c/language[. = $lang]/@percentage
                                           div 100 * $c/@population)}"&gt;
                          &lt;/country&gt; }
             &lt;/language&gt; }
&lt;/languages&gt;
</pre>
</div>
</div>
</div>
</div>
</div>


<div id="outline-container-org7d42edd" class="outline-2">
<h2 id="org7d42edd"><span class="section-number-2">3</span> <span class="done DONE">DONE</span> <a href="https://lagunita.stanford.edu/courses/DB/XSLT/SelfPaced/courseware/ch-querying_xml/">XSLT</a> mini-course</h2>
<div class="outline-text-2" id="text-3">
</div>
<div id="outline-container-orgfe254ab" class="outline-3">
<h3 id="orgfe254ab"><span class="section-number-3">3.1</span> <span class="done DONE">DONE</span> Lecture videos</h3>
<div class="outline-text-3" id="text-3-1">
<p>
XSL = Extensible Stylesheet Language<br />
XSLT = XSL (with) transformations<br />
</p>

<p>
XSLT is more widely used than XSL.<br />
</p>

<p>
XSLT: Rule-Based Transformations<br />
</p>

<p>
Match template and replace<br />
Recursively match template<br />
Extract values<br />
Iteration (for-each)<br />
Conditionals (if)<br />
</p>

<p>
Strange default/whitespace behavior<br />
Implicit template priority scheme<br />
</p>
</div>
</div>

<div id="outline-container-org4cde76c" class="outline-3">
<h3 id="org4cde76c"><span class="section-number-3">3.2</span> <span class="done DONE">DONE</span> Exercises</h3>
<div class="outline-text-3" id="text-3-2">
</div>
<div id="outline-container-org25a75fe" class="outline-4">
<h4 id="org25a75fe"><span class="section-number-4">3.2.1</span> <span class="done DONE">DONE</span> Course-Catalog XSLT</h4>
<div class="outline-text-4" id="text-3-2-1">
<p>
Return a list of department titles.<br />
</p>

<p>
Your solution should fill in the following stylesheet:<br />
</p>

<div class="org-src-container">
<pre class="src src-xslt">&lt;?xml version="1.0" encoding="ISO-8859-1"?&gt;
&lt;xsl:stylesheet version="2.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform"&gt;
    &lt;xsl:template match=...&gt;
        ... template body ...
    &lt;/xsl:template&gt;
    ... more templates as needed ...
&lt;/xsl:stylesheet&gt;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-xslt">&lt;?xml version="1.0" encoding="ISO-8859-1"?&gt;
&lt;xsl:stylesheet version="2.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform"&gt;
    &lt;xsl:template match="Department/Title"&gt;
        &lt;xsl:copy-of select="."/&gt;
    &lt;/xsl:template&gt;
    &lt;xsl:template match="text()"/&gt;
&lt;/xsl:stylesheet&gt;
</pre>
</div>

<p>
Return a list of department elements with no attributes and two<br />
subelements each: the department title and the entire Chair subelement<br />
structure.<br />
</p>

<div class="org-src-container">
<pre class="src src-xslt">&lt;?xml version="1.0" encoding="ISO-8859-1"?&gt;
&lt;xsl:stylesheet version="2.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform"&gt;
    &lt;xsl:template match="Department"&gt;
      &lt;Department&gt;
        &lt;xsl:copy-of select="Title"/&gt;
        &lt;xsl:copy-of select="Chair"/&gt;
      &lt;/Department&gt;
    &lt;/xsl:template&gt;
    &lt;xsl:template match="text()"/&gt;
&lt;/xsl:stylesheet&gt;
</pre>
</div>
</div>
</div>

<div id="outline-container-org1be131f" class="outline-4">
<h4 id="org1be131f"><span class="section-number-4">3.2.2</span> <span class="done DONE">DONE</span> Course-Catalog XSLT Extras</h4>
<div class="outline-text-4" id="text-3-2-2">
<p>
Return all courses with enrollment greater than 500.  Retain the<br />
structure of Course elements from the original data.<br />
</p>

<div class="org-src-container">
<pre class="src src-xslt">&lt;?xml version="1.0" encoding="ISO-8859-1"?&gt;
&lt;xsl:stylesheet version="2.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform"&gt;
  &lt;xsl:template match="Course[@Enrollment &amp;gt; 500]"&gt;
    &lt;xsl:copy-of select="."/&gt;
  &lt;/xsl:template&gt;
  &lt;xsl:template match="text()"/&gt;
&lt;/xsl:stylesheet&gt;
</pre>
</div>

<p>
Remove from the data all courses with enrollment greater than 60, or<br />
with no enrollment listed.  Otherwise the structure of the data should<br />
be the same.<br />
</p>

<div class="org-src-container">
<pre class="src src-xslt">&lt;?xml version="1.0" encoding="ISO-8859-1"?&gt;
&lt;xsl:stylesheet version="2.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform"&gt;
  &lt;xsl:strip-space elements="*"/&gt;
  &lt;xsl:template match="*|@*|text()"&gt;
    &lt;xsl:copy&gt;
      &lt;xsl:apply-templates select="*|@*|text()"/&gt;
    &lt;/xsl:copy&gt;
  &lt;/xsl:template&gt;
  &lt;xsl:template match="Course[not(@Enrollment) or @Enrollment &amp;gt; 60]"/&gt;
&lt;/xsl:stylesheet&gt;
</pre>
</div>

<p>
Create a summarized version of the EE part of the course catalog.  For<br />
each course in EE, return a Course element, with its Number and Title<br />
as attributes, its Description as a subelement, and the last name of<br />
each instructor as an Instructor subelement.  Discard all information<br />
about department titles, chairs, enrollment, and prerequisites, as<br />
well as all courses in departments other than EE.  (Note: To specify<br />
quotes within an already-quoted XPath expression, use quot;.)<br />
</p>

<div class="org-src-container">
<pre class="src src-xslt">&lt;?xml version="1.0" encoding="ISO-8859-1"?&gt;
&lt;xsl:stylesheet version="2.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform"&gt;
  &lt;xsl:template match="Department[@Code='EE']"&gt;
    &lt;xsl:for-each select="Course"&gt;
      &lt;Course Number="{@Number}"
              Title="{Title}"&gt;
        &lt;xsl:copy-of select="Description"/&gt;
        &lt;xsl:for-each select="Instructors//Last_Name"&gt;
          &lt;Instructor&gt;&lt;xsl:value-of select="."/&gt;&lt;/Instructor&gt;
        &lt;/xsl:for-each&gt;
      &lt;/Course&gt;
    &lt;/xsl:for-each&gt;
  &lt;/xsl:template&gt;
  &lt;xsl:template match="text()"/&gt;
&lt;/xsl:stylesheet&gt;
</pre>
</div>

<p>
Create an HTML table with one-pixel border that lists all CS<br />
department courses with enrollment greater than 200.  Each row should<br />
contain three cells: the course number in italics, course title in<br />
bold, and enrollment.  Sort the rows alphabetically by course title.<br />
No header is needed.  (Note: For formatting, just use "table<br />
border=1", and "&lt;b&gt;" and "&lt;i&gt;" tags for bold and italics respectively.<br />
To specify quotes within an already-quoted XPath expression, use<br />
quot;.)<br />
</p>

<div class="org-src-container">
<pre class="src src-xslt">&lt;?xml version="1.0" encoding="ISO-8859-1"?&gt;
&lt;xsl:stylesheet version="2.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform"&gt;
  &lt;xsl:template match="Department[@Code='CS']"&gt;
    &lt;table border="1"&gt;
      &lt;xsl:for-each select="Course[@Enrollment &amp;gt; 200]"&gt;
        &lt;xsl:sort select="Title"/&gt;
        &lt;tr&gt;
          &lt;td&gt;&lt;i&gt;&lt;xsl:value-of select="@Number"/&gt;&lt;/i&gt;&lt;/td&gt;
          &lt;td&gt;&lt;b&gt;&lt;xsl:value-of select="Title"/&gt;&lt;/b&gt;&lt;/td&gt;
          &lt;td&gt;&lt;xsl:value-of select="@Enrollment"/&gt;&lt;/td&gt;
        &lt;/tr&gt;
      &lt;/xsl:for-each&gt;
    &lt;/table&gt;
  &lt;/xsl:template&gt;
  &lt;xsl:template match="text()"/&gt;
&lt;/xsl:stylesheet&gt;
</pre>
</div>
</div>
</div>

<div id="outline-container-org780b9bd" class="outline-4">
<h4 id="org780b9bd"><span class="section-number-4">3.2.3</span> <span class="done DONE">DONE</span> World-Countries XSLT</h4>
<div class="outline-text-4" id="text-3-2-3">
<p>
Return all countries with population between 9 and 10 million.  Retain<br />
the structure of country elements from the original data.<br />
</p>

<div class="org-src-container">
<pre class="src src-xslt">&lt;?xml version="1.0" encoding="ISO-8859-1"?&gt;
&lt;xsl:stylesheet version="2.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform"&gt;
  &lt;xsl:template match="country[9000000 &amp;lt;= @population and @population &amp;lt;= 10000000]"&gt;
    &lt;xsl:copy-of select="."/&gt;
  &lt;/xsl:template&gt;
  &lt;xsl:template match="text()"/&gt;
&lt;/xsl:stylesheet&gt;
</pre>
</div>

<p>
Create a table using HTML constructs that lists all countries that<br />
have more than 3 languages.  Each row should contain the country name<br />
in bold, population, area, and number of languages.  Sort the rows in<br />
descending order of number of languages.  No header is needed for the<br />
table, but use &lt;table border="1"&gt; to make it format nicely, should you<br />
choose to check your result in a browser.  (Hint: You may find the<br />
data-type and order attributes of &lt;xsl:sort&gt; to be useful.)<br />
</p>

<div class="org-src-container">
<pre class="src src-xlst">&lt;?xml version="1.0" encoding="ISO-8859-1"?&gt;
&lt;xsl:stylesheet version="2.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform"&gt;
  &lt;xsl:template match="countries"&gt;
    &lt;html&gt;
      &lt;table border="1"&gt;
        &lt;xsl:for-each select="country[count(language) &amp;gt; 3]"&gt;
          &lt;xsl:sort select="count(language)"
                    order="descending"/&gt;
          &lt;tr&gt;
            &lt;td&gt;&lt;b&gt;&lt;xsl:value-of select="@name"/&gt;&lt;/b&gt;&lt;/td&gt;
            &lt;td&gt;&lt;xsl:value-of select="@population"/&gt;&lt;/td&gt;
            &lt;td&gt;&lt;xsl:value-of select="@area"/&gt;&lt;/td&gt;
            &lt;td&gt;&lt;xsl:value-of select="count(language)"/&gt;&lt;/td&gt;
          &lt;/tr&gt;
        &lt;/xsl:for-each&gt;
      &lt;/table&gt;
    &lt;/html&gt;
  &lt;/xsl:template&gt;
  &lt;xsl:template match="text()"/&gt;
&lt;/xsl:stylesheet&gt;
</pre>
</div>

<p>
Create an alternate version of the countries database: for each<br />
country, include its name and population as sublements, and the number<br />
of languages and number of cities as attributes (called "languages"<br />
and "cities" respectively).<br />
</p>

<div class="org-src-container">
<pre class="src src-xslt">&lt;?xml version="1.0" encoding="ISO-8859-1"?&gt;
&lt;xsl:stylesheet version="2.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform"&gt;
  &lt;xsl:template match="*|@*|text()"&gt;
    &lt;xsl:copy&gt;
      &lt;xsl:apply-templates select="*|@*|text()"/&gt;
    &lt;/xsl:copy&gt;
  &lt;/xsl:template&gt;
  &lt;xsl:template match="country"&gt;
    &lt;country languages="{count(language)}"
             cities="{count(city)}"&gt;
      &lt;name&gt;&lt;xsl:value-of select="@name"/&gt;&lt;/name&gt;
      &lt;population&gt;&lt;xsl:value-of select="@population"/&gt;&lt;/population&gt;
    &lt;/country&gt;
  &lt;/xsl:template&gt;
&lt;/xsl:stylesheet&gt;
</pre>
</div>
</div>
</div>

<div id="outline-container-orgebe2682" class="outline-4">
<h4 id="orgebe2682"><span class="section-number-4">3.2.4</span> <span class="done DONE">DONE</span> World-Countries XSLT Extras</h4>
<div class="outline-text-4" id="text-3-2-4">
<p>
Find all country names containing the string "stan"; return each one<br />
within a "Stan" element.  (Note: To specify quotes within an<br />
already-quoted XPath expression, use quot;.)<br />
</p>

<div class="org-src-container">
<pre class="src src-xslt">&lt;?xml version="1.0" encoding="ISO-8859-1"?&gt;
&lt;xsl:stylesheet version="2.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform"&gt;
  &lt;xsl:template match="country[contains(@name, 'stan')]"&gt;
    &lt;Stan&gt;&lt;xsl:value-of select="@name"/&gt;&lt;/Stan&gt;
  &lt;/xsl:template&gt;
  &lt;xsl:template match="text()"/&gt;
&lt;/xsl:stylesheet&gt;
</pre>
</div>

<p>
Remove from the data all countries with area greater than 40,000 and<br />
all countries with no cities listed.  Otherwise the structure of the<br />
data should be the same.<br />
</p>

<div class="org-src-container">
<pre class="src src-xslt">&lt;?xml version="1.0" encoding="ISO-8859-1"?&gt;
&lt;xsl:stylesheet version="2.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform"&gt;
  &lt;xsl:strip-space elements="*"/&gt;
  &lt;xsl:template match="*|@*|text()"&gt;
    &lt;xsl:copy&gt;
      &lt;xsl:apply-templates select="*|@*|text()"/&gt;
    &lt;/xsl:copy&gt;
  &lt;/xsl:template&gt;
  &lt;xsl:template match="country[@area &amp;gt; 40000 or not(city)]"/&gt;
&lt;/xsl:stylesheet&gt;
</pre>
</div>
</div>
</div>
</div>
</div>


<div id="outline-container-org622db22" class="outline-2">
<h2 id="org622db22"><span class="section-number-2">4</span> <span class="done DONE">DONE</span> <a href="https://lagunita.stanford.edu/courses/DB/RD/SelfPaced/courseware/ch-relational_design_theory/">Relational Design Theory</a> mini-course</h2>
<div class="outline-text-2" id="text-4">
</div>
<div id="outline-container-org5d0317d" class="outline-3">
<h3 id="org5d0317d"><span class="section-number-3">4.1</span> <span class="done DONE">DONE</span> Lecture videos</h3>
<div class="outline-text-3" id="text-4-1">
</div>
<div id="outline-container-orge6a4fac" class="outline-4">
<h4 id="orge6a4fac"><span class="section-number-4">4.1.1</span> <span class="done DONE">DONE</span> Overview</h4>
<div class="outline-text-4" id="text-4-1-1">
<p>
Design "anomalies"<br />
  Redundancy<br />
  Update anomaly<br />
  Deletion anomaly<br />
</p>

<p>
Design by decomposition<br />
  Start with "mega" relations containing everything<br />
  Decompose into smaller, better relations with same info<br />
  Can do decomposition automatically<br />
</p>

<p>
Automatic decomposition<br />
  "Mega" relations + <i>properties of the data</i><br />
  System decomposes based on properties<br />
  Final set of relations satisfies <i>normal form</i><br />
</p>
<ul class="org-ul">
<li>No anomalies, no lost information<br /></li>
</ul>

<p>
Properites and Normal Forms<br />
  Functional dependencies =&gt; Boyce-Codd Normal Form<br />
</p>
<ul class="org-ul">
<li>Multivalued dependencies =&gt; Fourth Normal Form<br /></li>
</ul>

<p>
4NF subsets BCNF<br />
</p>

<p>
Functional Dependencies and BCNF<br />
  Apply(SSN, sName, cName)<br />
    Redundancy; Update &amp; Deletion Anomalies<br />
    Storing <span class="underline">SSN-sName</span> pair once for each college<br />
</p>

<p>
<i>Functional Dependency</i> <span class="underline">SSN -&gt; sName</span><br />
  Same <span class="underline">SSN</span> always has same <span class="underline">sName</span><br />
  Should store each <span class="underline">SSN</span>'s <span class="underline">sName</span> only once<br />
</p>

<p>
<i>Boyce-Codd Normal Form</i> If <span class="underline">A -&gt; B</span> then <span class="underline">A</span> is a key<br />
</p>

<p>
<span class="underline">SSN</span> should be a key but not.<br />
</p>

<p>
Decompose: <span class="underline">Student(SSN, sName) Apply(SSN, cName)</span><br />
Pull out SSN and sName into its own relation<br />
</p>

<p>
Multivalued Dependencies and 4NF<br />
  Apply(SSN, cName, HS)<br />
    Redundancy; Update &amp; Deletion Anomalies<br />
    Multiplicative effect<br />
      C colleges, H high school<br />
      C * H tuples<br />
      Should be C + H<br />
    Not addressed by BCNF: No functional dependencies<br />
</p>

<p>
<i>Multivalued Dependency</i> <span class="underline">SSN -&gt;&gt; cName  SSN -&gt;&gt; HS</span><br />
  Given <span class="underline">SSN</span> has every combination of <span class="underline">cName</span> with <span class="underline">HS</span><br />
  Should store each <span class="underline">cName</span> and each <span class="underline">HS</span> for an <span class="underline">SSN</span> once<br />
</p>

<p>
<i>Fourth Normal Form</i> If <span class="underline">A -&gt;&gt; B</span> then <span class="underline">A</span> is a key<br />
</p>

<p>
Decompose: <span class="underline">Apply(SSN, cName) HighSchool(SSN, HS)</span><br />
</p>
</div>
</div>

<div id="outline-container-orga2368fd" class="outline-4">
<h4 id="orga2368fd"><span class="section-number-4">4.1.2</span> <span class="done DONE">DONE</span> Functional Dependencies</h4>
<div class="outline-text-4" id="text-4-1-2">
<p>
Functional dependencies =&gt; Boyce-Codd Normal Form<br />
Multivalued dependencies =&gt; Fourth Normal Form<br />
</p>

<p>
Functional dependencies are generally useful concepts<br />
  Data storage - compression<br />
  Reasoning about queries - optimization<br />
</p>

<p>
Functional dependencies generalizes keys.<br />
</p>

<p>
Student(SS, sName, address,<br />
        HScode, HSname, HScity, GPA, priority)<br />
</p>

<p>
Suppose priority is determined by GPA<br />
</p>

<p>
Two tuples with same GPA have same priority<br />
</p>

<p>
for t, u in student:<br />
    t.GPA = u.GPA =&gt; t.priorty = u.priority<br />
</p>

<p>
GPA -&gt; priority<br />
</p>

<p>
for t, u in R:<br />
    t[A1, &#x2026;, An] = u[A1, &#x2026;, An] =&gt; t[B1, &#x2026;, Bn] = u[B1, &#x2026;, Bn]<br />
</p>

<p>
A1, &#x2026;, An -&gt; B1, &#x2026;, Bn<br />
</p>

<p>
\bar{A} -&gt; \bar{B}<br />
</p>

<p>
SSN -&gt; sName<br />
SSN -&gt; address (assume students don't work)<br />
HScode -&gt; HSname, HScity<br />
HSname, HScity -&gt; HScode (assume no schools with same name in the same city)<br />
</p>

<p>
SSN -&gt; GPA<br />
GPA -&gt; priority<br />
SSN -&gt; priority<br />
</p>

<p>
transitivity<br />
</p>

<p>
Apply(SSN, cName, state, date, major)<br />
</p>

<p>
cName -&gt; date<br />
SSN, cName -&gt; major<br />
</p>

<p>
SSN -&gt; state<br />
</p>

<p>
Functional Dependencies and Keys<br />
</p>

<p>
R(\bar{A}, \bar{B})<br />
</p>

<p>
Trivial Functional Dependency<br />
</p>

<p>
\bar{A} -&gt; \bar{B},  \bar{B} subset \bar{A}<br />
</p>

<p>
Nontrivial FD<br />
\bar{A} -&gt; \bar{B},  \bar{B} not subset \bar{A}<br />
</p>

<p>
Completely nontrivial FD (most interested)<br />
A -&gt; B, A intersect B = empty set<br />
</p>

<p>
Splitting rule<br />
</p>

<p>
\bar{A} -&gt; B1, B2, &#x2026;, Bm<br />
=&gt; \bar{A} -&gt; B1, \bar{A} -&gt; B2, &#x2026;<br />
</p>

<p>
Combining rule<br />
</p>

<p>
\bar{A} -&gt; B1<br />
\bar{A} -&gt; B2<br />
&#x2026;<br />
=&gt; \bar{A} -&gt; B1, B2, &#x2026;, Bn<br />
</p>

<p>
Trivial-dependency rules<br />
</p>

<p>
A -&gt; B, then A -&gt; A union B<br />
</p>

<p>
A -&gt; B, then A -&gt; A intersect B<br />
</p>

<p>
Transitive rule<br />
</p>

<p>
A -&gt; B, B -&gt; C, then A -&gt; C<br />
</p>

<p>
Closure of Attributes<br />
  Given relations, FDs, set of attributes \bar{A}<br />
  Find all B such that \bar{A} -&gt; B<br />
</p>

<p>
\bar{A}^+<br />
</p>

<p>
apply transitive rule repeatedly to get the closure<br />
</p>

<p>
if \bar{A}^+ = all attrs, then \bar{A} is a key.<br />
</p>

<p>
Grow algorithms can be used to find all keys given a set of FDs.<br />
</p>

<p>
If \bar{A} is a key, then all its supersets are keys.  Hence, we are<br />
often only interested the smallest key.<br />
</p>

<p>
Specifying FDs for a relation<br />
  S1 and S2 sets of FDs<br />
  S2 "follows from" S1 if every relation instance<br />
  satisfying S1 also satisfies S2<br />
</p>

<p>
S2: {SSN -&gt; priority}<br />
S1: {SSN -&gt; GPA, GPA -&gt; priority}<br />
</p>

<p>
Does A -&gt; B follow from S?<br />
</p>

<p>
(1) A+ based S check if B in set.<br />
(2) Armstrong's Axioms<br />
</p>

<p>
Want: <span class="underline">Minimal</span> set of <span class="underline">completely nontrivial</span> FDs such that <span class="underline">all FDs</span> that<br />
hold on the relation follow from the dependencies in this set<br />
</p>
</div>
</div>

<div id="outline-container-org06acf8c" class="outline-4">
<h4 id="org06acf8c"><span class="section-number-4">4.1.3</span> <span class="done DONE">DONE</span> Boyce-Codd Normal Form</h4>
<div class="outline-text-4" id="text-4-1-3">
<p>
Decomposition of a relational schema<br />
R(A1, &#x2026;, An)<br />
R1(B1, &#x2026;, Bk)<br />
R2(C1, &#x2026;, Cm)<br />
</p>

<p>
B union C = A<br />
</p>

<p>
R1 natural join R2 = R<br />
</p>

<p>
Student(SSN, sName, address, HScode, HSname, HScity, GPA, priority)<br />
</p>

<p>
This is a decomposition.<br />
S1(SSN, sName, address, HScode, GPA, priority)<br />
S2(HScode, HSname, HScity)<br />
</p>

<p>
This is not a decomposition.<br />
S1(SSN, sName, address, HScode, HSname, HScity)<br />
S2(sName, HSname, GPA, priority)<br />
</p>

<p>
Good decomposition exhibits lossless join property.<br />
</p>

<p>
BCNF<br />
Relation R with FDs is in BCNR if:<br />
    For each \bar{A} -&gt; B, \bar{A} is a key.<br />
    BCNF violation (redundancy, update/delete anomalies)<br />
</p>

<p>
note: a key can contain another key and thus is a super key.<br />
</p>

<p>
BCNF decomposition algorithm<br />
</p>

<p>
Input: relation R + FDs for R<br />
Output: decomposition of R into BCNF relations with "lossless join"<br />
</p>

<p>
Compute keys for R<br />
Repeat until all relations are in BCNF<br />
    Pick any R' with A -&gt; B that violates BCNF<br />
    Decompose R' into R1(A, B) and R2(A, rest)<br />
    Compute FDs for R1 and R2<br />
    Compute keys for R1 and R2<br />
</p>

<p>
Randomness can result in different answer.<br />
We can extend A -&gt; BA+<br />
</p>
</div>
</div>

<div id="outline-container-org4169027" class="outline-4">
<h4 id="org4169027"><span class="section-number-4">4.1.4</span> <span class="done DONE">DONE</span> Multivalued Dependencies and 4th Normal Form</h4>
<div class="outline-text-4" id="text-4-1-4">
<p>
Fourth Normal Form subsets Boyce-Codd Normal Form<br />
R  \bar{A} -&gt;&gt; \bar{B}  A1, &#x2026;, An, B1, &#x2026;, Bn<br />
</p>

<p>
for all t, u in R: t[\bar{A}] = u[\bar{A}] then<br />
    there exists v in R: v[\bar{A}] = t[\bar{A}] and<br />
                         v[\bar{B}] = t[\bar{B}] and<br />
                         v[rest] = u[rest]<br />
</p>

<p>
Tuple-generating dependencies<br />
</p>

<p>
\bar{A} -&gt;&gt; \bar{B} implies \bar{A} -&gt;&gt; rest<br />
</p>

<p>
Trivial Multivalued Dependency<br />
</p>

<p>
A -&gt;&gt; B   B subset A or  A union B = all attrs<br />
</p>

<p>
A -&gt; B implies A -&gt;&gt; B<br />
</p>

<p>
FD-is-an-MVD rule<br />
</p>

<p>
4NF implies BCNF<br />
</p>

<p>
Intersection rule<br />
A -&gt;&gt; B, A -&gt;&gt; C then A -&gt;&gt; B intersect C<br />
</p>

<p>
Transitive rule<br />
A -&gt;&gt; B, B -&gt;&gt; C then A -&gt;&gt; C - B<br />
</p>

<p>
Fourth Normal Form<br />
</p>

<p>
Relation R with MVDs is in 4NF if:<br />
    For each nontrivial A -&gt;&gt; B, A is a key<br />
</p>
</div>
</div>

<div id="outline-container-org78a54f0" class="outline-4">
<h4 id="org78a54f0"><span class="section-number-4">4.1.5</span> <span class="done DONE">DONE</span> Shortcomings of BCNF/4NF</h4>
</div>
</div>

<div id="outline-container-orga7779c2" class="outline-3">
<h3 id="orga7779c2"><span class="section-number-3">4.2</span> <span class="done DONE">DONE</span> Exercises</h3>
<div class="outline-text-3" id="text-4-2">
<p>
R(A,B)<br />
<del>R(A,C,D)</del><br />
R(A,C)<br />
R(C,D)<br />
</p>

<p>
R(C,D)<br />
<del>R(A,B,C)</del><br />
R(A,B)<br />
R(A,C)<br />
</p>

<p>
R(B,C)<br />
<del>R(A,B,D)</del><br />
R(A,B)<br />
R(A,D)<br />
</p>
</div>
</div>
</div>


<div id="outline-container-orgccfc649" class="outline-2">
<h2 id="orgccfc649"><span class="section-number-2">5</span> <span class="done DONE">DONE</span> <a href="https://lagunita.stanford.edu/courses/DB/UML/SelfPaced/courseware/ch-unified_modeling_language/">Unified Modeling Language</a> mini-course</h2>
<div class="outline-text-2" id="text-5">
</div>
<div id="outline-container-orge5ff558" class="outline-3">
<h3 id="orge5ff558"><span class="section-number-3">5.1</span> <span class="done DONE">DONE</span> Lecture Videos</h3>
<div class="outline-text-3" id="text-5-1">
</div>
<div id="outline-container-orgf45479a" class="outline-4">
<h4 id="orgf45479a"><span class="section-number-4">5.1.1</span> <span class="done DONE">DONE</span> UML Data Modeling</h4>
<div class="outline-text-4" id="text-5-1-1">
<p>
Entity-Relationship Model (E/R)<br />
Unified Modeling Language<br />
  Data modeling subset<br />
</p>

<p>
Both are graphical<br />
Both can be translated to relations automatically<br />
  Or semi-automatically<br />
</p>

<p>
UML Data Modeling: 5 concepts<br />
</p>

<ol class="org-ol">
<li>Classes<br /></li>
<li>Associations<br /></li>
<li>Association Classes<br /></li>
<li>Subclasses<br /></li>
<li>Composition &amp; Aggregation<br /></li>
</ol>


<p>
Classes<br />
</p>

<p>
Name, attributes, methods<br />
  For data modeling: add "pk", drop methods<br />
</p>

<div class="org-src-container">
<pre class="src src-uml">|-----------|
|  Student  |
|-----------|
| sID    pk |
| sName     |
| GPA       |
|-----------|
| &lt;methods&gt; |
|-----------|

|-----------|
| College   |
|-----------|
| cName  pk |
| state     |
|-----------|
| &lt;methods&gt; |
|-----------|
</pre>
</div>

<p>
Relationships between objects of two classes<br />
</p>

<div class="org-src-container">
<pre class="src src-uml">|-----------|           |-----------|
|  Student  |           | College   |
|-----------|  Applied  |-----------|
| sID    pk |-----------| cName  pk |
| sName     |         ‣ | state     |
| GPA       |           |-----------|
|-----------|           | &lt;methods&gt; |
| &lt;methods&gt; |           |-----------|
|-----------|
</pre>
</div>

<p>
Multiplicity of Associations<br />
</p>

<p>
Each object of class C1 is related to at least m and at most n objects<br />
of class C2<br />
</p>

<pre class="example">
|----|                |----|
| C1 |                | C2 |
|----|        m..n    |----|
|    |----------------|    |
|----|      A         |----|
</pre>

<p>
m..* at least m<br />
0..n at most n<br />
0..* no restrictions<br />
</p>

<p>
the default is 1..1<br />
</p>

<p>
1..1 abbreviated as 1<br />
0..* abbreviated as *<br />
</p>

<p>
Students must apply somewhere and may not apply to more than 5<br />
colleges.  No college takes more than 20,000 applications.<br />
</p>

<div class="org-src-container">
<pre class="src src-uml">|-----------|                   |-----------|
|  Student  |                   | College   |
|-----------| 0..20000     1..5 |-----------|
| sID    pk |-------------------| cName  pk |
| sName     |      Applied      | state     |
| GPA       |                   |-----------|
|-----------|                   | &lt;methods&gt; |
| &lt;methods&gt; |                   |-----------|
|-----------|
</pre>
</div>

<p>
Types of relationships<br />
</p>

<p>
One-to-One           0..1  0..1<br />
Many-to-One          *     0..1<br />
Many-to-Many         *     *<br />
Complete             1..   1..<br />
</p>

<p>
Default is complete one-to-one<br />
</p>


<p>
Association Classses<br />
</p>

<p>
Relationships between objects of two classes,<br />
with attributes on relationshps<br />
</p>

<div class="org-src-container">
<pre class="src src-uml">|-----------|                          |-----------|
|  Student  |                          | College   |
|-----------|        Applied           |-----------|
| sID    pk |--------------------------| cName  pk |
| sName     |           |              | state     |
| GPA       |      |----------|        |-----------|
|-----------|      | AppInfo  |        | &lt;methods&gt; |
| &lt;methods&gt; |      |----------|        |-----------|
|-----------|      | date     |
                   | decision |
                   |----------|
</pre>
</div>

<p>
It's hard to have more than one relationship association between the<br />
same student and college.<br />
</p>

<p>
Eliminating Association Classes<br />
Unnecessary if 0..1 or 1..1 multiplicity<br />
</p>

<div class="org-src-container">
<pre class="src src-uml">|----|                |----|
| C1 |                | C2 |
|----| *         1..1 |----|
| A3 |----------------| A4 |
|----|       |        |----|
           |----|
           | AC |
           |----|
           | A1 |
           | A2 |
           |----|
</pre>
</div>

<p>
Self-Associations<br />
</p>

<p>
Associations between a class and itself<br />
</p>

<div class="org-src-container">
<pre class="src src-uml">|---------|
| Student |*
|---------|-----|
|         |*    | Sibling
|---------|-----|


|---------|
| College |home
|---------|------|
|         |1..1  | Branch
|         |0..10 |
|---------|------|
           Satellite
</pre>
</div>

<p>
Subclasses<br />
</p>

<div class="org-src-container">
<pre class="src src-uml">                    |---------|
                    | Student |  Superclass
                    |---------|  {complete, overlapping}
                    | sID  pk |
                    | sName   |
                    | GPA     |
                    |---------|
                         ↑ inherit
     |--------------------------------------|
     |                   |                  |
|----------|     |-----------|    |------------|                |------------|
| ForeignS |     | DomesticS |    | APStudents |                | APCourse   |
|----------|     |-----------|    |------------|     Took       |------------|
| Country  |     | State     |    |            |----------------| Course# pk |
|          |     | SSN       |    |            |1..*   |   1..10| title      |
|----------|     |-----------|    |------------|       |        | units      |
                                                       |        |------------|
                                                   |--------|
                                                   | APInfo |
                                                   |--------|
                                                   | year   |
                                                   | grade  |
                                                   |--------|
</pre>
</div>

<p>
Superclass = Generalization<br />
Subclass = Specialization<br />
</p>

<p>
Incomplete (Partial) vs. Complete<br />
</p>

<p>
Complete: every obj in the superclass is in at least one subclass<br />
</p>

<p>
Disjoint (Exclusive) vs. Overlapping<br />
</p>

<p>
Disjoint: every obj in the superclass is in at most one subclass<br />
</p>


<p>
Composition &amp; Aggregation<br />
</p>

<p>
Objects of one class belong to objects of another class<br />
</p>

<div class="org-src-container">
<pre class="src src-uml">|----------|               |------------|
| College  |               | Department |
|----------| 1..1          |------------|
| cName pk |◆--------------| dName      |
| state    |◇-------|      | building   |
|----------| 0..1   |      |------------|
                    |
               |-----------|
               | Apartment |
               |-----------|
               | addr pk   |
               | #units    |
               |-----------|
</pre>
</div>

<p>
The symbol ◆ indicates composition, implicitly specifying 1..1.<br />
Department belongs to College.<br />
</p>

<p>
The symbol ◇ indicates aggregation, implicitly specifying 0..1.<br />
Some apartments are owned by or associated with colleges, but not all<br />
of them are.<br />
</p>
</div>
</div>

<div id="outline-container-org53b0a5c" class="outline-4">
<h4 id="org53b0a5c"><span class="section-number-4">5.1.2</span> <span class="done DONE">DONE</span> UML to Relations</h4>
<div class="outline-text-4" id="text-5-1-2">
<p>
High-Level Database Design Model<br />
  User-friendly (graphical) specification language<br />
  Translated into model of DBMS<br />
</p>

<p>
Designs can be translated to relations automatically<br />
  Provided every "regular" class has a key<br />
</p>

<p>
Every class becomes a relation: pk -&gt; primary key<br />
</p>

<p>
Associations<br />
</p>

<p>
Relation with key from each side<br />
</p>

<p>
Applied(sID, cName)<br />
</p>

<p>
Keys for association relations depends on multiplicity<br />
</p>

<div class="org-src-container">
<pre class="src src-uml">|-------|                      |-------|
|  C1   |                      |  C2   |
|-------| 0..1               * |-------|
| K1 pk |----------------------| K2 pk |
| O1    |          A           | O2    |
|-------|                      |-------|
</pre>
</div>

<p>
C1(_K1_, O1)<br />
C2(_K2_, O2)<br />
</p>

<p>
A(K1, <span class="underline">K2</span>)<br />
</p>

<div class="org-src-container">
<pre class="src src-uml">|-----------|                          |-----------|
|  Student  |                          | College   |
|-----------| *      Applied     1..1  |-----------|
| sID    pk |--------------------------| cName  pk |
| sName     |           |              | state     |
| GPA       |      |----------|        |-----------|
|-----------|      | AppInfo  |        | &lt;methods&gt; |
| &lt;methods&gt; |      |----------|        |-----------|
|-----------|      | date     |
                   | decision |
                   |----------|
</pre>
</div>

<p>
Applied(_sID_, cName)<br />
</p>

<p>
C1(_K1_, O1)<br />
C2(_K2_, O2)  &lt;&#x2013; C2(_K2_, O2, K1)<br />
<del>A(K1, <span class="underline">K2</span>)</del><br />
</p>

<p>
Student(_sID_, sName, GPA)  &lt;&#x2013; Student(_sID_, sName, GPA, cName)<br />
College(_cName_, state)<br />
<del>Applied(_sID_, cName)</del><br />
</p>

<p>
Association Classes<br />
</p>

<p>
Student(_sID_, sName, GPA)<br />
College(_cName_, state)<br />
Applied(_sID_, cName, date, decision)<br />
</p>

<p>
Require a key for every "regular" class.<br />
</p>

<p>
Self-Associations<br />
</p>

<div class="org-src-container">
<pre class="src src-uml">|---------|
| Student |*
|---------|-----|
|         |*    | Sibling
|---------|-----|
</pre>
</div>


<p>
Student(_sID_, sName, GPA)<br />
Sibling(_sID1, sID2_)<br />
</p>

<div class="org-src-container">
<pre class="src src-uml">|----------|
| College  | home
|----------|-------|
| cName pk | 1..1  | Branch
| state    |       |
| enr      | 0..10 |
|----------|-------|
             Satellite
</pre>
</div>

<p>
College(_cName_, state, enr)<br />
Branch(home, <span class="underline">satellite</span>)<br />
</p>

<p>
College(_cName_, state, enr, home) ???<br />
</p>


<p>
Subclasses<br />
</p>
<ol class="org-ol">
<li>Subclass relations contain superclass key + specialized attrs.<br /></li>
<li>Subclass relations contain all attributes.<br /></li>
<li>One relation containing all superclass + subclass attrs.<br /></li>
</ol>

<p>
subclasses are not regular classes.<br />
</p>

<div class="org-src-container">
<pre class="src src-uml">                     |-------|
                     |   S   |  superclass
                     |-------|
                     | K  pk |
                     | A     |
                     |-------|
                         ↑                   Subclasses
   |---------------------+-------------------|
   |                                         |
|----|                                     |----|
| S1 |                                     | S2 |
|----|                                     |----|
| B  |                                     | C  |
|----|                                     |----|
</pre>
</div>

<ol class="org-ol">
<li>S(_K_, A), S1(_K_, B), S2(_K_, C)<br /></li>
<li>S(_K_, A), S1(_K_, A, B), S2(_K_, A, C)<br /></li>
<li>S(_K_, A, B, C)<br /></li>
</ol>

<p>
Heavily overlapping =&gt; design 3<br />
</p>

<p>
Disjoint, Complete =&gt; design 2 with S(_K_, A) discarded<br />
</p>

<div class="org-src-container">
<pre class="src src-uml">                    |---------|
                    | Student |  Superclass
                    |---------|  {complete, overlapping}
                    | sID  pk |
                    | sName   |
                    | GPA     |
                    |---------|
                         ↑ inherit
     |--------------------------------------|
     |                   |                  |
|----------|     |-----------|    |------------|                |------------|
| ForeignS |     | DomesticS |    | APStudents |                | APCourse   |
|----------|     |-----------|    |------------|     Took       |------------|
| Country  |     | State     |    |            |----------------| Course# pk |
|          |     | SSN    pk |    |            |1..*   |   1..10| title      |
|----------|     |-----------|    |------------|       |        | units      |
                                                       |        |------------|
                                                   |--------|
                                                   | APInfo |
                                                   |--------|
                                                   | year   |
                                                   | grade  |
                                                   |--------|
</pre>
</div>

<p>
Student(_sID_, sName)<br />
ForeignS(_sID_, Country)<br />
DomesticS(_sID_, State, <span class="underline">SSN</span>)<br />
<del>APStudent(sID)</del> &lt;&#x2013; eliminated, implicated in Took<br />
APCourse(_Course#_, title, units)<br />
Took(_sID, Course#_, year, grade)<br />
</p>

<p>
Composition &amp; Aggregation<br />
</p>

<div class="org-src-container">
<pre class="src src-uml">|----------|               |------------|
| College  |               | Department |
|----------| 1..1          |------------|
| cName pk |◆--------------| dName      | Not "regular"
| state    |◇-------|      | building   |
|----------| 0..1   |      |------------|
                    |
               |-----------|
               | Apartment |
               |-----------|
               | addr pk   |
               | #units    |
               |-----------|
</pre>
</div>

<p>
College(_cName_, state)<br />
Department(dName, building, <span class="underline">cName</span>)<br />
Apartment(_addr_, #units, cName)<br />
                            ↑<br />
                          nullable<br />
</p>
</div>
</div>
</div>

<div id="outline-container-orgc883a97" class="outline-3">
<h3 id="orgc883a97"><span class="section-number-3">5.2</span> <span class="done DONE">DONE</span> Exercises</h3>
</div>
</div>


<div id="outline-container-orga9a75d5" class="outline-2">
<h2 id="orga9a75d5"><span class="section-number-2">6</span> <span class="done DONE">DONE</span> <a href="https://lagunita.stanford.edu/courses/DB/Indexes/SelfPaced/courseware/ch-indexes/">Indexes and Transactions</a> mini-course</h2>
<div class="outline-text-2" id="text-6">
</div>
<div id="outline-container-orgd8737a6" class="outline-3">
<h3 id="orgd8737a6"><span class="section-number-3">6.1</span> <span class="done DONE">DONE</span> Lecture Videos</h3>
<div class="outline-text-3" id="text-6-1">
</div>
<div id="outline-container-org54d8103" class="outline-4">
<h4 id="org54d8103"><span class="section-number-4">6.1.1</span> <span class="done DONE">DONE</span> Indexes</h4>
<div class="outline-text-4" id="text-6-1-1">
<p>
Indexes<br />
</p>
<ul class="org-ul">
<li>Primary mechanism to get improved performance<br /></li>
<li>Persistent data structure, stored in database<br /></li>
<li>Many interesting implementation issues<br /></li>
</ul>


<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-left" />

<col  class="org-right" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">&#xa0;</th>
<th scope="col" class="org-left">A</th>
<th scope="col" class="org-right">B</th>
<th scope="col" class="org-left">C</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">1</td>
<td class="org-left">cat</td>
<td class="org-right">2</td>
<td class="org-left">&#x2026;</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-right">2</td>
<td class="org-left">dog</td>
<td class="org-right">5</td>
<td class="org-left">&#x2026;</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-right">3</td>
<td class="org-left">cow</td>
<td class="org-right">1</td>
<td class="org-left">&#x2026;</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-right">4</td>
<td class="org-left">dog</td>
<td class="org-right">9</td>
<td class="org-left">&#x2026;</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-right">5</td>
<td class="org-left">cat</td>
<td class="org-right">2</td>
<td class="org-left">&#x2026;</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-right">6</td>
<td class="org-left">cat</td>
<td class="org-right">8</td>
<td class="org-left">&#x2026;</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-right">7</td>
<td class="org-left">cow</td>
<td class="org-right">6</td>
<td class="org-left">&#x2026;</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-right">&#xa0;</td>
<td class="org-left">&#x2026;</td>
<td class="org-right">&#x2026;</td>
<td class="org-left">&#x2026;</td>
</tr>
</tbody>
</table>

<p>
Index on T.A<br />
</p>

<p>
T.A = 'cow'<br />
T.A = 'cat'<br />
</p>

<p>
Index on T.B<br />
</p>

<p>
T.B = 2<br />
T.B &lt; 6<br />
4 &lt; T.B &lt;= 8<br />
</p>

<p>
Index on T.(A, B)<br />
</p>

<p>
T.A = 'cat' and T.B &gt; 5<br />
T.A &lt; 'd' and T.B = 1<br />
</p>

<p>
Utility<br />
</p>
<ul class="org-ul">
<li>Index = difference between full table scans and immediate location<br />
of tuples<br />
<ul class="org-ul">
<li>Orders of magnitude performance difference<br /></li>
</ul></li>

<li>Underlying data structures<br />
<ul class="org-ul">
<li>Balanced trees (B trees, B+ trees)<br />
<ul class="org-ul">
<li>A = V, A &lt; V, V1 &lt;= A &lt;= V2<br /></li>
<li>logarithmic time<br /></li>
</ul></li>
<li>Hash tables<br />
<ul class="org-ul">
<li>constant time<br /></li>
</ul></li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">Select</span> sName
<span class="org-keyword">From</span> student
<span class="org-keyword">Where</span> sID = 18942
</pre>
</div>

<p>
Index on sID<br />
</p>

<p>
Many DBMS's build indexes automatically on PRIMARY KEY (and sometimes<br />
UNIQUE) attributes<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">Select</span> sID
<span class="org-keyword">From</span> Student
<span class="org-keyword">Where</span> sName = <span class="org-string">'Mary'</span> <span class="org-keyword">And</span> GPA &gt; 3.9
</pre>
</div>

<p>
Index on sName ← hash or tree<br />
Index on GPA ← tree-based<br />
Index on (sName, GPA)<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">Select</span> sName, cName
<span class="org-keyword">From</span> Student, Apply
<span class="org-keyword">Where</span> Student.sID = Apply.sID
</pre>
</div>

<p>
Index on student.sid or apply.sid or both<br />
</p>

<p>
Query planning &amp; optimization<br />
</p>


<p>
Downsides of Indexes<br />
</p>

<ol class="org-ol">
<li>Extra space - marginal<br /></li>
<li>Index creation - medium<br /></li>
<li>Index maintenance - can offset benefits<br /></li>
</ol>

<p>
Picking which indexes to create<br />
</p>

<p>
Benefits of an index depends on:<br />
</p>
<ul class="org-ul">
<li>Size of table (and possibly layout)<br /></li>
<li>Data distributions<br /></li>
<li>Query vs. update load<br /></li>
</ul>


<p>
"Physical design advisors"<br />
</p>

<p>
Input: database (statistics) and workload<br />
Output: recommended indexes<br />
</p>

<p>
<span class="underline">Query Optimizer</span> takes <span class="underline">Database statistics</span>, <span class="underline">Query or update</span>, and<br />
<span class="underline">indexes</span> as input and gives <span class="underline">best execution plan with estimated cost</span><br />
as output.<br />
</p>

<p>
Pysical design advisor experiments different indexes through query<br />
optimizer and gives recommended indexes, of which benefits outweigh<br />
drawbacks.<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">Create</span> Index IndexName <span class="org-keyword">on</span> T(A)
<span class="org-keyword">Create</span> Index IndexName <span class="org-keyword">on</span> T(A1, A2, ..., An)
<span class="org-keyword">Create</span> <span class="org-keyword">Unique</span> Index IndexNae <span class="org-keyword">on</span> T(A)
<span class="org-keyword">Drop</span> Index IndexName
</pre>
</div>
</div>
</div>

<div id="outline-container-orgddc7a7a" class="outline-4">
<h4 id="orgddc7a7a"><span class="section-number-4">6.1.2</span> <span class="done DONE">DONE</span> Introduction to Transactions</h4>
<div class="outline-text-4" id="text-6-1-2">
<p>
Motivated by two independent requirements<br />
</p>
<ul class="org-ul">
<li>Concurrent database access<br /></li>
<li>Resilience to system failures<br /></li>
</ul>

<p>
<b>Concurrent Access</b>: Attribute-level Inconsistency <a id="org30f7a0f"></a><br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">Update</span> College <span class="org-keyword">Set</span> enrollment = enrollment + 1000
<span class="org-keyword">Where</span> cName = <span class="org-string">'Stanford'</span>
</pre>
</div>
<p>
concurrent with &#x2026;<br />
</p>
<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">Update</span> College <span class="org-keyword">Set</span> enrollment = enrollment + 1500
Whre cName = <span class="org-string">'Stanford'</span>
</pre>
</div>

<p>
get; modify; put<br />
</p>

<p>
Possible outcomes<br />
</p>
\begin{align*}
  15,000 + 2500 &amp;= 17,500 \\
         + 1000 &amp;= 16,000 \\
         + 1500 &amp;= 16,500
\end{align*}

<p>
<b>Concurrent Access</b>: Tuple-level Inconsistency <a id="org680c063"></a><br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">Update</span> Apply <span class="org-keyword">Set</span> major = <span class="org-string">'CS'</span> <span class="org-keyword">Where</span> sID = 123
</pre>
</div>
<p>
concurrent with &#x2026;<br />
</p>
<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">Update</span> Apply <span class="org-keyword">Set</span> decision = <span class="org-string">'Y'</span> <span class="org-keyword">Where</span> sID = 123
</pre>
</div>

<p>
get; modify; put<br />
</p>

<p>
both changes<br />
one of the two changes<br />
</p>

<p>
<b>Concurrent Access</b>: Table-level Inconsistency <a id="orge30b821"></a><br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">Update</span> Apply <span class="org-keyword">Set</span> decision = <span class="org-string">'Y'</span>
<span class="org-keyword">Where</span> sID <span class="org-keyword">In</span> (<span class="org-keyword">Select</span> sID <span class="org-keyword">From</span> Student <span class="org-keyword">Where</span> GPA &gt; 3.9)
</pre>
</div>
<p>
concurrent with &#x2026;<br />
</p>
<div class="org-src-container">
<pre class="src src-sql">Updaate Student <span class="org-keyword">Set</span> GPA = 1.1 * GPA <span class="org-keyword">Where</span> sizeHS &gt; 2500
</pre>
</div>

<p>
<b>Concurrent Access</b>: Multi-statement inconsistency <a id="org3370714"></a><br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">Insert</span> <span class="org-keyword">Into</span> Archive
  <span class="org-keyword">Select</span> * <span class="org-keyword">From</span> Apply <span class="org-keyword">Where</span> decision = <span class="org-string">'N'</span>;
<span class="org-keyword">Delete</span> <span class="org-keyword">From</span> Apply <span class="org-keyword">Where</span> decision = <span class="org-string">'N'</span>;
</pre>
</div>
<p>
concurrent with &#x2026;<br />
</p>
<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">Select</span> <span class="org-builtin">Count</span>(*) <span class="org-keyword">From</span> Apply;
<span class="org-keyword">Select</span> <span class="org-builtin">Count</span>(*) <span class="org-keyword">From</span> Archive;
</pre>
</div>

<p>
Concurrency Goal<br />
</p>

<p>
Execute <i>sequence of SQL statements</i> so they appear to be running in<br />
isolation<br />
</p>

<ul class="org-ul">
<li>Simple solution: execute them in isolation<br /></li>
</ul>

<p>
But want to enable concurrency whenever safe to do so<br />
</p>

<ul class="org-ul">
<li>Multiprocessor<br /></li>
<li>Multithreaded<br /></li>
<li>Asynchronous I/O<br /></li>
</ul>

<p>
Resilience to System Failures<br />
</p>

<p>
Rather unpleasant inconsistent state can occur due to crashes when<br />
there bulk loading to DBMS<br />
</p>

<p>
Or<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">Insert</span> <span class="org-keyword">Into</span> Archive
  <span class="org-keyword">Select</span> * <span class="org-keyword">From</span> Apply <span class="org-keyword">Where</span> decision = <span class="org-string">'N'</span>;
<span class="org-keyword">Delete</span> <span class="org-keyword">From</span> Apply <span class="org-keyword">Where</span> decision = <span class="org-string">'N'</span>;
</pre>
</div>

<p>
Crash failure<br />
</p>

<p>
Lots of updates buffered in memory<br />
</p>

<p>
System-Failure Goal<br />
</p>

<p>
Guarantee all-or-nothing execution, regardless of failures<br />
</p>

<p>
Solution for both concurrency and failures<br />
</p>

<p>
<b>Transactions</b><br />
</p>

<p>
A transaction is a sequence of one or more SQL operations treated as a<br />
unit<br />
</p>
<ul class="org-ul">
<li>Transactions appear to run in isolation<br /></li>
<li>If the system fails, each transaction's changes are reflected<br />
either entirely or not at all<br /></li>
</ul>

<p>
SQL standard:<br />
</p>
<ul class="org-ul">
<li>Transaction begins automatically on first SQL statement<br /></li>
<li>On "commit" transaction ends and new one begins<br /></li>
<li>Current transaction ends on session termination<br /></li>
<li>"Autocommit" turns each statement into transaction<br /></li>
</ul>
</div>
</div>

<div id="outline-container-orgc7211a9" class="outline-4">
<h4 id="orgc7211a9"><span class="section-number-4">6.1.3</span> <span class="done DONE">DONE</span> Transaction Properties</h4>
<div class="outline-text-4" id="text-6-1-3">
<p>
ACID Properties<br />
Atomicity, Consistency, Isolation, Durability<br />
</p>

<p>
Isolation<br />
</p>

<p>
<span class="underline">Serializability</span>  <a id="orgdf7c46f"></a><br />
Operations may be interleaved, but execution must be equivalent to<br />
<i>some</i> sequential (serial) order of all transactions<br />
</p>

<p>
locking portion of the database<br />
</p>

<p>
<a href="#org30f7a0f">Attribute-level Inconsistency</a><br />
</p>

<p>
T1; T2<br />
T2; T1<br />
</p>

<p>
15,000 → 17,500<br />
</p>

<p>
<a href="#org680c063">Tuple-level Inconsistency</a><br />
</p>

<p>
T1; T2<br />
T2; T1<br />
</p>

<p>
both changes<br />
</p>

<p>
<a href="#orge30b821">Table-level Inconsistency</a><br />
</p>

<p>
T1; T2<br />
T2; T1<br />
</p>

<p>
Order matters here.<br />
</p>

<p>
<a href="#org3370714">Multi-statement inconsistency</a><br />
</p>

<p>
Order also matters here.<br />
</p>

<p>
Durability<br />
</p>

<p>
If system crashes after transaction commits, all effects of<br />
transaction remain in database.<br />
</p>

<p>
T2 {S1; S2; S3; commit} crashes<br />
</p>

<p>
implemented by logging<br />
</p>

<p>
Atomicity<br />
</p>

<p>
Each transaction is "all-or-nothing," never left half done<br />
</p>

<p>
T2 { S1; S2; &#x2026; crashes &#x2026;; commit }<br />
</p>

<p>
Logging<br />
</p>

<p>
Transaction Rollback (= Abort) ☆<br />
</p>
<ul class="org-ul">
<li>Undoes <span class="underline">partial effects</span> of transaction<br /></li>
<li>Can be <span class="underline">system</span> or <span class="underline">client initiated</span><br /></li>
</ul>

<pre class="example">
Begin Transaction;
&lt;get input from user&gt;
SQL commands based on input
&lt;confirm results with user&gt;
If ans = 'ok' Then Commit; Else Rollback;
</pre>

<p>
Rollback only undoes data itself on database, but doesn't affect<br />
variable, and cash delivery etc.<br />
</p>

<p>
Never hold a transaction for long time.  Locking<br />
</p>

<p>
Consistency<br />
</p>

<p>
Each client, each transaction:<br />
</p>
<ul class="org-ul">
<li>Can assume all constraints hold when transaction begins<br /></li>
<li>Must guarantee all constraints hold when transaction ends<br /></li>
</ul>

<p>
Serializability ⇒ constraints always hold<br />
</p>
</div>
</div>

<div id="outline-container-org3dc65fc" class="outline-4">
<h4 id="org3dc65fc"><span class="section-number-4">6.1.4</span> <span class="done DONE">DONE</span> Isolation Levels</h4>
<div class="outline-text-4" id="text-6-1-4">
<p>
<a href="#orgdf7c46f">Serializability</a> ⇒ Overhead, Reduction in concurrency<br />
</p>

<p>
Weaker "Isolation Levels" (from weak to strong)<br />
</p>
<ul class="org-ul">
<li>Read Uncommitted<br /></li>
<li>Read Committed<br /></li>
<li>Repeatable Read<br /></li>
<li>Serializable<br /></li>
</ul>

<p>
↓ Overhead ↑ Concurrency<br />
↓ Consistency Guarantees<br />
</p>

<p>
Isolation Levels<br />
</p>
<ul class="org-ul">
<li>Per transaction<br /></li>
<li>"In the eye of the beholder"<br /></li>
</ul>

<p>
Dirty Reads<br />
"Dirty" data item: written by an uncommitted transaction<br />
</p>

<p>
Example 1<br />
</p>
<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">Update</span> College <span class="org-keyword">Set</span> enrollment = enrollment + 1000
<span class="org-keyword">Where</span> cName = <span class="org-string">'Stanford'</span>
</pre>
</div>
<p>
concurrent with &#x2026;<br />
</p>
<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">Select</span> <span class="org-builtin">Avg</span>(enrollment) <span class="org-keyword">From</span> College
</pre>
</div>

<p>
Example 2<br />
</p>
<div class="org-src-container">
<pre class="src src-sql" id="orgbff5353"><span class="org-keyword">Update</span> Student <span class="org-keyword">Set</span> GPA = 1.1 * GPA <span class="org-keyword">Where</span> sizeHS &gt; 2500
</pre>
</div>
<p>
concurrent with &#x2026;<br />
</p>
<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">Select</span> GPA <span class="org-keyword">From</span> Student <span class="org-keyword">Where</span> sID = 123
</pre>
</div>
<p>
concurrent with &#x2026;<br />
</p>
<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">Update</span> Student <span class="org-keyword">Set</span> sizeHS = 2600 <span class="org-keyword">Where</span> sID = 234
</pre>
</div>

<p>
There is no such thing as dirty read within the same transaction.<br />
</p>

<p>
Isolation Level: Read Uncommitted<br />
</p>
<ul class="org-ul">
<li>A transaction may perform dirty reads<br /></li>
</ul>

<p>
<a href="#orgbff5353">Query</a> concurrent with &#x2026;<br />
</p>
<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">Set</span> <span class="org-keyword">Transaction</span> <span class="org-keyword">Isolation</span> <span class="org-keyword">Level</span> <span class="org-keyword">Read</span> <span class="org-keyword">Uncommitted</span>;
<span class="org-keyword">Select</span> <span class="org-builtin">Avg</span>(GPA) <span class="org-keyword">From</span> Student;
</pre>
</div>

<p>
Isolation Level: Read Committed<br />
</p>
<ul class="org-ul">
<li>A transaction may <i>not</i> perform dirty reads<br /></li>
</ul>

<p>
Still does not guarantee global serializability<br />
</p>

<p>
<a href="#orgbff5353">Query</a> concurrent with &#x2026;<br />
</p>
<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">Set</span> <span class="org-keyword">Transaction</span> <span class="org-keyword">Isolation</span> <span class="org-keyword">Level</span> <span class="org-keyword">Read</span> <span class="org-keyword">Committed</span>;
<span class="org-keyword">Select</span> <span class="org-builtin">Avg</span>(GPA) <span class="org-keyword">From</span> Student;
<span class="org-keyword">Select</span> <span class="org-builtin">Max</span>(GPA) <span class="org-keyword">From</span> Student;
</pre>
</div>

<p>
Isolation Level: Repeatable Read<br />
</p>
<ul class="org-ul">
<li>A transaction may not perform dirty reads<br /></li>
<li>An item read multiple times cannot change value<br /></li>
</ul>

<p>
Still does not guarantee global serializability<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">Update</span> Student <span class="org-keyword">Set</span> GPA = 1.1 * GPA;
<span class="org-keyword">Update</span> Student <span class="org-keyword">Set</span> sizeHS = 1500 <span class="org-keyword">where</span> sID = 123;
</pre>
</div>
<p>
concurrent with &#x2026;<br />
</p>
<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">Set</span> <span class="org-keyword">Transaction</span> <span class="org-keyword">Isolation</span> <span class="org-keyword">Level</span> <span class="org-keyword">Repeatable</span> <span class="org-keyword">Read</span>;
<span class="org-keyword">Select</span> <span class="org-builtin">Avg</span>(GPA) <span class="org-keyword">From</span> Student;
<span class="org-keyword">Select</span> <span class="org-builtin">Avg</span>(sizeHS) <span class="org-keyword">From</span> Student;
</pre>
</div>

<p>
Neither T1; T2 Nor T2; T1<br />
</p>

<p>
But a relation <i>can</i> change: "phantom" tuples<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">Insert</span> <span class="org-keyword">Into</span> Student <span class="org-comment">-- [100 new tuples]</span>
</pre>
</div>
<p>
concurrent with &#x2026;<br />
</p>
<div class="org-src-container">
<pre class="src src-sql" id="org10cdad3"><span class="org-keyword">Set</span> <span class="org-keyword">Transaction</span> <span class="org-keyword">Isolation</span> <span class="org-keyword">Level</span> <span class="org-keyword">Repeatable</span> <span class="org-keyword">Read</span>;
<span class="org-keyword">Select</span> <span class="org-builtin">Avg</span>(GPA) <span class="org-keyword">From</span> Student;
<span class="org-keyword">Select</span> <span class="org-builtin">Max</span>(GPA) <span class="org-keyword">From</span> Student;
</pre>
</div>

<p>
The inserted tuples are called phantom tuples<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">Delete</span> <span class="org-keyword">From</span> Student <span class="org-comment">-- [100 tuples]</span>
</pre>
</div>
<p>
concurrent with <a href="#org10cdad3">Query</a><br />
</p>

<p>
T1 must occur either before or after T2<br />
</p>

<p>
Read Only transactions<br />
</p>
<ul class="org-ul">
<li>Helps system optimize performance<br /></li>
<li>Independent of isolation level<br /></li>
</ul>

<p>
Orthogonal to isolation level<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">Set</span> <span class="org-keyword">Transaction</span> <span class="org-keyword">Read</span> <span class="org-keyword">Only</span>;
<span class="org-keyword">Set</span> <span class="org-keyword">Transaction</span> <span class="org-keyword">Isolation</span> <span class="org-keyword">Level</span> <span class="org-keyword">Repeatable</span> <span class="org-keyword">Read</span>;
<span class="org-keyword">Select</span> <span class="org-builtin">Avg</span>(GPA) <span class="org-keyword">From</span> Student;
<span class="org-keyword">Select</span> <span class="org-builtin">Max</span>(GPA) <span class="org-keyword">From</span> Student;
</pre>
</div>

<p>
Isolation Levels: Summary<br />
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">&#xa0;</th>
<th scope="col" class="org-left">dirty Reads</th>
<th scope="col" class="org-left">nonrepeatable reads</th>
<th scope="col" class="org-left">phantoms</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">Read Uncommitted</td>
<td class="org-left">Y</td>
<td class="org-left">Y</td>
<td class="org-left">Y</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-left">Read Committed</td>
<td class="org-left">N</td>
<td class="org-left">Y</td>
<td class="org-left">Y</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-left">Repeatable Read</td>
<td class="org-left">N</td>
<td class="org-left">N</td>
<td class="org-left">Y</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-left">Serializable</td>
<td class="org-left">N</td>
<td class="org-left">N</td>
<td class="org-left">N</td>
</tr>
</tbody>
</table>

<ul class="org-ul">
<li>Standard default: Serializable<br /></li>
<li>Weaker isolation levels<br />
<ul class="org-ul">
<li>Increased concurrency + decreased overhead =<br />
increased performance<br /></li>
<li>Weaker consistency guarantees<br /></li>
<li>Some systems have default Repeatable Read<br /></li>
</ul></li>
<li>Isolation level per transaction and "eye of the beholder"<br />
<ul class="org-ul">
<li>Each transaction's reads must conform to its isolation level<br /></li>
</ul></li>
</ul>

<p>
Note: An entire workload is globally serializable only if every<br />
transaction's isolation level is serializable.<br />
</p>
</div>
</div>
</div>

<div id="outline-container-orgaeb9f3c" class="outline-3">
<h3 id="orgaeb9f3c"><span class="section-number-3">6.2</span> <span class="done DONE">DONE</span> Exercises</h3>
<div class="outline-text-3" id="text-6-2">
</div>
<div id="outline-container-org54081d1" class="outline-4">
<h4 id="org54081d1"><span class="section-number-4">6.2.1</span> <span class="done DONE">DONE</span> Index Quiz</h4>
<div class="outline-text-4" id="text-6-2-1">
</div>
</div>
<div id="outline-container-orgc446251" class="outline-4">
<h4 id="orgc446251"><span class="section-number-4">6.2.2</span> <span class="done DONE">DONE</span> Transaction Quiz</h4>
<div class="outline-text-4" id="text-6-2-2">
</div>
</div>
</div>
</div>


<div id="outline-container-orgcaf5b6f" class="outline-2">
<h2 id="orgcaf5b6f"><span class="section-number-2">7</span> <span class="done DONE">DONE</span> <a href="https://lagunita.stanford.edu/courses/DB/Constraints/SelfPaced/courseware/ch-constraints_and_triggers/">Constraints and Triggers</a> mini-course</h2>
<div class="outline-text-2" id="text-7">
</div>
<div id="outline-container-org033ce25" class="outline-3">
<h3 id="org033ce25"><span class="section-number-3">7.1</span> <span class="done DONE">DONE</span> Lecture Videos</h3>
<div class="outline-text-3" id="text-7-1">
</div>
<div id="outline-container-org8880985" class="outline-4">
<h4 id="org8880985"><span class="section-number-4">7.1.1</span> <span class="done DONE">DONE</span> Motivation and Overview</h4>
<div class="outline-text-4" id="text-7-1-1">
<p>
(Integrity) Contstraints  &lt;static&gt;<br />
  constrain allowable database states<br />
</p>


<p>
Triggers &lt;dynamic&gt;<br />
  monitor database changes,<br />
  check conditions and initiate actions<br />
</p>


<p>
Integrity Constraints<br />
  Impose restrictions on allowable data, beyond those imposed by<br />
  structure and types<br />
</p>


<p>
0.0 &lt; GPA &lt;= 4.0<br />
enrollment &lt; 50,000 (75,000)<br />
</p>


<p>
Why use them?<br />
  Data-entry errors (inserts)<br />
  Correctness criteria (updates)<br />
  Enforce consistency<br />
  Tell system about data<br />
</p>


<p>
Classification<br />
  Non-null<br />
  Key<br />
  Referential Integrity (foreign key)<br />
</p>


<p>
Declaring and enforcing constraints<br />
</p>

<p>
Declaration<br />
</p>
<ul class="org-ul">
<li>With original schema - checked after bulk loading<br /></li>
<li>Or later - checked on current DB<br /></li>
</ul>


<p>
Enforcement<br />
</p>
<ul class="org-ul">
<li>Check after every "dangerous" modification<br /></li>
<li>Deferred constraint checking (transaction)<br /></li>
</ul>


<p>
Triggers<br />
"Event-Condition-Action Rules"<br />
When <i>event</i> occurs, check <i>condition</i>; if true, do action<br />
</p>


<p>
Examples<br />
  enrollment &gt; 35,000 -&gt; reject all applicants<br />
  insert app with GPA &gt; 3.95 -&gt; accept automatically<br />
  update sizeHS to be &gt; 7,000 -&gt; change to "wrong", raise error<br />
</p>


<p>
Why use them?<br />
More logic from apps into DBMS<br />
To enforce constraints<br />
</p>
<ul class="org-ul">
<li>expressive<br /></li>
<li>constraint "repair" logic<br /></li>
</ul>




<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">Create</span> <span class="org-keyword">Trigger</span> <span class="org-keyword">name</span>
<span class="org-keyword">Before</span>|<span class="org-keyword">After</span>|Instead <span class="org-keyword">Of</span> events
[ <span class="org-keyword">referencing</span>-variables ]
[ <span class="org-keyword">For</span> <span class="org-keyword">Each</span> <span class="org-type">Row</span> ]
<span class="org-keyword">When</span> (condition)
<span class="org-keyword">action</span>
</pre>
</div>

<p>
Constraints and Triggers<br />
</p>
<ul class="org-ul">
<li>For relational databases<br /></li>
<li>SQL standard; systems vary considerably<br /></li>
</ul>

<p>
(Integrity) Constraints<br />
</p>
<ul class="org-ul">
<li>constrain allowable database states<br /></li>
</ul>

<p>
Triggers<br />
</p>
<ul class="org-ul">
<li>monitor database changes,<br /></li>
<li>check conditions and initiate actions<br /></li>
</ul>
</div>
</div>

<div id="outline-container-orgd71a2fb" class="outline-4">
<h4 id="orgd71a2fb"><span class="section-number-4">7.1.2</span> <span class="done DONE">DONE</span> Constraints of Several Types</h4>
<div class="outline-text-4" id="text-7-1-2">
<p>
Integrity Constraints<br />
</p>
<ul class="org-ul">
<li>Impose restrictions on allowable data, beyond those imposed by structure and types<br />
<ul class="org-ul">
<li>Non-null constraints<br /></li>
<li>Key constraints<br /></li>
<li>Attribute-based and tuple-based constraints (limits)<br /></li>
<li>General assertions (not implemented by any database)<br /></li>
</ul></li>
</ul>

<p>
Not all constraints are implemented.<br />
</p>

<p>
Constraints Demo<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">table</span> <span class="org-function-name">Student</span>(
    sID <span class="org-type">int</span>,
    sName text,
    GPA <span class="org-type">real</span> <span class="org-keyword">not</span> <span class="org-keyword">null</span>,
    sizeHS <span class="org-type">int</span>
);
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">insert</span> <span class="org-keyword">into</span> Student <span class="org-keyword">values</span> (123, <span class="org-string">'Amy'</span>, 3.9, 1000);
<span class="org-keyword">insert</span> <span class="org-keyword">into</span> Student <span class="org-keyword">values</span> (234, <span class="org-string">'Bob'</span>, 3.6, <span class="org-keyword">null</span>);
<span class="org-keyword">insert</span> <span class="org-keyword">into</span> Student <span class="org-keyword">values</span> (345, <span class="org-string">'Craig'</span>, <span class="org-keyword">null</span>, 500);
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">update</span> Student <span class="org-keyword">set</span> GPA = <span class="org-keyword">null</span> <span class="org-keyword">where</span> sID = 123; <span class="org-comment">-- failed</span>
<span class="org-keyword">update</span> Student <span class="org-keyword">set</span> GPA = <span class="org-keyword">null</span> <span class="org-keyword">where</span> sID = 456; <span class="org-comment">-- succeed since 456 doesn't exist</span>
</pre>
</div>


<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">table</span> <span class="org-function-name">Student</span>(
    sID <span class="org-type">int</span> <span class="org-keyword">primary</span> <span class="org-keyword">key</span>,
    sName text,
    GPA <span class="org-type">real</span>,
    sizeHS <span class="org-type">int</span>
);
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">insert</span> <span class="org-keyword">into</span> Student <span class="org-keyword">values</span> (123, <span class="org-string">'Amy'</span>, 3.9, 1000);
<span class="org-keyword">insert</span> <span class="org-keyword">into</span> Student <span class="org-keyword">values</span> (234, <span class="org-string">'Bob'</span>, 3.6, 1500);
<span class="org-keyword">insert</span> <span class="org-keyword">into</span> Student <span class="org-keyword">values</span> (123, <span class="org-string">'Craig'</span>, 3.5, 500); <span class="org-comment">-- failed, key error</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">update</span> Student <span class="org-keyword">set</span> sID = 123 <span class="org-keyword">where</span> sName = <span class="org-string">'Bob'</span>;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">update</span> Student <span class="org-keyword">set</span> sID = sID - 111; <span class="org-comment">-- succeed if query executed for sID 123 before 234</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">update</span> Student <span class="org-keyword">set</span> sID = sID + 111; <span class="org-comment">-- failed if query executed for sID 123 before 234</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">table</span> <span class="org-function-name">Student</span>(
    sID <span class="org-type">int</span> <span class="org-keyword">primary</span> <span class="org-keyword">key</span>,
    sName text <span class="org-keyword">unique</span>,
    GPA <span class="org-type">real</span>,
    sizeHS <span class="org-type">int</span>
);
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">insert</span> <span class="org-keyword">into</span> Student <span class="org-keyword">values</span> (123, <span class="org-string">'Amy'</span>, 3.9, 1000);
<span class="org-keyword">insert</span> <span class="org-keyword">into</span> Student <span class="org-keyword">values</span> (234, <span class="org-string">'Bob'</span>, 3.6, 1500);
<span class="org-keyword">insert</span> <span class="org-keyword">into</span> Student <span class="org-keyword">values</span> (345, <span class="org-string">'Amy'</span>, 3.5, 500); <span class="org-comment">-- failed</span>
<span class="org-keyword">insert</span> <span class="org-keyword">into</span> Student <span class="org-keyword">values</span> (456, <span class="org-string">'Doris'</span>, 3.9, 1000);
<span class="org-keyword">insert</span> <span class="org-keyword">into</span> Student <span class="org-keyword">values</span> (567, <span class="org-string">'Amy'</span>, 3.8, 1500); <span class="org-comment">-- failed</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">table</span> <span class="org-function-name">College</span>(
    cName text,
    <span class="org-keyword">state</span> text,
    enrollment <span class="org-type">int</span>,
    pimary <span class="org-keyword">key</span> (cName, <span class="org-keyword">state</span>)
);
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">insert</span> <span class="org-keyword">into</span> College <span class="org-keyword">values</span> (<span class="org-string">'Mason'</span>, <span class="org-string">'CA'</span>, 10000);
<span class="org-keyword">insert</span> <span class="org-keyword">into</span> College <span class="org-keyword">values</span> (<span class="org-string">'Mason'</span>, <span class="org-string">'NY'</span>, 5000);
<span class="org-keyword">insert</span> <span class="org-keyword">into</span> College <span class="org-keyword">values</span> (<span class="org-string">'Mason'</span>, <span class="org-string">'CA'</span>, 2000);
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">table</span> <span class="org-function-name">Apply</span>(
    sID <span class="org-type">int</span>,
    cName text,
    major text,
    decision text,
    <span class="org-keyword">unique</span>(sID, cName),
    <span class="org-keyword">unique</span>(sID, major)
);
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">insert</span> <span class="org-keyword">into</span> Apply <span class="org-keyword">values</span> (123, <span class="org-string">'Stanford'</span>, <span class="org-string">'CS'</span>, <span class="org-keyword">null</span>);
<span class="org-keyword">insert</span> <span class="org-keyword">into</span> Apply <span class="org-keyword">values</span> (123, <span class="org-string">'Berkeley'</span>, <span class="org-string">'EE'</span>, <span class="org-keyword">null</span>);
<span class="org-keyword">insert</span> <span class="org-keyword">into</span> Apply <span class="org-keyword">values</span> (123, <span class="org-string">'Stanford'</span>, <span class="org-string">'biology'</span>, <span class="org-keyword">null</span>); <span class="org-comment">-- failed</span>
<span class="org-keyword">insert</span> <span class="org-keyword">into</span> Apply <span class="org-keyword">values</span> (234, <span class="org-string">'Stanford'</span>, <span class="org-string">'biology'</span>, <span class="org-keyword">null</span>);
<span class="org-keyword">insert</span> <span class="org-keyword">into</span> Apply <span class="org-keyword">values</span> (123, <span class="org-string">'MIT'</span>, <span class="org-string">'EE'</span>, <span class="org-keyword">null</span>); <span class="org-comment">-- failed</span>
<span class="org-keyword">insert</span> <span class="org-keyword">into</span> Apply <span class="org-keyword">values</span> (123, <span class="org-string">'MIT'</span>, <span class="org-string">'biology'</span>, <span class="org-keyword">null</span>);
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">update</span> Apply <span class="org-keyword">set</span> major = <span class="org-string">'CS'</span> <span class="org-keyword">where</span> cName = <span class="org-string">'MIT'</span>;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">insert</span> <span class="org-keyword">into</span> Apply <span class="org-keyword">values</span> (123, <span class="org-keyword">null</span>, <span class="org-keyword">null</span>, <span class="org-string">'Y'</span>);
<span class="org-keyword">insert</span> <span class="org-keyword">into</span> Apply <span class="org-keyword">values</span> (123, <span class="org-keyword">null</span>, <span class="org-keyword">null</span>, <span class="org-string">'N'</span>);
</pre>
</div>

<p>
Both queries above succeed.  SQL standard and most systems allow<br />
duplicate null values for unique key.  Most systems do not permit<br />
repeated null values for primary key.<br />
</p>


<p>
Attribute check constraint<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">table</span> <span class="org-function-name">Student</span>(
    sID <span class="org-type">int</span>,
    sName text,
    GPA <span class="org-type">real</span> <span class="org-keyword">check</span>(GPA &lt;= 4.0 <span class="org-keyword">and</span> GPA &gt; 0.0),
    sizeHS <span class="org-type">int</span> <span class="org-keyword">check</span>(sizeHS &lt; 5000)
);
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">insert</span> <span class="org-keyword">into</span> Student <span class="org-keyword">values</span> (123, <span class="org-string">'Amy'</span>, 3.9, 1000);
<span class="org-keyword">insert</span> <span class="org-keyword">into</span> Student <span class="org-keyword">values</span> (234, <span class="org-string">'Bob'</span>, 4.6, 1500);
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">table</span> <span class="org-function-name">Apply</span>(
    sID <span class="org-type">int</span>,
    cName text,
    major text,
    decision text,
    <span class="org-keyword">check</span>(decision = <span class="org-string">'N'</span> <span class="org-keyword">or</span> cName &lt;&gt; <span class="org-string">'Stanford'</span> <span class="org-keyword">or</span> major &lt;&gt; <span class="org-string">'CS'</span>)
);
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">insert</span> <span class="org-keyword">into</span> Apply <span class="org-keyword">values</span> (123, <span class="org-string">'Stanford'</span>, <span class="org-string">'CS'</span>, <span class="org-string">'N'</span>);
<span class="org-keyword">insert</span> <span class="org-keyword">into</span> Apply <span class="org-keyword">values</span> (123, <span class="org-string">'MIT'</span>, <span class="org-string">'CS'</span>, <span class="org-string">'Y'</span>);
<span class="org-keyword">insert</span> <span class="org-keyword">into</span> Apply <span class="org-keyword">values</span> (123, <span class="org-string">'Stanford'</span>, <span class="org-string">'CS'</span>, <span class="org-string">'Y'</span>);
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">update</span> Apply <span class="org-keyword">set</span> decision = <span class="org-string">'Y'</span> <span class="org-keyword">where</span> cName = <span class="org-string">'Stanford'</span>;
<span class="org-keyword">update</span> Apply <span class="org-keyword">set</span> cName = <span class="org-string">'Stanford'</span> <span class="org-keyword">where</span> cName = <span class="org-string">'MIT'</span>;
</pre>
</div>

<p>
Both queries failed on SQLite and Postgres, but not in MySQL (MySQL sucks).<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">table</span> <span class="org-function-name">Student</span>(
    sID <span class="org-type">int</span>,
    sName text,
    GPA <span class="org-type">real</span> <span class="org-keyword">check</span>(GPA <span class="org-keyword">is</span> <span class="org-keyword">not</span> <span class="org-keyword">null</span>),
    sizeHS <span class="org-type">int</span>
);
</pre>
</div>

<p>
The above is equivalent to <code>GPA real not null</code>.<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">table</span> <span class="org-function-name">T</span>(
    A <span class="org-type">int</span> <span class="org-keyword">check</span>(A <span class="org-keyword">not</span> <span class="org-keyword">in</span> (<span class="org-keyword">select</span> A <span class="org-keyword">from</span> T))
);
</pre>
</div>

<p>
The above check constraint implements key constraint.  It fails on<br />
SQLite for several reasons.  The order of execution and check matters.<br />
It works for at least some database system.<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">table</span> <span class="org-function-name">T</span>(
    A <span class="org-type">int</span> <span class="org-keyword">check</span>((<span class="org-keyword">select</span> <span class="org-builtin">count</span>(<span class="org-keyword">distinct</span> A) <span class="org-keyword">from</span> T) =
                (<span class="org-keyword">select</span> <span class="org-builtin">count</span>(*) <span class="org-keyword">from</span> T))
);
</pre>
</div>

<p>
No known database allows subquery, esp. aggregation, in check<br />
expression, so the above query also doesn't work.<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">table</span> <span class="org-function-name">Student</span>(
    sID <span class="org-type">int</span>,
    sName text,
    GPA <span class="org-type">real</span>,
    sizeHS <span class="org-type">int</span>
);

<span class="org-keyword">create</span> <span class="org-keyword">table</span> <span class="org-function-name">Apply</span>(
    sID <span class="org-type">int</span>,
    cName text,
    major text,
    decision text,
    <span class="org-keyword">check</span>(sID <span class="org-keyword">in</span> (<span class="org-keyword">select</span> sID <span class="org-keyword">from</span> Student))
);
</pre>
</div>

<p>
The above table definitions is valid according to SQL standards but no<br />
database implements subquery in check constraint.<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">table</span> <span class="org-function-name">College</span>(
    cName text,
    <span class="org-keyword">state</span> text,
    enrollment <span class="org-type">int</span>,
    <span class="org-keyword">check</span>(enrollment &gt; (<span class="org-keyword">select</span> <span class="org-builtin">max</span>(sizeHS) <span class="org-keyword">from</span> Student))
);
</pre>
</div>

<p>
Also valid in SQL standard but no database allows this.  Now, suppose<br />
this works for some system, it has other problems.  When student table<br />
changes, the check constraint may no longer be valid.<br />
</p>


<p>
General Assertions<br />
</p>
<ul class="org-ul">
<li>They are very powerful but unfortunately not implemented by any RDBMS.<br /></li>
</ul>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">assertion</span> <span class="org-keyword">Key</span>
<span class="org-keyword">check</span> ((<span class="org-keyword">select</span> <span class="org-builtin">count</span>(<span class="org-keyword">distinct</span> A) <span class="org-keyword">from</span> T) =
       (<span class="org-keyword">select</span> <span class="org-builtin">count</span>(*) <span class="org-keyword">from</span> T));
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">assertion</span> ReferentialIntegrity
<span class="org-keyword">check</span>  (<span class="org-keyword">not</span> <span class="org-keyword">exists</span> (<span class="org-keyword">select</span> * <span class="org-keyword">from</span> Apply
                    <span class="org-keyword">where</span> sID <span class="org-keyword">not</span> <span class="org-keyword">in</span> (<span class="org-keyword">select</span> sID <span class="org-keyword">from</span> Student)));
</pre>
</div>

<p>
It's common to write <code>not exists</code> in general assertions.<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">assertion</span> AvgAccept
<span class="org-keyword">check</span> (3.0 &lt; (<span class="org-keyword">select</span> <span class="org-builtin">avg</span>(GPA) <span class="org-keyword">from</span> Student
              <span class="org-keyword">where</span> sID <span class="org-keyword">in</span>
                (<span class="org-keyword">select</span> sID <span class="org-keyword">from</span> Apply <span class="org-keyword">where</span> decision = <span class="org-string">'Y'</span>)));
</pre>
</div>
</div>
</div>

<div id="outline-container-orgab1d028" class="outline-4">
<h4 id="orgab1d028"><span class="section-number-4">7.1.3</span> <span class="done DONE">DONE</span> Referential Integrity</h4>
<div class="outline-text-4" id="text-7-1-3">
<p>
Integrity Constraints<br />
</p>
<ul class="org-ul">
<li>Impose restrictions on allowable data, beyond those imposed by<br />
structure and types<br /></li>
</ul>

<p>
Referential integrity = Integrity of references = No "dangling pointers"<br />
</p>


<p>
Referential integrity from R.A to S.B<br />
</p>
<ul class="org-ul">
<li>Each value in column A of table R must appear in column B of table S<br />
<ul class="org-ul">
<li>A is called the "foreign key" (Foreign key constraints)<br /></li>
<li>B is usually required to be the <i>primary key</i> for table S or at least <i>unique</i><br /></li>
<li>Multi-attribute foreign keys are allowed<br /></li>
</ul></li>
</ul>

<p>
Referential integrity is directional<br />
</p>

<p>
Referential Integrity Enforcement (R.A to S.B)<br />
</p>
<ul class="org-ul">
<li>Potentially violating modifications:<br />
<ul class="org-ul">
<li>Insert into R<br /></li>
<li>Delete from S<br /></li>
<li>Update R.A<br /></li>
<li>Update S.B<br /></li>
</ul></li>
</ul>

<p>
Special actions:<br />
</p>
<ul class="org-ul">
<li>Delete from S<br />
<ul class="org-ul">
<li>Delete from S<br />
<ul class="org-ul">
<li><code>Restrict</code> (default), <code>Set Null</code>, <code>Cascade</code><br /></li>
</ul></li>
<li>Update S.B<br />
<ul class="org-ul">
<li><code>Restrict</code> (default), <code>Set Null</code>, <code>Cascade</code><br /></li>
</ul></li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">table</span> <span class="org-function-name">College</span>(
    cName text <span class="org-keyword">primary</span> <span class="org-keyword">key</span>,
    <span class="org-keyword">state</span> text,
    enrollment <span class="org-type">int</span>
);

<span class="org-keyword">create</span> <span class="org-keyword">table</span> <span class="org-function-name">Student</span>(
    sID <span class="org-type">int</span> <span class="org-keyword">primary</span> <span class="org-keyword">key</span>,
    sName text,
    GPA <span class="org-type">real</span>,
    sizeHS <span class="org-type">int</span>
);

<span class="org-keyword">create</span> <span class="org-keyword">table</span> <span class="org-function-name">Apply</span>(
    sID <span class="org-type">int</span> <span class="org-keyword">references</span> Student(sID),
    cName text <span class="org-keyword">references</span> College(cName),
    major text,
    decision text
);
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">insert</span> <span class="org-keyword">into</span> Apply <span class="org-keyword">values</span> (123, <span class="org-string">'Stanford'</span>, <span class="org-string">'CS'</span>, <span class="org-string">'Y'</span>);
<span class="org-keyword">insert</span> <span class="org-keyword">into</span> Apply <span class="org-keyword">values</span> (234, <span class="org-string">'Berkeley'</span>, <span class="org-string">'biology'</span>, <span class="org-string">'N'</span>);
</pre>
</div>

<p>
Both queries above failed.<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">insert</span> <span class="org-keyword">into</span> Student <span class="org-keyword">values</span> (123, <span class="org-string">'Amy'</span>, 3.9, 1000);
<span class="org-keyword">insert</span> <span class="org-keyword">into</span> Student <span class="org-keyword">values</span> (234, <span class="org-string">'Bob'</span>, 3.6, 1500);
<span class="org-keyword">insert</span> <span class="org-keyword">into</span> College <span class="org-keyword">values</span> (<span class="org-string">'Stanford'</span>, <span class="org-string">'CA'</span>, 15000);
<span class="org-keyword">insert</span> <span class="org-keyword">into</span> College <span class="org-keyword">values</span> (<span class="org-string">'Berkeley'</span>, <span class="org-string">'CA'</span>, 36000);
</pre>
</div>

<p>
After executing the above queries, the previous queries succeed.<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">update</span> Apply <span class="org-keyword">set</span> sID = 345 <span class="org-keyword">where</span> sID = 123; <span class="org-comment">-- failed, break referential integrity</span>
<span class="org-keyword">update</span> Apply <span class="org-keyword">set</span> sID = 234 <span class="org-keyword">where</span> sID = 123; <span class="org-comment">-- succeed</span>
</pre>
</div>


<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">delete</span> <span class="org-keyword">from</span> College <span class="org-keyword">where</span> cName = <span class="org-string">'Stanford'</span>; <span class="org-comment">-- failed</span>
<span class="org-keyword">delete</span> <span class="org-keyword">from</span> College <span class="org-keyword">where</span> sID = 234;          <span class="org-comment">-- failed</span>
<span class="org-keyword">delete</span> <span class="org-keyword">from</span> College <span class="org-keyword">where</span> sID = 123;          <span class="org-comment">-- succeed</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">update</span> College <span class="org-keyword">set</span> cName = <span class="org-string">'Bezerkeley'</span> <span class="org-keyword">where</span> cName = <span class="org-string">'Berkeley'</span>; <span class="org-comment">-- failed</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">drop</span> <span class="org-keyword">table</span> <span class="org-function-name">Student</span>;             <span class="org-comment">-- failed</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">table</span> <span class="org-function-name">Apply</span>(
    sID <span class="org-type">int</span> <span class="org-keyword">references</span> Student(sID) <span class="org-keyword">on</span> <span class="org-keyword">delete</span> <span class="org-keyword">set</span> <span class="org-keyword">null</span>,
    cName text <span class="org-keyword">references</span> College(cName) <span class="org-keyword">on</span> <span class="org-keyword">update</span> <span class="org-keyword">cascade</span>,
    major text,
    decision text
);
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">delete</span> <span class="org-keyword">from</span> Student <span class="org-keyword">where</span> sID &gt; 200;
</pre>
</div>

<p>
The Bezerkeley query now succeeds.<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">table</span> <span class="org-function-name">T</span> (
    A <span class="org-type">int</span>,
    B <span class="org-type">int</span>,
    C <span class="org-type">int</span>,
    <span class="org-keyword">primary</span> <span class="org-keyword">key</span> (A, B),
    <span class="org-keyword">foreign</span> <span class="org-keyword">key</span> (B, C) <span class="org-keyword">references</span> T(A, B) <span class="org-keyword">on</span> <span class="org-keyword">delete</span> <span class="org-keyword">cascade</span>
);
<span class="org-keyword">insert</span> <span class="org-keyword">into</span> T <span class="org-keyword">values</span> (1, 1, 1);
<span class="org-keyword">insert</span> <span class="org-keyword">into</span> T <span class="org-keyword">values</span> (2, 1, 1);
<span class="org-keyword">insert</span> <span class="org-keyword">into</span> T <span class="org-keyword">values</span> (3, 2, 1);
<span class="org-keyword">insert</span> <span class="org-keyword">into</span> T <span class="org-keyword">values</span> (4, 3, 2);
<span class="org-keyword">insert</span> <span class="org-keyword">into</span> T <span class="org-keyword">values</span> (5, 4, 3);
<span class="org-keyword">insert</span> <span class="org-keyword">into</span> T <span class="org-keyword">values</span> (6, 5, 4);
<span class="org-keyword">insert</span> <span class="org-keyword">into</span> T <span class="org-keyword">values</span> (7, 6, 5);
<span class="org-keyword">insert</span> <span class="org-keyword">into</span> T <span class="org-keyword">values</span> (8, 7, 6);
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">delete</span> <span class="org-keyword">from</span> T <span class="org-keyword">where</span> A = 1;
</pre>
</div>

<p>
The above query will delete all the rows in T.<br />
</p>
</div>
</div>

<div id="outline-container-org5bdb333" class="outline-4">
<h4 id="org5bdb333"><span class="section-number-4">7.1.4</span> <span class="done DONE">DONE</span> Triggers Introduction</h4>
<div class="outline-text-4" id="text-7-1-4">
<p>
Triggers<br />
</p>
<ul class="org-ul">
<li>"Event-Condition-Action Rules"<br /></li>
<li>When <i>event</i> occurs, check condition; if true, do action<br />
<ol class="org-ol">
<li>Move monitoring logic from apps into DBMS<br /></li>
<li>Enforce constraints<br />
<ul class="org-ul">
<li>Beyond what constraint system supports<br /></li>
<li>Automatic constraint "repair"<br /></li>
</ul></li>
</ol></li>
</ul>

<p>
<b>Implementations vary significantly</b><br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">Create</span> <span class="org-keyword">Trigger</span> <span class="org-keyword">name</span>
<span class="org-keyword">Before</span> | <span class="org-keyword">After</span> | Instead <span class="org-keyword">Of</span> events
[ <span class="org-keyword">referencing</span>-variables ]
[ <span class="org-keyword">For</span> <span class="org-keyword">Each</span> <span class="org-type">Row</span> ]
<span class="org-keyword">When</span> (condition)
<span class="org-keyword">action</span>
</pre>
</div>

<p>
Events are one of <code>insert on T</code>, <code>delete on T</code>, <code>update [of C1, ..., Cn] on T</code>.<br />
</p>

<p>
<code>[For Each Row]</code> means that the triggers should be executed once for<br />
each modified tuple.<br />
</p>

<p>
When event is an insert, <code>referencing-variables</code> can only reference<br />
the newly inserted data.  When event is a delete, <code>referencing-variables</code><br />
can only reference the old deleted data.  When envent is an update,<br />
<code>referencing-variables</code> can reference both old and new data.<br />
</p>

<p>
If a row-level trigger is concerned and the event is a delete, we can<br />
refer both the old row and old table as different variables.  Old<br />
table does not refer to the old state of the table in the database but<br />
specifically refers to the rows deleted in the delete event.<br />
</p>

<p>
If a statement-level trigger is concerned, only table can be referenced.<br />
</p>

<p>
<code>(Condition)</code> is like SQL <code>where</code> clause.<br />
</p>

<p>
<code>action</code> is the action to be performed when triggered.  This is where<br />
various database systems differ.<br />
</p>

<p>
Referential Integrity:<br />
</p>
<ul class="org-ul">
<li>R.A references S.B, cascaded delete<br /></li>
</ul>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">Create</span> <span class="org-keyword">Trigger</span> <span class="org-keyword">Cascade</span>
<span class="org-keyword">After</span> <span class="org-keyword">Delete</span> <span class="org-keyword">On</span> S
<span class="org-keyword">Referencing</span> <span class="org-keyword">Old</span> <span class="org-type">Row</span> <span class="org-keyword">As</span> O
<span class="org-keyword">For</span> <span class="org-keyword">Each</span> <span class="org-type">Row</span>
<span class="org-comment">-- [ no condition ]</span>
<span class="org-keyword">Delete</span> <span class="org-keyword">From</span> R <span class="org-keyword">Where</span> A = O.B
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">Create</span> <span class="org-keyword">Trigger</span> <span class="org-keyword">Cascade</span>
<span class="org-keyword">After</span> <span class="org-keyword">Delete</span> <span class="org-keyword">On</span> S
<span class="org-keyword">Referencing</span> <span class="org-keyword">Old</span> <span class="org-keyword">Table</span> <span class="org-keyword">As</span> OT
<span class="org-comment">-- [ For Each Row ]</span>
<span class="org-comment">-- [ no condition ]</span>
<span class="org-keyword">Delete</span> <span class="org-keyword">From</span> R <span class="org-keyword">Where</span> A <span class="org-keyword">in</span> (<span class="org-keyword">Select</span> B <span class="org-keyword">from</span> OT)
</pre>
</div>


<p>
Tricky Issues<br />
</p>

<ul class="org-ul">
<li>Row-level vs. Statement-level<br />
<ul class="org-ul">
<li>New/Old Row and New/Old Table<br /></li>
<li>Before, Instead Of<br /></li>
</ul></li>

<li>Multiple triggers activated at same time<br /></li>

<li>Trigger actions activating other triggers (chaining)<br />
<ul class="org-ul">
<li>Also self-triggering, cycles, nested invocations<br /></li>
</ul></li>

<li>Conditions in <code>When</code> vs. as part of <code>action</code><br /></li>
</ul>


<p>
SQLite supports only row-level triggers.<br />
</p>

<p>
T(K,V) - K key, V value<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">Create</span> <span class="org-keyword">Trigger</span> <span class="org-function-name">IncreaseInserts</span>
<span class="org-keyword">After</span> <span class="org-keyword">Insert</span> <span class="org-keyword">On</span> T
<span class="org-keyword">Referencing</span> <span class="org-keyword">New</span> <span class="org-type">Row</span> <span class="org-keyword">As</span> NR, <span class="org-keyword">New</span> <span class="org-keyword">Table</span> <span class="org-keyword">As</span> NT
<span class="org-keyword">For</span> <span class="org-keyword">Each</span> <span class="org-type">Row</span>
<span class="org-keyword">When</span> (<span class="org-keyword">Select</span> <span class="org-builtin">Avg</span>(V) <span class="org-keyword">From</span> T) &lt;
     (<span class="org-keyword">Select</span> <span class="org-builtin">Avg</span>(V) <span class="org-keyword">From</span> NT)
<span class="org-keyword">Update</span> T <span class="org-keyword">set</span> V=V+10 <span class="org-keyword">where</span> K=NR.K
</pre>
</div>

<ul class="org-ul">
<li>No statement-level equivalent<br /></li>
<li>Nondeterministic final state<br /></li>
</ul>
</div>
</div>

<div id="outline-container-orgabf08b4" class="outline-4">
<h4 id="orgabf08b4"><span class="section-number-4">7.1.5</span> <span class="done DONE">DONE</span> Triggers Demo</h4>
<div class="outline-text-4" id="text-7-1-5">
<ul class="org-ul">
<li>Before and After; Insert, Delete, and Update<br /></li>
<li>New and Old<br /></li>
<li>Conditions and actions<br /></li>
<li>Triggers enforcing constraints<br /></li>
<li>Trigger chaining<br /></li>
<li>Self-triggering, cycles<br /></li>
<li>Conflicts<br /></li>
<li>Nested trigger invocations<br /></li>
</ul>

<p>
Introduction video used SQL standard<br />
</p>
<ul class="org-ul">
<li>No DBMS implements exact standard<br /></li>
<li>Some deviate considerably<br />
<ul class="org-ul">
<li>In both syntax and behavior!<br /></li>
</ul></li>
</ul>

<p>
Postgres &gt; SQLite &gt;&gt; MySQL<br />
</p>

<p>
Postgres<br />
</p>
<ul class="org-ul">
<li>Expressiveness/behavior = full standard<br />
row-level + statement-level, old/new row &amp; table<br /></li>
<li>Cumbersome &amp; awkward syntax<br /></li>
</ul>

<p>
SQLite<br />
</p>
<ul class="org-ul">
<li>Row-level only, immediate activation =&gt; no old/new table<br /></li>
</ul>

<p>
MySQL<br />
</p>
<ul class="org-ul">
<li>Row-level only, immediate activation =&gt; no old/new table<br /></li>
<li>Only one trigger per event type<br /></li>
<li>Limited trigger chaining<br /></li>
</ul>


<p>
SQLite - row-level triggers, immediate activation<br />
</p>
<ul class="org-ul">
<li><code>For Each Row</code> implicit if not specified<br /></li>
<li>No <code>Old Table</code> or <code>New Table</code><br /></li>
<li>No <code>Referencing</code> clause<br />
<ul class="org-ul">
<li><code>Old</code> and <code>New</code> predefined for <code>Old Row</code> and <code>New Row</code><br /></li>
</ul></li>
<li>Trigger action: SQL statements in <code>begin-end</code> block<br /></li>
</ul>


<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">trigger</span> <span class="org-function-name">R1</span>
<span class="org-keyword">after</span> <span class="org-keyword">insert</span> <span class="org-keyword">on</span> Student
<span class="org-keyword">for</span> <span class="org-keyword">each</span> <span class="org-type">row</span>
<span class="org-keyword">when</span> <span class="org-keyword">New</span>.GPA &gt; 3.3 <span class="org-keyword">and</span> <span class="org-keyword">New</span>.GPA &lt;= 3.6
<span class="org-keyword">begin</span>
    <span class="org-keyword">insert</span> <span class="org-keyword">into</span> Apply <span class="org-keyword">values</span> (<span class="org-keyword">New</span>.sID, <span class="org-string">'Stanford'</span>, <span class="org-string">'geology'</span>, <span class="org-keyword">null</span>);
    <span class="org-keyword">insert</span> <span class="org-keyword">into</span> Apply <span class="org-keyword">values</span> (<span class="org-keyword">New</span>.sID, <span class="org-string">'MIT'</span>, <span class="org-string">'biology'</span>, <span class="org-keyword">null</span>);
<span class="org-keyword">end</span>;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">trigger</span> <span class="org-function-name">R2</span>
<span class="org-keyword">after</span> <span class="org-keyword">delete</span> <span class="org-keyword">on</span> Student
<span class="org-keyword">for</span> <span class="org-keyword">each</span> <span class="org-type">row</span>
<span class="org-keyword">begin</span>
    <span class="org-keyword">delete</span> <span class="org-keyword">from</span> Apply <span class="org-keyword">where</span> sID = <span class="org-keyword">Old</span>.sID;
<span class="org-keyword">end</span>;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">trigger</span> <span class="org-function-name">R3</span>
<span class="org-keyword">after</span> <span class="org-keyword">update</span> <span class="org-keyword">of</span> cName <span class="org-keyword">on</span> College
<span class="org-keyword">for</span> <span class="org-keyword">each</span> <span class="org-type">row</span>
<span class="org-keyword">begin</span>
    <span class="org-keyword">update</span> Apply
    <span class="org-keyword">set</span> cName = <span class="org-keyword">New</span>.cName
    <span class="org-keyword">where</span> cName = <span class="org-keyword">Old</span>.cName;
<span class="org-keyword">end</span>;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">trigger</span> <span class="org-function-name">R4</span>
<span class="org-keyword">before</span> <span class="org-keyword">insert</span> <span class="org-keyword">on</span> College
<span class="org-keyword">for</span> <span class="org-keyword">each</span> <span class="org-type">row</span>
<span class="org-keyword">when</span> <span class="org-keyword">exists</span> (<span class="org-keyword">select</span> * <span class="org-keyword">from</span> College <span class="org-keyword">where</span> cName = <span class="org-keyword">New</span>.cName)
<span class="org-keyword">begin</span>
    <span class="org-keyword">select</span> raise(<span class="org-keyword">ignore</span>);
<span class="org-keyword">end</span>;

<span class="org-keyword">create</span> <span class="org-keyword">trigger</span> <span class="org-function-name">R5</span>
<span class="org-keyword">before</span> <span class="org-keyword">update</span> <span class="org-keyword">of</span> cName <span class="org-keyword">on</span> College
<span class="org-keyword">for</span> <span class="org-keyword">each</span> <span class="org-type">row</span>
<span class="org-keyword">when</span> <span class="org-keyword">exists</span> (<span class="org-keyword">select</span> * <span class="org-keyword">from</span> College <span class="org-keyword">where</span> cName = <span class="org-keyword">New</span>.cName)
<span class="org-keyword">begin</span>
    <span class="org-keyword">select</span> raise(<span class="org-keyword">ignore</span>);
<span class="org-keyword">end</span>;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">trigger</span> <span class="org-function-name">R6</span>
<span class="org-keyword">after</span> <span class="org-keyword">insert</span> <span class="org-keyword">on</span> Apply
<span class="org-keyword">for</span> <span class="org-keyword">each</span> <span class="org-type">row</span>
<span class="org-keyword">when</span> (<span class="org-keyword">select</span> <span class="org-builtin">count</span>(*) <span class="org-keyword">from</span> Apply <span class="org-keyword">where</span> cName = <span class="org-keyword">New</span>.cName) &gt; 10
<span class="org-keyword">begin</span>
    <span class="org-keyword">update</span> College <span class="org-keyword">set</span> cName = cName || <span class="org-string">'-Done'</span>
    <span class="org-keyword">where</span> cName = <span class="org-keyword">New</span>.cName;
<span class="org-keyword">end</span>;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">trigger</span> <span class="org-function-name">R7</span>
<span class="org-keyword">before</span> <span class="org-keyword">insert</span> <span class="org-keyword">on</span> Student
<span class="org-keyword">for</span> <span class="org-keyword">each</span> <span class="org-type">row</span>
<span class="org-keyword">when</span> <span class="org-keyword">New</span>.sizeHS &lt; 100 <span class="org-keyword">or</span> <span class="org-keyword">New</span>.sizeHS &gt; 5000
<span class="org-keyword">begin</span>
    <span class="org-keyword">select</span> raise(<span class="org-keyword">ignore</span>);
<span class="org-keyword">end</span>;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">trigger</span> <span class="org-function-name">R7</span>               <span class="org-comment">-- alternative version using after</span>
<span class="org-keyword">after</span> <span class="org-keyword">insert</span> <span class="org-keyword">on</span> Student
<span class="org-keyword">for</span> <span class="org-keyword">each</span> <span class="org-type">row</span>
<span class="org-keyword">when</span> <span class="org-keyword">New</span>.sizeHS &lt; 100 <span class="org-keyword">or</span> <span class="org-keyword">New</span>.sizeHS &gt; 5000
<span class="org-keyword">begin</span>
    <span class="org-keyword">delete</span> <span class="org-keyword">from</span> Student <span class="org-keyword">where</span> sID = <span class="org-keyword">New</span>.sID;
<span class="org-keyword">end</span>;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">trigger</span> <span class="org-function-name">AutoAccept</span>
<span class="org-keyword">after</span> <span class="org-keyword">insert</span> <span class="org-keyword">on</span> Apply
<span class="org-keyword">for</span> <span class="org-keyword">each</span> <span class="org-type">row</span>
<span class="org-keyword">when</span> (<span class="org-keyword">New</span>.cName = <span class="org-string">'Berkeley'</span> <span class="org-keyword">and</span>
      3.7 &lt; (<span class="org-keyword">select</span> GPA <span class="org-keyword">from</span> Student <span class="org-keyword">where</span> sID = <span class="org-keyword">New</span>.sID) <span class="org-keyword">and</span>
      1200 &lt; (<span class="org-keyword">select</span> sizeHS <span class="org-keyword">from</span> Student <span class="org-keyword">where</span> sID = <span class="org-keyword">New</span>.sID))
<span class="org-keyword">begin</span>
    <span class="org-keyword">update</span> Apply
    <span class="org-keyword">set</span> decision = <span class="org-string">'Y'</span>
    <span class="org-keyword">where</span> sID = <span class="org-keyword">New</span>.sID
          <span class="org-keyword">and</span> cName = <span class="org-keyword">New</span>.cName;
<span class="org-keyword">end</span>;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">trigger</span> <span class="org-function-name">TooMany</span>
<span class="org-keyword">after</span> <span class="org-keyword">update</span> <span class="org-keyword">of</span> enrollment <span class="org-keyword">on</span> College
<span class="org-keyword">for</span> <span class="org-keyword">each</span> <span class="org-type">row</span>
<span class="org-keyword">when</span> (<span class="org-keyword">Old</span>.enrollment &lt;= 16000 <span class="org-keyword">and</span> <span class="org-keyword">New</span>.enrollment &gt; 16000)
<span class="org-keyword">begin</span>
    <span class="org-keyword">delete</span> <span class="org-keyword">from</span> Apply
        <span class="org-keyword">where</span> cName = <span class="org-keyword">New</span>.cName <span class="org-keyword">and</span> major = <span class="org-string">'EE'</span>;
    <span class="org-keyword">update</span> Apply
        <span class="org-keyword">set</span> decision = <span class="org-string">'U'</span>
        <span class="org-keyword">where</span> cName = <span class="org-keyword">New</span>.cName
              <span class="org-keyword">and</span> decision = <span class="org-string">'Y'</span>;
<span class="org-keyword">end</span>;
</pre>
</div>


<p>
self-triggering<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">trigger</span> <span class="org-function-name">R1</span>
<span class="org-keyword">after</span> <span class="org-keyword">insert</span> <span class="org-keyword">on</span> T1
<span class="org-keyword">for</span> <span class="org-keyword">each</span> <span class="org-type">row</span>
<span class="org-keyword">begin</span>
    <span class="org-keyword">insert</span> <span class="org-keyword">into</span> T1 <span class="org-keyword">values</span> (<span class="org-keyword">New</span>.A+1);
<span class="org-keyword">end</span>;
</pre>
</div>

<p>
The above query won't enter infinite loop since SQLite disallow a<br />
trigger to be triggered more than once in a trigger processing<br />
session.  But if we like, we can turn on <code>recursive_triggers</code> on.<br />
</p>

<div class="org-src-container">
<pre class="src src-sql">pragma recursive_triggers = <span class="org-keyword">on</span>;
<span class="org-keyword">create</span> <span class="org-keyword">trigger</span> <span class="org-function-name">R1</span>
<span class="org-keyword">after</span> <span class="org-keyword">insert</span> <span class="org-keyword">on</span> T1
<span class="org-keyword">for</span> <span class="org-keyword">each</span> <span class="org-type">row</span>
<span class="org-keyword">when</span> (<span class="org-keyword">select</span> <span class="org-builtin">count</span>(*) <span class="org-keyword">from</span> T1) &lt; 10
<span class="org-keyword">begin</span>
    <span class="org-keyword">insert</span> <span class="org-keyword">into</span> T1 <span class="org-keyword">values</span> (<span class="org-keyword">New</span>.A+1);
<span class="org-keyword">end</span>;
</pre>
</div>

<p>
trigger each other in a cycle<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">trigger</span> <span class="org-function-name">R1</span>
<span class="org-keyword">after</span> <span class="org-keyword">insert</span> <span class="org-keyword">on</span> T1
<span class="org-keyword">for</span> <span class="org-keyword">each</span> <span class="org-type">row</span>
<span class="org-keyword">begin</span>
    <span class="org-keyword">insert</span> <span class="org-keyword">into</span> T2 <span class="org-keyword">values</span> (<span class="org-keyword">New</span>.A+1);
<span class="org-keyword">end</span>;

<span class="org-keyword">create</span> <span class="org-keyword">trigger</span> <span class="org-function-name">R2</span>
<span class="org-keyword">after</span> <span class="org-keyword">insert</span> <span class="org-keyword">on</span> T2
<span class="org-keyword">for</span> <span class="org-keyword">each</span> <span class="org-type">row</span>
<span class="org-keyword">begin</span>
    <span class="org-keyword">insert</span> <span class="org-keyword">into</span> T3 <span class="org-keyword">values</span> (<span class="org-keyword">New</span>.A+1);
<span class="org-keyword">end</span>;

<span class="org-keyword">create</span> <span class="org-keyword">trigger</span> <span class="org-function-name">R3</span>
<span class="org-keyword">after</span> <span class="org-keyword">insert</span> <span class="org-keyword">on</span> T3
<span class="org-keyword">for</span> <span class="org-keyword">each</span> <span class="org-type">row</span>
<span class="org-keyword">begin</span>
    <span class="org-keyword">insert</span> <span class="org-keyword">into</span> T1 <span class="org-keyword">values</span> (<span class="org-keyword">New</span>.A+1);
<span class="org-keyword">end</span>;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql">pragma recursive_triggers = <span class="org-keyword">on</span>;
<span class="org-keyword">create</span> <span class="org-keyword">trigger</span> <span class="org-function-name">R3</span>
<span class="org-keyword">after</span> <span class="org-keyword">insert</span> <span class="org-keyword">on</span> T3
<span class="org-keyword">for</span> <span class="org-keyword">each</span> <span class="org-type">row</span>
<span class="org-keyword">when</span> (<span class="org-keyword">select</span> <span class="org-builtin">count</span>(*) <span class="org-keyword">from</span> T1) &lt; 100
<span class="org-keyword">begin</span>
    <span class="org-keyword">insert</span> <span class="org-keyword">into</span> T1 <span class="org-keyword">values</span> (<span class="org-keyword">New</span>.A+1);
<span class="org-keyword">end</span>;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">trigger</span> <span class="org-function-name">R1</span>
<span class="org-keyword">after</span> <span class="org-keyword">insert</span> <span class="org-keyword">on</span> T1
<span class="org-keyword">for</span> <span class="org-keyword">each</span> <span class="org-type">row</span>
<span class="org-keyword">begin</span>
    <span class="org-keyword">update</span> T1 <span class="org-keyword">set</span> A = 2;
<span class="org-keyword">end</span>;

<span class="org-keyword">create</span> <span class="org-keyword">trigger</span> <span class="org-function-name">R2</span>
<span class="org-keyword">after</span> <span class="org-keyword">insert</span> <span class="org-keyword">on</span> T1
<span class="org-keyword">for</span> <span class="org-keyword">each</span> <span class="org-type">row</span>
<span class="org-keyword">when</span> <span class="org-keyword">exists</span> (<span class="org-keyword">select</span> * <span class="org-keyword">from</span> T1 <span class="org-keyword">where</span> A = 2)
<span class="org-keyword">begin</span>
    <span class="org-keyword">update</span> T1 <span class="org-keyword">set</span> A = 3;
<span class="org-keyword">end</span>;
</pre>
</div>

<p>
The second trigger is executed first in SQLite.<br />
</p>


<p>
nested trigger invocation<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">trigger</span> <span class="org-function-name">R1</span>
<span class="org-keyword">after</span> <span class="org-keyword">insert</span> <span class="org-keyword">on</span> T1
<span class="org-keyword">for</span> <span class="org-keyword">each</span> <span class="org-type">row</span>
<span class="org-keyword">begin</span>
    <span class="org-keyword">insert</span> <span class="org-keyword">into</span> T2 <span class="org-keyword">values</span> (1);
    <span class="org-keyword">insert</span> <span class="org-keyword">into</span> T3 <span class="org-keyword">values</span> (1);
<span class="org-keyword">end</span>;

<span class="org-keyword">create</span> <span class="org-keyword">trigger</span> <span class="org-function-name">R2</span>
<span class="org-keyword">after</span> <span class="org-keyword">insert</span> <span class="org-keyword">on</span> T2
<span class="org-keyword">for</span> <span class="org-keyword">each</span> <span class="org-type">row</span>
<span class="org-keyword">begin</span>
    <span class="org-keyword">insert</span> <span class="org-keyword">into</span> T3 <span class="org-keyword">values</span> (2);
    <span class="org-keyword">insert</span> <span class="org-keyword">into</span> T4 <span class="org-keyword">values</span> (2);
<span class="org-keyword">end</span>;

<span class="org-keyword">create</span> <span class="org-keyword">trigger</span> <span class="org-function-name">R3</span>
<span class="org-keyword">after</span> <span class="org-keyword">insert</span> <span class="org-keyword">on</span> T3
<span class="org-keyword">for</span> <span class="org-keyword">each</span> <span class="org-type">row</span>
<span class="org-keyword">begin</span>
    <span class="org-keyword">insert</span> <span class="org-keyword">into</span> T4 <span class="org-keyword">values</span> (3);
<span class="org-keyword">end</span>;
</pre>
</div>

<p>
immediate activation semantics of SQLite for triggers<br />
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">trigger</span> <span class="org-function-name">R1</span>
<span class="org-keyword">after</span> <span class="org-keyword">insert</span> <span class="org-keyword">on</span> T1
<span class="org-keyword">for</span> <span class="org-keyword">each</span> <span class="org-type">row</span>
<span class="org-keyword">begin</span>
    <span class="org-keyword">insert</span> <span class="org-keyword">into</span> T2 <span class="org-keyword">select</span> <span class="org-builtin">avg</span>(A) <span class="org-keyword">from</span> T1;
<span class="org-keyword">end</span>;
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org6d894d3" class="outline-3">
<h3 id="org6d894d3"><span class="section-number-3">7.2</span> <span class="done DONE">DONE</span> Exercises</h3>
<div class="outline-text-3" id="text-7-2">
</div>
<div id="outline-container-orgd8f1633" class="outline-4">
<h4 id="orgd8f1633"><span class="section-number-4">7.2.1</span> <span class="done DONE">DONE</span> Constraints and Triggers</h4>
<div class="outline-text-4" id="text-7-2-1">
</div>
</div>
<div id="outline-container-org2e0422b" class="outline-4">
<h4 id="org2e0422b"><span class="section-number-4">7.2.2</span> <span class="done DONE">DONE</span> SQL Social-Network Triggers</h4>
<div class="outline-text-4" id="text-7-2-2">
<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">trigger</span> <span class="org-function-name">FriendSameGrade</span>
<span class="org-keyword">after</span> <span class="org-keyword">insert</span> <span class="org-keyword">on</span> Highschooler
<span class="org-keyword">for</span> <span class="org-keyword">each</span> <span class="org-type">row</span>
<span class="org-keyword">when</span> <span class="org-keyword">New</span>.<span class="org-keyword">name</span> = <span class="org-string">'Friendly'</span>
<span class="org-keyword">begin</span>
  <span class="org-keyword">insert</span> <span class="org-keyword">into</span> Likes
  <span class="org-keyword">select</span> <span class="org-keyword">New</span>.ID, ID
  <span class="org-keyword">from</span> Highschooler
  <span class="org-keyword">where</span> grade = <span class="org-keyword">New</span>.grade <span class="org-keyword">and</span> ID &lt;&gt; <span class="org-keyword">New</span>.ID;
<span class="org-keyword">end</span>;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">trigger</span> <span class="org-function-name">ManageGrade1</span>
<span class="org-keyword">after</span> <span class="org-keyword">insert</span> <span class="org-keyword">on</span> Highschooler
<span class="org-keyword">for</span> <span class="org-keyword">each</span> <span class="org-type">row</span>
<span class="org-keyword">when</span> <span class="org-keyword">New</span>.grade &lt; 9 <span class="org-keyword">or</span> <span class="org-keyword">New</span>.grade &gt; 12
<span class="org-keyword">begin</span>
  <span class="org-keyword">update</span> Highschooler
  <span class="org-keyword">set</span> grade = <span class="org-keyword">null</span>
  <span class="org-keyword">where</span> ID = <span class="org-keyword">New</span>.ID;
<span class="org-keyword">end</span>;
|
<span class="org-keyword">create</span> <span class="org-keyword">trigger</span> <span class="org-function-name">ManageGrade2</span>
<span class="org-keyword">after</span> <span class="org-keyword">insert</span> <span class="org-keyword">on</span> Highschooler
<span class="org-keyword">for</span> <span class="org-keyword">each</span> <span class="org-type">row</span>
<span class="org-keyword">when</span> <span class="org-keyword">New</span>.grade <span class="org-keyword">is</span> <span class="org-keyword">null</span>
<span class="org-keyword">begin</span>
  <span class="org-keyword">update</span> Highschooler
  <span class="org-keyword">set</span> grade = 9
  <span class="org-keyword">where</span> ID = <span class="org-keyword">New</span>.ID;
<span class="org-keyword">end</span>;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">trigger</span> <span class="org-function-name">SymmetricFriend1</span>
<span class="org-keyword">after</span> <span class="org-keyword">delete</span> <span class="org-keyword">on</span> Friend
<span class="org-keyword">for</span> <span class="org-keyword">each</span> <span class="org-type">row</span>
<span class="org-keyword">begin</span>
  <span class="org-keyword">delete</span> <span class="org-keyword">from</span> Friend
  <span class="org-keyword">where</span> ID1 = <span class="org-keyword">Old</span>.ID2 <span class="org-keyword">and</span> ID2 = <span class="org-keyword">Old</span>.ID1;
<span class="org-keyword">end</span>;
|
<span class="org-keyword">create</span> <span class="org-keyword">trigger</span> <span class="org-function-name">SymmetricFriend2</span>
<span class="org-keyword">after</span> <span class="org-keyword">insert</span> <span class="org-keyword">on</span> Friend
<span class="org-keyword">for</span> <span class="org-keyword">each</span> <span class="org-type">row</span>
<span class="org-keyword">begin</span>
  <span class="org-keyword">insert</span> <span class="org-keyword">or</span> <span class="org-keyword">ignore</span> <span class="org-keyword">into</span> Friend
  <span class="org-keyword">values</span> (<span class="org-keyword">New</span>.ID2, <span class="org-keyword">New</span>.ID1);
<span class="org-keyword">end</span>;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">trigger</span> <span class="org-function-name">Graduate</span>
<span class="org-keyword">after</span> <span class="org-keyword">update</span> <span class="org-keyword">on</span> Highschooler
<span class="org-keyword">for</span> <span class="org-keyword">each</span> <span class="org-type">row</span>
<span class="org-keyword">when</span> <span class="org-keyword">New</span>.grade &gt; 12
<span class="org-keyword">begin</span>
  <span class="org-keyword">delete</span> <span class="org-keyword">from</span> Highschooler
  <span class="org-keyword">where</span> ID = <span class="org-keyword">New</span>.ID;
<span class="org-keyword">end</span>;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">trigger</span> <span class="org-function-name">Graduate</span>
<span class="org-keyword">after</span> <span class="org-keyword">update</span> <span class="org-keyword">on</span> Highschooler
<span class="org-keyword">for</span> <span class="org-keyword">each</span> <span class="org-type">row</span>
<span class="org-keyword">when</span> <span class="org-keyword">New</span>.grade &gt; 12
<span class="org-keyword">begin</span>
  <span class="org-keyword">delete</span> <span class="org-keyword">from</span> Highschooler
  <span class="org-keyword">where</span> ID = <span class="org-keyword">New</span>.ID;
<span class="org-keyword">end</span>;
|
<span class="org-keyword">create</span> <span class="org-keyword">trigger</span> <span class="org-function-name">GoUpOneGrade</span>
<span class="org-keyword">before</span> <span class="org-keyword">update</span> <span class="org-keyword">on</span> Highschooler
<span class="org-keyword">for</span> <span class="org-keyword">each</span> <span class="org-type">row</span>
<span class="org-keyword">when</span> <span class="org-keyword">Old</span>.grade + 1 = <span class="org-keyword">New</span>.grade
<span class="org-keyword">begin</span>
  <span class="org-keyword">update</span> Highschooler
  <span class="org-keyword">set</span> grade = grade + 1
  <span class="org-keyword">where</span> ID <span class="org-keyword">in</span> (<span class="org-keyword">select</span> ID2 <span class="org-keyword">from</span> Friend
               <span class="org-keyword">where</span> ID1 = <span class="org-keyword">Old</span>.ID);
<span class="org-keyword">end</span>;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">trigger</span> <span class="org-function-name">Unfriend</span>
<span class="org-keyword">after</span> <span class="org-keyword">update</span> <span class="org-keyword">on</span> Likes
<span class="org-keyword">for</span> <span class="org-keyword">each</span> <span class="org-type">row</span>
<span class="org-keyword">when</span> <span class="org-keyword">Old</span>.ID1 = <span class="org-keyword">New</span>.ID1 <span class="org-keyword">and</span> <span class="org-keyword">Old</span>.ID2 &lt;&gt; <span class="org-keyword">New</span>.ID2
     <span class="org-keyword">and</span> <span class="org-keyword">exists</span> (<span class="org-keyword">select</span> * <span class="org-keyword">from</span> Friend
                 <span class="org-keyword">where</span> ID1 = <span class="org-keyword">Old</span>.ID2 <span class="org-keyword">and</span> ID2 = <span class="org-keyword">New</span>.ID2)
<span class="org-keyword">begin</span>
  <span class="org-keyword">delete</span> <span class="org-keyword">from</span> Friend
  <span class="org-keyword">where</span> ((ID1 = <span class="org-keyword">Old</span>.ID2 <span class="org-keyword">and</span> ID2 = <span class="org-keyword">New</span>.ID2)
         <span class="org-keyword">or</span> (ID1 = <span class="org-keyword">New</span>.ID2 <span class="org-keyword">and</span> ID2 = <span class="org-keyword">Old</span>.ID2));
<span class="org-keyword">end</span>;
</pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: Lei Zhao</p>
<p class="date">Created: 2017-12-24 Sun 21:15</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
